---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Checkout Profesional
 * Proceso de compra en 3 pasos: Envío → Pago → Confirmación
 * ═══════════════════════════════════════════════════════════════════════════
 */

export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase, isSupabaseConfigured } from '../lib/supabase/client';

// Verificar sesión del usuario
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let user: any = null;
let profile: any = null;
let userAddresses: any[] = [];
let userPaymentMethods: any[] = [];

if (accessToken && refreshToken && isSupabaseConfigured() && supabase) {
  const { data: { user: authUser } } = await supabase.auth.getUser(accessToken);
  if (authUser) {
    user = authUser;
    const { data: profileData } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', authUser.id)
      .single();
    profile = profileData;
    
    // Obtener direcciones guardadas del usuario
    const { data: addressesData } = await supabase
      .from('addresses')
      .select('*')
      .eq('user_id', authUser.id)
      .order('is_default', { ascending: false })
      .order('created_at', { ascending: false });
    userAddresses = addressesData || [];
    
    // Obtener métodos de pago guardados del usuario
    const { data: paymentMethodsData } = await supabase
      .from('payment_methods')
      .select('*')
      .eq('user_id', authUser.id)
      .order('is_default', { ascending: false })
      .order('created_at', { ascending: false });
    userPaymentMethods = paymentMethodsData || [];
  }
}

// Obtener métodos de envío
let shippingMethods: any[] = [];
if (isSupabaseConfigured() && supabase) {
  const { data } = await supabase
    .from('shipping_methods')
    .select('*')
    .eq('active', true)
    .order('base_cost', { ascending: true });
  shippingMethods = data || [];
}

// Si no hay métodos de envío, usar valores por defecto
if (shippingMethods.length === 0) {
  shippingMethods = [
    { id: 'standard', name: 'Envío Estándar', description: '3-5 días laborables', base_cost: 499, free_threshold: 10000 },
    { id: 'express', name: 'Envío Express', description: '24-48 horas', base_cost: 999, free_threshold: null },
  ];
}

// Stripe public key
const stripePublicKey = import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY || '';
---

<BaseLayout title="Checkout | FashionMarket" description="Finaliza tu compra de forma segura" noHeaderFooter={true}>
  <!-- Header simplificado para checkout -->
  <header class="bg-white border-b border-charcoal-100 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <!-- Logo -->
        <a href="/" class="flex items-center gap-2">
          <span class="text-xl font-serif font-semibold text-navy-900">Fashion<span class="text-gold-matte">Market</span></span>
        </a>
        
        <!-- Pasos del checkout -->
        <nav class="hidden sm:flex items-center gap-2 text-sm" id="checkout-steps">
          <div class="step-indicator active" data-step="1">
            <span class="step-number">1</span>
            <span class="step-label">Envío</span>
          </div>
          <div class="step-divider"></div>
          <div class="step-indicator" data-step="2">
            <span class="step-number">2</span>
            <span class="step-label">Pago</span>
          </div>
          <div class="step-divider"></div>
          <div class="step-indicator" data-step="3">
            <span class="step-number">3</span>
            <span class="step-label">Confirmación</span>
          </div>
        </nav>
        
        <!-- Seguridad -->
        <div class="flex items-center gap-2 text-charcoal-500 text-sm">
          <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
          </svg>
          <span class="hidden sm:inline">Pago Seguro</span>
        </div>
      </div>
    </div>
  </header>

  <main class="min-h-screen bg-ivory py-8 lg:py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      
      <!-- Carrito vacío -->
      <div id="empty-cart" class="hidden text-center py-20">
        <svg class="w-24 h-24 mx-auto text-charcoal-200 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
        </svg>
        <h2 class="font-serif text-2xl text-navy-900 mb-2">Tu carrito está vacío</h2>
        <p class="text-charcoal-500 mb-6">Añade productos para continuar con la compra</p>
        <a href="/tienda" class="inline-flex items-center gap-2 px-6 py-3 bg-navy-900 text-white font-medium hover:bg-navy-800 transition-colors">
          Explorar tienda
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
          </svg>
        </a>
      </div>

      <!-- Checkout principal -->
      <div id="checkout-main" class="grid lg:grid-cols-5 gap-8">
        
        <!-- Formulario (3 columnas) -->
        <div class="lg:col-span-3 space-y-6">
          
          <!-- ═══════════════════════════════════════════════════════════════
               PASO 1: DATOS DE ENVÍO
               ═══════════════════════════════════════════════════════════════ -->
          <section id="step-shipping" class="checkout-step" data-step="1">
            <div class="bg-white rounded-lg shadow-subtle overflow-hidden">
              <div class="bg-navy-900 px-6 py-4">
                <h2 class="text-white font-serif text-lg flex items-center gap-3">
                  <span class="w-7 h-7 rounded-full bg-white/20 flex items-center justify-center text-sm font-medium">1</span>
                  <span class="text-white">Datos de Envío</span>
                </h2>
              </div>
              
              <form id="shipping-form" class="p-6 space-y-5">
                <!-- Selector de direcciones guardadas (solo si hay usuario y direcciones) -->
                {user && userAddresses.length > 0 && (
                  <div class="mb-6">
                    <label class="block text-sm font-medium text-charcoal-700 mb-3">
                      <span class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-navy-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Usar una dirección guardada
                      </span>
                    </label>
                    <div class="space-y-2" id="saved-addresses">
                      {userAddresses.map((addr, index) => (
                        <label class="saved-address-card flex items-start gap-3 p-4 border border-charcoal-200 rounded-lg cursor-pointer hover:border-navy-900/30 transition-colors">
                          <input 
                            type="radio" 
                            name="savedAddress" 
                            value={addr.id}
                            data-fullname={addr.full_name}
                            data-phone={addr.phone}
                            data-address={addr.address_line1}
                            data-address2={addr.address_line2 || ''}
                            data-postalcode={addr.postal_code}
                            data-city={addr.city}
                            data-province={addr.province}
                            checked={index === 0}
                            class="mt-1 w-4 h-4 text-navy-900 border-charcoal-300 focus:ring-navy-900"
                          />
                          <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                              <span class="font-medium text-navy-900">{addr.label || 'Dirección'}</span>
                              {addr.is_default && (
                                <span class="px-2 py-0.5 bg-navy-100 text-navy-700 text-xs rounded-full">Principal</span>
                              )}
                            </div>
                            <p class="text-sm text-charcoal-600">{addr.full_name}</p>
                            <p class="text-sm text-charcoal-500">{addr.address_line1}</p>
                            <p class="text-sm text-charcoal-500">{addr.postal_code} {addr.city}, {addr.province}</p>
                          </div>
                        </label>
                      ))}
                      <label class="saved-address-card flex items-center gap-3 p-4 border border-dashed border-charcoal-300 rounded-lg cursor-pointer hover:border-navy-900/50 hover:bg-charcoal-50 transition-colors">
                        <input 
                          type="radio" 
                          name="savedAddress" 
                          value="new"
                          class="w-4 h-4 text-navy-900 border-charcoal-300 focus:ring-navy-900"
                        />
                        <div class="flex items-center gap-2 text-charcoal-600">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                          </svg>
                          <span class="font-medium">Usar otra dirección</span>
                        </div>
                      </label>
                    </div>
                  </div>
                )}

                <!-- Campo de Email (siempre visible) -->
                <div class="mb-4">
                  <label for="email" class="block text-sm font-medium text-charcoal-700 mb-1.5">Email *</label>
                  <input 
                    type="email" 
                    id="email" 
                    name="email"
                    required
                    value={user?.email || ''}
                    class="w-full px-4 py-2.5 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-navy-900/20 focus:border-navy-900 transition-colors"
                    placeholder="tu@email.com"
                  />
                </div>

                <!-- Formulario de dirección (siempre visible si no hay direcciones, o cuando seleccionan "nueva") -->
                <div id="manual-address-form" class={user && userAddresses.length > 0 ? 'hidden' : ''}>
                  <!-- Datos personales -->
                <div class="grid sm:grid-cols-2 gap-4">
                  <div>
                    <label for="firstName" class="block text-sm font-medium text-charcoal-700 mb-1.5">Nombre *</label>
                    <input 
                      type="text" 
                      id="firstName" 
                      name="firstName"
                      value={profile?.first_name || ''}
                      class="w-full px-4 py-2.5 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-navy-900/20 focus:border-navy-900 transition-colors"
                      placeholder="Tu nombre"
                    />
                  </div>
                  <div>
                    <label for="lastName" class="block text-sm font-medium text-charcoal-700 mb-1.5">Apellidos *</label>
                    <input 
                      type="text" 
                      id="lastName" 
                      name="lastName"
                      value={profile?.last_name || ''}
                      class="w-full px-4 py-2.5 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-navy-900/20 focus:border-navy-900 transition-colors"
                      placeholder="Tus apellidos"
                    />
                  </div>
                </div>

                <div class="mt-4">
                  <label for="phone" class="block text-sm font-medium text-charcoal-700 mb-1.5">Teléfono *</label>
                  <input 
                    type="tel" 
                    id="phone" 
                    name="phone"
                    value={profile?.phone || ''}
                    class="w-full px-4 py-2.5 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-navy-900/20 focus:border-navy-900 transition-colors"
                    placeholder="+34 600 000 000"
                  />
                </div>

                <!-- Dirección -->
                <div class="mt-4">
                  <label for="address" class="block text-sm font-medium text-charcoal-700 mb-1.5">Dirección *</label>
                  <input 
                    type="text" 
                    id="address" 
                    name="address"
                    class="w-full px-4 py-2.5 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-navy-900/20 focus:border-navy-900 transition-colors"
                    placeholder="Calle, número, piso, puerta"
                  />
                </div>

                <div class="grid grid-cols-3 gap-4 mt-4">
                  <div>
                    <label for="postalCode" class="block text-sm font-medium text-charcoal-700 mb-1.5">C.P. *</label>
                    <input 
                      type="text" 
                      id="postalCode" 
                      name="postalCode"
                      maxlength="5"
                      class="w-full px-4 py-2.5 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-navy-900/20 focus:border-navy-900 transition-colors"
                      placeholder="28001"
                    />
                  </div>
                  <div>
                    <label for="city" class="block text-sm font-medium text-charcoal-700 mb-1.5">Ciudad *</label>
                    <input 
                      type="text" 
                      id="city" 
                      name="city"
                      class="w-full px-4 py-2.5 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-navy-900/20 focus:border-navy-900 transition-colors"
                      placeholder="Madrid"
                    />
                  </div>
                  <div>
                    <label for="province" class="block text-sm font-medium text-charcoal-700 mb-1.5">Provincia *</label>
                    <input 
                      type="text" 
                      id="province" 
                      name="province"
                      class="w-full px-4 py-2.5 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-navy-900/20 focus:border-navy-900 transition-colors"
                      placeholder="Madrid"
                    />
                  </div>
                </div>
                </div> <!-- Cierre de manual-address-form -->

                <!-- Método de envío -->
                <div class="pt-4 border-t border-charcoal-100">
                  <label class="block text-sm font-medium text-charcoal-700 mb-3">Método de envío *</label>
                  <div class="space-y-3" id="shipping-methods">
                    {shippingMethods.map((method, index) => (
                      <label class="shipping-method-card flex items-center gap-4 p-4 border border-charcoal-200 rounded-lg cursor-pointer hover:border-navy-900/30 transition-colors">
                        <input 
                          type="radio" 
                          name="shippingMethod" 
                          value={method.id}
                          data-cost={method.base_cost}
                          data-free-threshold={method.free_threshold || 999999}
                          checked={index === 0}
                          class="w-4 h-4 text-navy-900 border-charcoal-300 focus:ring-navy-900"
                        />
                        <div class="flex-1">
                          <div class="flex items-center justify-between">
                            <span class="font-medium text-navy-900">{method.name}</span>
                            <span class="shipping-cost font-semibold text-navy-900" data-base={method.base_cost} data-threshold={method.free_threshold || 999999}>
                              {method.base_cost === 0 ? 'Gratis' : `${(method.base_cost / 100).toFixed(2).replace('.', ',')} €`}
                            </span>
                          </div>
                          <p class="text-sm text-charcoal-500">{method.description}</p>
                        </div>
                      </label>
                    ))}
                  </div>
                </div>

                <!-- Notas -->
                <div>
                  <label for="notes" class="block text-sm font-medium text-charcoal-700 mb-1.5">Notas del pedido (opcional)</label>
                  <textarea 
                    id="notes" 
                    name="notes"
                    rows="2"
                    class="w-full px-4 py-2.5 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-navy-900/20 focus:border-navy-900 transition-colors resize-none"
                    placeholder="Instrucciones especiales de entrega..."
                  ></textarea>
                </div>

                <!-- Botón continuar -->
                <button 
                  type="submit"
                  class="w-full py-3 bg-navy-900 text-white font-medium rounded-lg hover:bg-navy-800 transition-colors flex items-center justify-center gap-2"
                >
                  Continuar al pago
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                  </svg>
                </button>
              </form>
            </div>
          </section>

          <!-- ═══════════════════════════════════════════════════════════════
               PASO 2: MÉTODO DE PAGO
               ═══════════════════════════════════════════════════════════════ -->
          <section id="step-payment" class="checkout-step hidden" data-step="2">
            <div class="bg-white rounded-lg shadow-subtle overflow-hidden">
              <div class="bg-navy-900 px-6 py-4 flex items-center justify-between">
                <h2 class="text-white font-serif text-lg flex items-center gap-3">
                  <span class="w-7 h-7 rounded-full bg-white/20 flex items-center justify-center text-sm font-medium">2</span>
                  <span class="text-white">Método de Pago</span>
                </h2>
                <button type="button" id="back-to-shipping" class="text-white/70 hover:text-white text-sm flex items-center gap-1 transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                  </svg>
                  Volver
                </button>
              </div>

              <!-- Resumen de envío -->
              <div class="px-6 py-4 bg-charcoal-50 border-b border-charcoal-100">
                <div class="flex items-start gap-3">
                  <svg class="w-5 h-5 text-green-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                  <div class="flex-1">
                    <p class="font-medium text-navy-900" id="shipping-summary-name">-</p>
                    <p class="text-sm text-charcoal-500" id="shipping-summary-address">-</p>
                    <p class="text-sm text-charcoal-500" id="shipping-summary-method">-</p>
                  </div>
                </div>
              </div>
              
              <div class="p-6 space-y-6">
                <!-- Selección de método de pago -->
                <div class="space-y-3">
                  <!-- Tarjeta de crédito -->
                  <label class="payment-method-card flex items-center gap-4 p-4 border-2 border-navy-900 rounded-lg cursor-pointer bg-navy-50/30">
                    <input 
                      type="radio" 
                      name="paymentMethod" 
                      value="card"
                      checked
                      class="w-4 h-4 text-navy-900 border-charcoal-300 focus:ring-navy-900"
                    />
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-navy-900">Tarjeta de crédito/débito</span>
                      </div>
                      <p class="text-sm text-charcoal-500">Pago seguro con Stripe</p>
                    </div>
                    <div class="flex items-center gap-1">
                      <svg class="h-6 w-8 text-[#1A1F71]" viewBox="0 0 48 32" fill="currentColor">
                        <path d="M17.5 10.5l-1.8 11h2.9l1.8-11h-2.9zm12.1 0l-2.7 7.5-.3-1.5-.9-4.6c-.2-.7-.7-1-1.4-1h-4.5l-.1.3c1 .3 2.1.7 2.8 1 .4.2.5.4.6.7l2.2 8.6h3l4.5-11h-3.2zm4.8 7.4c0-.5.4-1 1.5-1.2.5-.1 1.9-.2 3.5.5l.6-2.7c-.8-.3-2-.6-3.3-.6-3.5 0-6 1.9-6 4.5 0 2 1.8 3.1 3.1 3.7 1.4.7 1.9 1.1 1.8 1.7 0 .9-1.1 1.3-2.1 1.4-1.8 0-2.8-.5-3.6-.9l-.6 2.9c.8.4 2.3.7 3.9.7 3.7 0 6.2-1.8 6.2-4.7 0-3.6-5-3.8-5-5.3zm14.1-7.4h-2.3c-.7 0-1.3.2-1.6 1l-4.6 11h3.2l.6-1.8h3.9l.4 1.8h2.8l-2.4-11zm-3.6 7.1l1.6-4.4.9 4.4h-2.5z"/>
                      </svg>
                      <svg class="h-6 w-8 text-[#EB001B]" viewBox="0 0 48 32" fill="currentColor">
                        <circle cx="18" cy="16" r="10" fill="#EB001B"/>
                        <circle cx="30" cy="16" r="10" fill="#F79E1B"/>
                        <path d="M24 8.5a10 10 0 000 15 10 10 0 000-15z" fill="#FF5F00"/>
                      </svg>
                    </div>
                  </label>

                  <!-- Contrareembolso -->
                  <label class="payment-method-card flex items-center gap-4 p-4 border border-charcoal-200 rounded-lg cursor-pointer hover:border-charcoal-300 transition-colors">
                    <input 
                      type="radio" 
                      name="paymentMethod" 
                      value="cash_on_delivery"
                      class="w-4 h-4 text-navy-900 border-charcoal-300 focus:ring-navy-900"
                    />
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-charcoal-700">Contrareembolso</span>
                        <span class="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full">+3,00 €</span>
                      </div>
                      <p class="text-sm text-charcoal-500">Paga en efectivo al recibir tu pedido</p>
                    </div>
                    <svg class="w-6 h-6 text-charcoal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                  </label>
                </div>

                <!-- Formulario de tarjeta (Stripe) -->
                <div id="card-payment-form" class="space-y-4">
                  <!-- Selector de tarjetas guardadas (solo si hay usuario y tarjetas) -->
                  {user && userPaymentMethods.length > 0 && (
                    <div class="mb-4">
                      <label class="block text-sm font-medium text-charcoal-700 mb-3">
                        <span class="flex items-center gap-2">
                          <svg class="w-4 h-4 text-navy-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                          </svg>
                          Usar una tarjeta guardada
                        </span>
                      </label>
                      <div class="space-y-2" id="saved-cards">
                        {userPaymentMethods.map((card, index) => {
                          // Usar card_brand y card_last4 que son las columnas del schema original
                          const hasValidData = card.card_brand && card.card_last4;
                          const cardBrand = card.card_brand || 'card';
                          const cardLastFour = card.card_last4 || '****';
                          return (
                          <label class={`saved-card-option flex items-center gap-3 p-4 border rounded-lg cursor-pointer transition-colors ${hasValidData ? 'border-charcoal-200 hover:border-navy-900/30' : 'border-red-200 bg-red-50/50'}`}>
                            <input 
                              type="radio" 
                              name="savedCard" 
                              value={card.id}
                              data-stripe-pm={card.stripe_payment_method_id || ''}
                              data-last-four={cardLastFour}
                              data-brand={cardBrand}
                              checked={index === 0 && hasValidData}
                              disabled={!hasValidData}
                              class="w-4 h-4 text-navy-900 border-charcoal-300 focus:ring-navy-900 disabled:opacity-50"
                            />
                            <div class="flex items-center gap-3 flex-1">
                              {cardBrand === 'visa' && (
                                <svg class="h-8 w-12 text-[#1A1F71]" viewBox="0 0 48 32" fill="currentColor">
                                  <path d="M17.5 10.5l-1.8 11h2.9l1.8-11h-2.9zm12.1 0l-2.7 7.5-.3-1.5-.9-4.6c-.2-.7-.7-1-1.4-1h-4.5l-.1.3c1 .3 2.1.7 2.8 1 .4.2.5.4.6.7l2.2 8.6h3l4.5-11h-3.2zm4.8 7.4c0-.5.4-1 1.5-1.2.5-.1 1.9-.2 3.5.5l.6-2.7c-.8-.3-2-.6-3.3-.6-3.5 0-6 1.9-6 4.5 0 2 1.8 3.1 3.1 3.7 1.4.7 1.9 1.1 1.8 1.7 0 .9-1.1 1.3-2.1 1.4-1.8 0-2.8-.5-3.6-.9l-.6 2.9c.8.4 2.3.7 3.9.7 3.7 0 6.2-1.8 6.2-4.7 0-3.6-5-3.8-5-5.3zm14.1-7.4h-2.3c-.7 0-1.3.2-1.6 1l-4.6 11h3.2l.6-1.8h3.9l.4 1.8h2.8l-2.4-11zm-3.6 7.1l1.6-4.4.9 4.4h-2.5z"/>
                                </svg>
                              )}
                              {cardBrand === 'mastercard' && (
                                <svg class="h-8 w-12" viewBox="0 0 48 32">
                                  <circle cx="18" cy="16" r="10" fill="#EB001B"/>
                                  <circle cx="30" cy="16" r="10" fill="#F79E1B"/>
                                  <path d="M24 8.5a10 10 0 000 15 10 10 0 000-15z" fill="#FF5F00"/>
                                </svg>
                              )}
                              {cardBrand !== 'visa' && cardBrand !== 'mastercard' && (
                                <div class="h-8 w-12 bg-charcoal-200 rounded flex items-center justify-center text-xs font-medium text-charcoal-600">
                                  {cardBrand.toUpperCase().slice(0, 4)}
                                </div>
                              )}
                              <div>
                                <div class="flex items-center gap-2">
                                  <span class={`font-medium ${hasValidData ? 'text-navy-900' : 'text-red-600'}`}>
                                    {hasValidData 
                                      ? (card.label || `${cardBrand.charAt(0).toUpperCase()}${cardBrand.slice(1)} terminada en ${cardLastFour}`)
                                      : 'Tarjeta con datos incompletos'}
                                  </span>
                                  {card.is_default && hasValidData && (
                                    <span class="px-2 py-0.5 bg-navy-100 text-navy-700 text-xs rounded-full">Principal</span>
                                  )}
                                  {!hasValidData && (
                                    <span class="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full">Eliminar y volver a añadir</span>
                                  )}
                                </div>
                                <p class="text-sm text-charcoal-500">•••• •••• •••• {cardLastFour}</p>
                              </div>
                            </div>
                          </label>
                        )})}
                        <label class="saved-card-option flex items-center gap-3 p-4 border border-dashed border-charcoal-300 rounded-lg cursor-pointer hover:border-navy-900/50 hover:bg-charcoal-50 transition-colors">
                          <input 
                            type="radio" 
                            name="savedCard" 
                            value="new"
                            class="w-4 h-4 text-navy-900 border-charcoal-300 focus:ring-navy-900"
                          />
                          <div class="flex items-center gap-2 text-charcoal-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            <span class="font-medium">Usar otra tarjeta</span>
                          </div>
                        </label>
                      </div>
                    </div>
                  )}

                  <!-- Datos de seguridad para tarjeta guardada -->
                  <div id="saved-card-security" class={userPaymentMethods.length > 0 ? '' : 'hidden'}>
                    <div class="p-4 bg-charcoal-50 rounded-lg border border-charcoal-200">
                      <p class="text-sm text-charcoal-600 mb-3">Por seguridad, introduce el CVV de tu tarjeta:</p>
                      <div class="flex gap-4 items-end">
                        <div class="w-24">
                          <label for="saved-card-cvv" class="block text-xs font-medium text-charcoal-500 mb-1">CVV</label>
                          <input 
                            type="text" 
                            id="saved-card-cvv" 
                            maxlength="4"
                            pattern="[0-9]*"
                            inputmode="numeric"
                            class="w-full px-3 py-2.5 border border-charcoal-300 rounded-lg focus:ring-2 focus:ring-navy-900/20 focus:border-navy-900 transition-colors text-center font-mono"
                            placeholder="•••"
                          />
                        </div>
                        <p class="text-xs text-charcoal-400 pb-2">Los 3 o 4 dígitos en el reverso de tu tarjeta</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Formulario para nueva tarjeta -->
                  <div id="new-card-form" class={userPaymentMethods.length > 0 ? 'hidden' : ''}>
                    <div class="p-4 bg-charcoal-50 rounded-lg border border-charcoal-200">
                      <div id="stripe-card-element" class="min-h-[44px]">
                        <!-- Stripe Elements se insertará aquí -->
                        <div class="animate-pulse flex items-center gap-2 text-charcoal-400">
                          <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                          <span class="text-sm">Cargando formulario de pago...</span>
                        </div>
                      </div>
                      <div id="card-errors" class="text-red-600 text-sm mt-2 hidden"></div>
                      
                      <!-- Opción de guardar tarjeta -->
                      {user && (
                        <div class="mt-4 pt-4 border-t border-charcoal-200">
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input 
                              type="checkbox" 
                              id="save-card" 
                              name="saveCard"
                              class="w-4 h-4 text-navy-900 border-charcoal-300 rounded focus:ring-navy-900"
                            />
                            <span class="text-sm text-charcoal-600">Guardar esta tarjeta para futuras compras</span>
                          </label>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                <!-- Info contrareembolso -->
                <div id="cod-info" class="hidden p-4 bg-amber-50 border border-amber-200 rounded-lg">
                  <div class="flex gap-3">
                    <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                      <p class="font-medium text-amber-800">Pago al recibir</p>
                      <p class="text-sm text-amber-700 mt-1">
                        Ten preparado el importe exacto en efectivo. El repartidor no puede dar cambio de billetes grandes.
                        Se aplica un cargo adicional de 3,00 € por este método de pago.
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Botón pagar -->
                <button 
                  type="button"
                  id="pay-button"
                  disabled
                  class="w-full py-3.5 bg-navy-900 text-white font-medium rounded-lg hover:bg-navy-800 transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                  </svg>
                  <span id="pay-button-text">Confirmar pedido</span>
                </button>

                <!-- Seguridad -->
                <div class="flex items-center justify-center gap-4 pt-2 text-xs text-charcoal-400">
                  <div class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                    </svg>
                    SSL Seguro
                  </div>
                  <div class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Datos protegidos
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- ═══════════════════════════════════════════════════════════════
               PASO 3: CONFIRMACIÓN
               ═══════════════════════════════════════════════════════════════ -->
          <section id="step-confirmation" class="checkout-step hidden" data-step="3">
            <div class="bg-white rounded-lg shadow-subtle overflow-hidden text-center py-12 px-6">
              <!-- Animación de éxito -->
              <div class="w-20 h-20 mx-auto bg-green-100 rounded-full flex items-center justify-center mb-6 animate-bounce-once">
                <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              
              <h2 class="font-serif text-2xl lg:text-3xl text-navy-900 mb-2">¡Pedido confirmado!</h2>
              <p class="text-charcoal-500 mb-8 max-w-md mx-auto">
                Gracias por tu compra. Hemos enviado un email de confirmación con todos los detalles a:
              </p>
              
              <p class="text-lg font-medium text-navy-900 mb-8" id="confirmation-email">-</p>
              
              <!-- Número de pedido -->
              <div class="inline-flex items-center gap-3 bg-navy-50 border border-navy-100 rounded-lg px-6 py-4 mb-8">
                <div class="text-left">
                  <p class="text-xs text-charcoal-500 uppercase tracking-wider">Nº de pedido</p>
                  <p class="text-xl font-bold text-navy-900 font-mono" id="order-number">-</p>
                </div>
                <button type="button" id="copy-order-number" class="p-2 hover:bg-navy-100 rounded-lg transition-colors" title="Copiar">
                  <svg class="w-5 h-5 text-navy-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                  </svg>
                </button>
              </div>

              <!-- Info de seguimiento -->
              <div class="bg-charcoal-50 rounded-lg p-6 mb-8 max-w-lg mx-auto">
                <h3 class="font-medium text-navy-900 mb-4 flex items-center justify-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                  </svg>
                  Próximos pasos
                </h3>
                <ul class="text-sm text-charcoal-600 space-y-3 text-left">
                  <li class="flex items-start gap-3">
                    <span class="w-6 h-6 rounded-full bg-navy-900 text-white text-xs flex items-center justify-center flex-shrink-0 mt-0.5">1</span>
                    <span>Recibirás un email de confirmación con los detalles del pedido</span>
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="w-6 h-6 rounded-full bg-navy-900 text-white text-xs flex items-center justify-center flex-shrink-0 mt-0.5">2</span>
                    <span>Preparamos tu pedido con cuidado (1-2 días laborables)</span>
                  </li>
                  <li class="flex items-start gap-3">
                    <span class="w-6 h-6 rounded-full bg-navy-900 text-white text-xs flex items-center justify-center flex-shrink-0 mt-0.5">3</span>
                    <span>Te notificamos por email cuando se envíe con el número de seguimiento</span>
                  </li>
                </ul>
              </div>

              <!-- Botones -->
              <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="/cuenta/pedidos" class="px-6 py-3 bg-navy-900 text-white font-medium rounded-lg hover:bg-navy-800 transition-colors">
                  Ver mis pedidos
                </a>
                <a href="/tienda" class="px-6 py-3 border border-charcoal-200 text-charcoal-700 font-medium rounded-lg hover:bg-charcoal-50 transition-colors">
                  Seguir comprando
                </a>
              </div>
            </div>
          </section>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════
             RESUMEN DEL PEDIDO (2 columnas)
             ═══════════════════════════════════════════════════════════════ -->
        <aside class="lg:col-span-2" id="order-summary-aside">
          <div class="bg-white rounded-lg shadow-subtle sticky top-24 overflow-hidden">
            <div class="bg-navy-900 px-6 py-4">
              <h3 class="text-white font-serif text-lg flex items-center gap-2">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                </svg>
                <span class="text-white">Resumen del pedido</span>
              </h3>
            </div>
            
            <!-- Lista de productos -->
            <div class="p-6 space-y-4 max-h-80 overflow-y-auto" id="cart-items-list">
              <!-- Se llenará dinámicamente -->
              <div class="animate-pulse space-y-3">
                <div class="flex gap-3">
                  <div class="w-16 h-20 bg-charcoal-100 rounded"></div>
                  <div class="flex-1 space-y-2">
                    <div class="h-4 bg-charcoal-100 rounded w-3/4"></div>
                    <div class="h-3 bg-charcoal-100 rounded w-1/2"></div>
                    <div class="h-4 bg-charcoal-100 rounded w-1/4"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Código descuento -->
            <div class="px-6 pb-4">
              <div class="flex gap-2">
                <input 
                  type="text" 
                  id="discount-code"
                  placeholder="Código de descuento"
                  class="flex-1 px-3 py-2 border border-charcoal-200 rounded-lg text-sm focus:ring-2 focus:ring-navy-900/20 focus:border-navy-900"
                />
                <button 
                  type="button"
                  id="apply-discount"
                  class="px-4 py-2 bg-charcoal-100 text-charcoal-700 font-medium text-sm rounded-lg hover:bg-charcoal-200 transition-colors"
                >
                  Aplicar
                </button>
              </div>
              <p id="discount-message" class="text-sm mt-2 hidden"></p>
            </div>

            <!-- Totales -->
            <div class="px-6 pb-6 border-t border-charcoal-100 pt-4 space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-charcoal-500">Subtotal</span>
                <span class="text-charcoal-700" id="subtotal">0,00 €</span>
              </div>
              <div class="flex justify-between text-sm" id="discount-row" style="display: none;">
                <span class="text-green-600">Descuento</span>
                <span class="text-green-600" id="discount-amount">-0,00 €</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-charcoal-500">Envío</span>
                <span class="text-charcoal-700" id="shipping-cost">Calculando...</span>
              </div>
              <div class="flex justify-between text-sm" id="cod-fee-row" style="display: none;">
                <span class="text-charcoal-500">Cargo contrareembolso</span>
                <span class="text-charcoal-700">3,00 €</span>
              </div>
              <div class="flex justify-between font-semibold text-lg pt-3 border-t border-charcoal-100 mt-3">
                <span class="text-navy-900">Total</span>
                <span class="text-navy-900" id="total">0,00 €</span>
              </div>
              <p class="text-xs text-charcoal-400 text-right">IVA incluido</p>
            </div>

            <!-- Garantías -->
            <div class="bg-charcoal-50 px-6 py-4 space-y-3">
              <div class="flex items-center gap-3 text-sm">
                <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span class="text-charcoal-600">Pago 100% seguro</span>
              </div>
              <div class="flex items-center gap-3 text-sm">
                <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                  <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                </svg>
                <span class="text-charcoal-600">Envío gratis en pedidos +100€</span>
              </div>
              <div class="flex items-center gap-3 text-sm">
                <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                </svg>
                <span class="text-charcoal-600">Devolución gratuita 30 días</span>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <!-- Estilos del checkout -->
  <style>
    .step-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--color-charcoal-400);
    }
    
    .step-indicator.active {
      color: var(--color-navy-900);
    }
    
    .step-indicator.completed {
      color: var(--color-success);
    }
    
    .step-number {
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 500;
      background: var(--color-charcoal-100);
      transition: all 0.2s ease;
    }
    
    .step-indicator.active .step-number {
      background: var(--color-navy-900);
      color: white;
    }
    
    .step-indicator.completed .step-number {
      background: var(--color-success);
      color: white;
    }
    
    .step-label {
      font-weight: 500;
    }
    
    .step-divider {
      width: 2rem;
      height: 2px;
      background: var(--color-charcoal-200);
    }
    
    .step-indicator.completed + .step-divider {
      background: var(--color-success);
    }

    .shipping-method-card:has(input:checked) {
      border-color: var(--color-navy-900);
      background: rgba(10, 22, 40, 0.02);
    }

    .saved-address-card:has(input:checked) {
      border-color: var(--color-navy-900);
      background: rgba(10, 22, 40, 0.03);
      box-shadow: 0 0 0 1px var(--color-navy-900);
    }

    .saved-card-option:has(input:checked) {
      border-color: var(--color-navy-900);
      background: rgba(10, 22, 40, 0.03);
      box-shadow: 0 0 0 1px var(--color-navy-900);
    }

    .payment-method-card:has(input:checked) {
      border-color: var(--color-navy-900);
      border-width: 2px;
      background: rgba(10, 22, 40, 0.02);
    }

    .payment-method-card:has(input:checked) .text-charcoal-700 {
      color: var(--color-navy-900);
    }

    /* Stripe Elements */
    #stripe-card-element {
      padding: 12px;
    }

    .StripeElement {
      width: 100%;
    }

    .StripeElement--focus {
      outline: none;
    }

    @keyframes bounce-once {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .animate-bounce-once {
      animation: bounce-once 0.5s ease-in-out;
    }
  </style>

  <!-- Scripts del checkout -->
  <script define:vars={{ stripePublicKey, userId: user?.id || null }}>
    // ═══════════════════════════════════════════════════════════════════════
    // CHECKOUT - SCRIPT PRINCIPAL
    // ═══════════════════════════════════════════════════════════════════════

    // Estado del checkout
    const checkoutState = {
      step: 1,
      cartItems: [],
      shippingData: null,
      paymentMethod: 'card',
      discountCode: null,
      discountAmount: 0,
      subtotal: 0,
      shippingCost: 0,
      codFee: 0,
      total: 0,
      stripe: null,
      cardElement: null,
      paymentIntentClientSecret: null,
      // Estado de tarjeta guardada
      usingSavedCard: false,
      savedCardId: null,
      savedCardStripePM: null,
      savedCardLastFour: null,
      savedCardBrand: null,
    };

    // Formatear precio
    function formatPrice(cents) {
      return (cents / 100).toLocaleString('es-ES', {
        style: 'currency',
        currency: 'EUR'
      });
    }

    // ─────────────────────────────────────────────────────────────────────
    // INICIALIZACIÓN
    // ─────────────────────────────────────────────────────────────────────
    document.addEventListener('DOMContentLoaded', async () => {
      // Primero intentar cargar desde localStorage/sessionStorage
      loadCart();
      
      // Si carrito vacío y hay usuario logueado, intentar cargar del servidor
      if (checkoutState.cartItems.length === 0 && userId) {
        console.log('Carrito local vacío, intentando cargar del servidor...');
        await loadCartFromServer();
      }
      
      // Si sigue vacío, mostrar mensaje
      if (checkoutState.cartItems.length === 0) {
        document.getElementById('checkout-main').classList.add('hidden');
        document.getElementById('empty-cart').classList.remove('hidden');
        return;
      }

      // Renderizar items del carrito
      renderCartItems();
      
      // Calcular totales
      calculateTotals();

      // Inicializar Stripe
      await initStripe();

      // Event listeners
      setupEventListeners();
      
      // Inicializar estado de tarjeta guardada si hay una seleccionada por defecto
      initSavedCardState();
    });
    
    // ─────────────────────────────────────────────────────────────────────
    // CARGAR CARRITO DEL SERVIDOR
    // ─────────────────────────────────────────────────────────────────────
    async function loadCartFromServer() {
      try {
        const response = await fetch('/api/cart/get');
        if (!response.ok) return;
        
        const data = await response.json();
        
        if (data.items && Array.isArray(data.items) && data.items.length > 0) {
          checkoutState.cartItems = data.items.map(item => ({
            productId: item.product_id,
            name: item.name,
            slug: item.slug,
            price: item.price,
            quantity: item.quantity,
            size: item.size,
            color: item.color,
            image: item.image || '/placeholder.jpg',
            maxStock: item.stock || 99,
          }));
          console.log('✅ Carrito cargado del servidor:', checkoutState.cartItems.length, 'items');
          
          // Guardar en localStorage para futuras visitas
          if (userId) {
            localStorage.setItem(`fashionmarket-cart-${userId}`, JSON.stringify(checkoutState.cartItems));
          }
        }
      } catch (error) {
        console.error('Error cargando carrito del servidor:', error);
      }
    }

    // ─────────────────────────────────────────────────────────────────────
    // CARGAR CARRITO
    // ─────────────────────────────────────────────────────────────────────
    function loadCart() {
      try {
        // El carrito puede estar en:
        // 1. sessionStorage con clave 'fashionmarket-cart-guest' (invitados)
        // 2. localStorage con clave 'fashionmarket-cart-{userId}' (usuarios logueados)
        
        // Si hay usuario logueado, buscar su carrito específico
        if (userId) {
          const userCartKey = `fashionmarket-cart-${userId}`;
          const userCart = localStorage.getItem(userCartKey);
          
          if (userCart) {
            const parsed = JSON.parse(userCart);
            if (parsed && Array.isArray(parsed) && parsed.length > 0) {
              checkoutState.cartItems = parsed;
              console.log('✅ Carrito cargado para usuario:', parsed.length, 'items');
              return;
            }
          }
        }
        
        // Si no hay usuario o no tiene carrito, buscar carrito de invitado
        const guestCart = sessionStorage.getItem('fashionmarket-cart-guest');
        if (guestCart) {
          const parsed = JSON.parse(guestCart);
          if (parsed && Array.isArray(parsed) && parsed.length > 0) {
            checkoutState.cartItems = parsed;
            console.log('✅ Carrito de invitado cargado:', parsed.length, 'items');
            return;
          }
        }
        
        // Fallback: buscar clave antigua por compatibilidad
        const oldCart = localStorage.getItem('fashionmarket-cart');
        if (oldCart) {
          const parsed = JSON.parse(oldCart);
          if (parsed && Array.isArray(parsed) && parsed.length > 0) {
            checkoutState.cartItems = parsed;
            console.log('✅ Carrito legacy cargado:', parsed.length, 'items');
            return;
          }
        }
        
        console.log('⚠️ No se encontró carrito');
        checkoutState.cartItems = [];
      } catch (error) {
        console.error('Error cargando carrito:', error);
        checkoutState.cartItems = [];
      }
    }

    // ─────────────────────────────────────────────────────────────────────
    // RENDERIZAR ITEMS DEL CARRITO
    // ─────────────────────────────────────────────────────────────────────
    function renderCartItems() {
      const container = document.getElementById('cart-items-list');
      
      if (checkoutState.cartItems.length === 0) {
        container.innerHTML = '<p class="text-charcoal-500 text-center py-4">Tu carrito está vacío</p>';
        return;
      }

      container.innerHTML = checkoutState.cartItems.map(item => `
        <div class="flex gap-3">
          <img 
            src="${item.image || '/placeholder-product.svg'}" 
            alt="${item.name}"
            class="w-16 h-20 object-cover rounded bg-charcoal-100"
            onerror="this.src='/placeholder-product.svg'"
          />
          <div class="flex-1 min-w-0">
            <h4 class="font-medium text-navy-900 text-sm truncate">${item.name}</h4>
            <p class="text-xs text-charcoal-500">Talla: ${item.size}${item.color ? ` • ${item.color}` : ''}</p>
            <p class="text-xs text-charcoal-400">Cantidad: ${item.quantity}</p>
            <p class="font-semibold text-navy-900 text-sm mt-1">${formatPrice(item.price * item.quantity)}</p>
          </div>
        </div>
      `).join('');
    }

    // ─────────────────────────────────────────────────────────────────────
    // CALCULAR TOTALES
    // ─────────────────────────────────────────────────────────────────────
    function calculateTotals() {
      // Subtotal
      checkoutState.subtotal = checkoutState.cartItems.reduce(
        (sum, item) => sum + (item.price * item.quantity), 0
      );

      // Costo de envío
      const selectedShipping = document.querySelector('input[name="shippingMethod"]:checked');
      if (selectedShipping) {
        const baseCost = parseInt(selectedShipping.dataset.cost) || 0;
        const freeThreshold = parseInt(selectedShipping.dataset.freeThreshold) || 999999;
        checkoutState.shippingCost = checkoutState.subtotal >= freeThreshold ? 0 : baseCost;
      }

      // Actualizar costos de envío mostrados
      updateShippingCostsDisplay();

      // Cargo por contrareembolso
      checkoutState.codFee = checkoutState.paymentMethod === 'cash_on_delivery' ? 300 : 0;

      // Total
      checkoutState.total = checkoutState.subtotal - checkoutState.discountAmount + checkoutState.shippingCost + checkoutState.codFee;

      // Actualizar UI
      document.getElementById('subtotal').textContent = formatPrice(checkoutState.subtotal);
      document.getElementById('shipping-cost').textContent = checkoutState.shippingCost === 0 ? 'Gratis' : formatPrice(checkoutState.shippingCost);
      document.getElementById('total').textContent = formatPrice(checkoutState.total);

      // Mostrar/ocultar fila de descuento
      const discountRow = document.getElementById('discount-row');
      if (checkoutState.discountAmount > 0) {
        discountRow.style.display = 'flex';
        document.getElementById('discount-amount').textContent = '-' + formatPrice(checkoutState.discountAmount);
      } else {
        discountRow.style.display = 'none';
      }

      // Mostrar/ocultar cargo contrareembolso
      document.getElementById('cod-fee-row').style.display = 
        checkoutState.paymentMethod === 'cash_on_delivery' ? 'flex' : 'none';
    }

    // Actualizar display de costos de envío según subtotal
    function updateShippingCostsDisplay() {
      document.querySelectorAll('.shipping-cost').forEach(el => {
        const baseCost = parseInt(el.dataset.base) || 0;
        const threshold = parseInt(el.dataset.threshold) || 999999;
        
        if (checkoutState.subtotal >= threshold) {
          el.textContent = 'Gratis';
          el.classList.add('text-green-600');
        } else {
          el.textContent = formatPrice(baseCost);
          el.classList.remove('text-green-600');
        }
      });
    }

    // ─────────────────────────────────────────────────────────────────────
    // INICIALIZAR STRIPE
    // ─────────────────────────────────────────────────────────────────────
    async function initStripe() {
      if (!stripePublicKey) {
        console.error('Stripe public key no configurada');
        document.getElementById('stripe-card-element').innerHTML = `
          <p class="text-amber-600 text-sm">⚠️ Stripe no configurado. Usa contrareembolso.</p>
        `;
        return;
      }

      // Cargar Stripe.js
      if (!window.Stripe) {
        const script = document.createElement('script');
        script.src = 'https://js.stripe.com/v3/';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
      }

      checkoutState.stripe = Stripe(stripePublicKey);
      
      const elements = checkoutState.stripe.elements({
        locale: 'es'
      });

      checkoutState.cardElement = elements.create('card', {
        style: {
          base: {
            fontSize: '16px',
            color: '#1a2744',
            fontFamily: 'Inter, system-ui, sans-serif',
            '::placeholder': { color: '#8a8a8a' },
          },
          invalid: { color: '#8b2635' }
        },
        hidePostalCode: true
      });

      checkoutState.cardElement.mount('#stripe-card-element');

      // Escuchar cambios en el elemento de tarjeta
      checkoutState.cardElement.on('change', (event) => {
        const errorEl = document.getElementById('card-errors');
        if (event.error) {
          errorEl.textContent = event.error.message;
          errorEl.classList.remove('hidden');
        } else {
          errorEl.classList.add('hidden');
        }
        
        // Habilitar/deshabilitar botón
        updatePayButton();
      });

      // Habilitar botón de pago
      updatePayButton();
    }

    // ─────────────────────────────────────────────────────────────────────
    // EVENT LISTENERS
    // ─────────────────────────────────────────────────────────────────────
    function setupEventListeners() {
      // Formulario de envío
      document.getElementById('shipping-form').addEventListener('submit', handleShippingSubmit);

      // Volver a envío
      document.getElementById('back-to-shipping').addEventListener('click', () => goToStep(1));

      // Cambio de método de envío
      document.querySelectorAll('input[name="shippingMethod"]').forEach(input => {
        input.addEventListener('change', calculateTotals);
      });

      // Cambio de método de pago
      document.querySelectorAll('input[name="paymentMethod"]').forEach(input => {
        input.addEventListener('change', handlePaymentMethodChange);
      });

      // Selector de direcciones guardadas
      document.querySelectorAll('input[name="savedAddress"]').forEach(input => {
        input.addEventListener('change', handleSavedAddressChange);
      });

      // Selector de tarjetas guardadas
      document.querySelectorAll('input[name="savedCard"]').forEach(input => {
        input.addEventListener('change', handleSavedCardChange);
      });

      // Aplicar descuento
      document.getElementById('apply-discount').addEventListener('click', applyDiscount);
      document.getElementById('discount-code').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          applyDiscount();
        }
      });

      // Botón de pago
      document.getElementById('pay-button').addEventListener('click', handlePayment);

      // Copiar número de pedido
      document.getElementById('copy-order-number')?.addEventListener('click', () => {
        const orderNumber = document.getElementById('order-number').textContent;
        navigator.clipboard.writeText(orderNumber);
        // Mostrar feedback
        const btn = document.getElementById('copy-order-number');
        btn.innerHTML = '<svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
        setTimeout(() => {
          btn.innerHTML = '<svg class="w-5 h-5 text-navy-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>';
        }, 2000);
      });
    }

    // ─────────────────────────────────────────────────────────────────────
    // MANEJO DE DIRECCIONES GUARDADAS
    // ─────────────────────────────────────────────────────────────────────
    function handleSavedAddressChange(e) {
      const manualForm = document.getElementById('manual-address-form');
      const selectedValue = e.target.value;
      
      if (selectedValue === 'new') {
        // Mostrar formulario manual y limpiar campos
        manualForm.classList.remove('hidden');
        document.getElementById('firstName').value = '';
        document.getElementById('lastName').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('address').value = '';
        document.getElementById('postalCode').value = '';
        document.getElementById('city').value = '';
        document.getElementById('province').value = '';
      } else {
        // Ocultar formulario manual y rellenar con datos de la dirección guardada
        manualForm.classList.add('hidden');
        
        const selectedInput = e.target;
        const fullName = selectedInput.dataset.fullname || '';
        const nameParts = fullName.split(' ');
        const firstName = nameParts[0] || '';
        const lastName = nameParts.slice(1).join(' ') || '';
        
        // Actualizar campos ocultos o crear campos hidden para el submit
        document.getElementById('firstName').value = firstName;
        document.getElementById('lastName').value = lastName;
        document.getElementById('phone').value = selectedInput.dataset.phone || '';
        document.getElementById('address').value = selectedInput.dataset.address || '';
        document.getElementById('postalCode').value = selectedInput.dataset.postalcode || '';
        document.getElementById('city').value = selectedInput.dataset.city || '';
        document.getElementById('province').value = selectedInput.dataset.province || '';
      }
    }

    // ─────────────────────────────────────────────────────────────────────
    // MANEJO DE TARJETAS GUARDADAS
    // ─────────────────────────────────────────────────────────────────────
    function handleSavedCardChange(e) {
      const newCardForm = document.getElementById('new-card-form');
      const savedCardSecurity = document.getElementById('saved-card-security');
      const selectedValue = e.target.value;
      
      if (selectedValue === 'new') {
        // Mostrar formulario de nueva tarjeta
        newCardForm.classList.remove('hidden');
        savedCardSecurity.classList.add('hidden');
        // Limpiar CVV guardado
        const cvvInput = document.getElementById('saved-card-cvv');
        if (cvvInput) cvvInput.value = '';
        checkoutState.usingSavedCard = false;
        checkoutState.savedCardId = null;
      } else {
        // Usar tarjeta guardada - mostrar solo campo CVV
        newCardForm.classList.add('hidden');
        savedCardSecurity.classList.remove('hidden');
        checkoutState.usingSavedCard = true;
        checkoutState.savedCardId = selectedValue;
        
        // Obtener datos de la tarjeta seleccionada
        const selectedInput = e.target;
        checkoutState.savedCardStripePM = selectedInput.dataset.stripePm || '';
        checkoutState.savedCardLastFour = selectedInput.dataset.lastFour || '';
        checkoutState.savedCardBrand = selectedInput.dataset.brand || '';
      }
      
      updatePayButton();
    }

    // Inicializar estado de tarjeta guardada si hay una por defecto
    function initSavedCardState() {
      const savedCardInput = document.querySelector('input[name="savedCard"]:checked:not(:disabled)');
      if (savedCardInput && savedCardInput.value !== 'new') {
        const stripePM = savedCardInput.dataset.stripePm;
        // Solo usar tarjeta guardada si tiene un stripe_payment_method_id válido
        if (stripePM && stripePM !== '') {
          checkoutState.usingSavedCard = true;
          checkoutState.savedCardId = savedCardInput.value;
          checkoutState.savedCardStripePM = stripePM;
          checkoutState.savedCardLastFour = savedCardInput.dataset.lastFour || '****';
          checkoutState.savedCardBrand = savedCardInput.dataset.brand || 'card';
        } else {
          // Si no hay stripe_payment_method_id, seleccionar "nueva tarjeta" por defecto
          const newCardOption = document.querySelector('input[name="savedCard"][value="new"]');
          if (newCardOption) {
            newCardOption.checked = true;
            handleSavedCardChange({ target: newCardOption });
          }
        }
      }
    }

    // ─────────────────────────────────────────────────────────────────────
    // NAVEGACIÓN ENTRE PASOS
    // ─────────────────────────────────────────────────────────────────────
    function goToStep(step) {
      checkoutState.step = step;
      
      // Ocultar todos los pasos
      document.querySelectorAll('.checkout-step').forEach(el => {
        el.classList.add('hidden');
      });

      // Mostrar paso actual - buscar específicamente en las secciones con clase checkout-step
      const stepSection = document.querySelector(`.checkout-step[data-step="${step}"]`);
      if (stepSection) {
        stepSection.classList.remove('hidden');
      }

      // Actualizar indicadores
      document.querySelectorAll('.step-indicator').forEach((el, index) => {
        const stepNum = index + 1;
        el.classList.remove('active', 'completed');
        
        if (stepNum === step) {
          el.classList.add('active');
        } else if (stepNum < step) {
          el.classList.add('completed');
        }
      });

      // Scroll al top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ─────────────────────────────────────────────────────────────────────
    // MANEJO DEL FORMULARIO DE ENVÍO
    // ─────────────────────────────────────────────────────────────────────
    function handleShippingSubmit(e) {
      e.preventDefault();
      
      const form = e.target;
      const formData = new FormData(form);
      
      // Verificar si se usa una dirección guardada
      const savedAddressValue = formData.get('savedAddress');
      const usingSavedAddress = savedAddressValue && savedAddressValue !== 'new';
      
      let shippingData;
      
      if (usingSavedAddress) {
        // Obtener datos de la dirección guardada seleccionada
        const selectedInput = document.querySelector(`input[name="savedAddress"][value="${savedAddressValue}"]`);
        const fullName = selectedInput?.dataset.fullname || '';
        const nameParts = fullName.split(' ');
        
        shippingData = {
          firstName: nameParts[0] || '',
          lastName: nameParts.slice(1).join(' ') || '',
          email: formData.get('email'),
          phone: selectedInput?.dataset.phone || '',
          address: selectedInput?.dataset.address || '',
          postalCode: selectedInput?.dataset.postalcode || '',
          city: selectedInput?.dataset.city || '',
          province: selectedInput?.dataset.province || '',
          shippingMethod: formData.get('shippingMethod'),
          notes: formData.get('notes'),
          savedAddressId: savedAddressValue,
        };
      } else {
        // Usar datos del formulario manual
        shippingData = {
          firstName: formData.get('firstName'),
          lastName: formData.get('lastName'),
          email: formData.get('email'),
          phone: formData.get('phone'),
          address: formData.get('address'),
          postalCode: formData.get('postalCode'),
          city: formData.get('city'),
          province: formData.get('province'),
          shippingMethod: formData.get('shippingMethod'),
          notes: formData.get('notes'),
        };
      }

      checkoutState.shippingData = shippingData;

      // Actualizar resumen en paso de pago
      document.getElementById('shipping-summary-name').textContent = 
        `${checkoutState.shippingData.firstName} ${checkoutState.shippingData.lastName}`;
      document.getElementById('shipping-summary-address').textContent = 
        `${checkoutState.shippingData.address}, ${checkoutState.shippingData.postalCode} ${checkoutState.shippingData.city}`;
      
      const methodLabel = document.querySelector(`input[value="${checkoutState.shippingData.shippingMethod}"]`)
        ?.closest('label')?.querySelector('.font-medium')?.textContent || 'Envío estándar';
      document.getElementById('shipping-summary-method').textContent = methodLabel;

      // Ir al paso de pago
      goToStep(2);
    }

    // ─────────────────────────────────────────────────────────────────────
    // CAMBIO DE MÉTODO DE PAGO
    // ─────────────────────────────────────────────────────────────────────
    function handlePaymentMethodChange(e) {
      checkoutState.paymentMethod = e.target.value;
      
      const cardForm = document.getElementById('card-payment-form');
      const codInfo = document.getElementById('cod-info');
      
      if (checkoutState.paymentMethod === 'card') {
        cardForm.classList.remove('hidden');
        codInfo.classList.add('hidden');
      } else {
        cardForm.classList.add('hidden');
        codInfo.classList.remove('hidden');
      }

      // Recalcular totales
      calculateTotals();
      
      // Actualizar botón de pago
      updatePayButton();
    }

    // ─────────────────────────────────────────────────────────────────────
    // ACTUALIZAR BOTÓN DE PAGO
    // ─────────────────────────────────────────────────────────────────────
    function updatePayButton() {
      const btn = document.getElementById('pay-button');
      const btnText = document.getElementById('pay-button-text');
      
      if (checkoutState.paymentMethod === 'cash_on_delivery') {
        btn.disabled = false;
        btnText.textContent = `Confirmar pedido • ${formatPrice(checkoutState.total)}`;
      } else {
        // Para tarjeta, habilitar siempre (Stripe valida)
        btn.disabled = false;
        btnText.textContent = `Pagar ${formatPrice(checkoutState.total)}`;
      }
    }

    // ─────────────────────────────────────────────────────────────────────
    // APLICAR CÓDIGO DE DESCUENTO
    // ─────────────────────────────────────────────────────────────────────
    async function applyDiscount() {
      const code = document.getElementById('discount-code').value.trim();
      const messageEl = document.getElementById('discount-message');
      
      if (!code) {
        messageEl.textContent = 'Introduce un código';
        messageEl.className = 'text-sm mt-2 text-red-600';
        messageEl.classList.remove('hidden');
        return;
      }

      try {
        const response = await fetch('/api/discount/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            code, 
            subtotal: checkoutState.subtotal 
          }),
        });

        const data = await response.json();

        if (data.valid) {
          checkoutState.discountCode = code;
          checkoutState.discountAmount = data.discount_amount;
          
          messageEl.textContent = `¡Descuento aplicado! -${formatPrice(data.discount_amount)}`;
          messageEl.className = 'text-sm mt-2 text-green-600';
          
          calculateTotals();
        } else {
          messageEl.textContent = data.error || 'Código no válido';
          messageEl.className = 'text-sm mt-2 text-red-600';
        }
      } catch (error) {
        messageEl.textContent = 'Error al validar el código';
        messageEl.className = 'text-sm mt-2 text-red-600';
      }

      messageEl.classList.remove('hidden');
    }

    // ─────────────────────────────────────────────────────────────────────
    // PROCESAR PAGO
    // ─────────────────────────────────────────────────────────────────────
    async function handlePayment() {
      const btn = document.getElementById('pay-button');
      const btnText = document.getElementById('pay-button-text');
      
      btn.disabled = true;
      btnText.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Procesando...';

      try {
        if (checkoutState.paymentMethod === 'card') {
          await processCardPayment();
        } else {
          await processCODOrder();
        }
      } catch (error) {
        console.error('Error en el pago:', error);
        alert('Error al procesar el pago: ' + error.message);
        btn.disabled = false;
        updatePayButton();
      }
    }

    // Pago con tarjeta
    async function processCardPayment() {
      // Verificar si estamos usando una tarjeta guardada y tiene el ID de Stripe
      if (checkoutState.usingSavedCard && checkoutState.savedCardStripePM && checkoutState.savedCardStripePM !== '') {
        await processSavedCardPayment();
      } else {
        // Si no hay payment method válido de Stripe, usar tarjeta nueva
        if (checkoutState.usingSavedCard && (!checkoutState.savedCardStripePM || checkoutState.savedCardStripePM === '')) {
          throw new Error('Esta tarjeta no tiene datos de pago válidos. Por favor, usa "Usar otra tarjeta" para añadir una nueva.');
        }
        await processNewCardPayment();
      }
    }

    // Pago con tarjeta guardada
    async function processSavedCardPayment() {
      const cvvInput = document.getElementById('saved-card-cvv');
      const cvv = cvvInput?.value?.trim();
      
      if (!cvv || cvv.length < 3) {
        throw new Error('Por favor, introduce el CVV de tu tarjeta');
      }

      if (!checkoutState.savedCardStripePM) {
        throw new Error('No se encontró el método de pago. Por favor, usa otra tarjeta.');
      }

      // 1. Crear Payment Intent
      const piResponse = await fetch('/api/stripe/create-payment-intent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: checkoutState.total,
          currency: 'eur',
          metadata: {
            customer_email: checkoutState.shippingData.email,
            saved_card: 'true',
            card_last_four: checkoutState.savedCardLastFour,
          }
        }),
      });

      const piData = await piResponse.json();
      
      if (!piData.clientSecret) {
        throw new Error(piData.error || 'Error al crear el pago');
      }

      // 2. Confirmar el pago con el payment_method guardado
      const { error, paymentIntent } = await checkoutState.stripe.confirmCardPayment(
        piData.clientSecret,
        {
          payment_method: checkoutState.savedCardStripePM,
        }
      );

      if (error) {
        throw new Error(error.message);
      }

      if (paymentIntent.status === 'succeeded') {
        await createOrder(paymentIntent.id);
      }
    }

    // Pago con tarjeta nueva
    async function processNewCardPayment() {
      // 1. Crear Payment Intent
      const piResponse = await fetch('/api/stripe/create-payment-intent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: checkoutState.total,
          currency: 'eur',
          metadata: {
            customer_email: checkoutState.shippingData.email,
          }
        }),
      });

      const piData = await piResponse.json();
      
      if (!piData.clientSecret) {
        throw new Error(piData.error || 'Error al crear el pago');
      }

      // 2. Confirmar el pago con Stripe
      const { error, paymentIntent } = await checkoutState.stripe.confirmCardPayment(
        piData.clientSecret,
        {
          payment_method: {
            card: checkoutState.cardElement,
            billing_details: {
              name: `${checkoutState.shippingData.firstName} ${checkoutState.shippingData.lastName}`,
              email: checkoutState.shippingData.email,
              phone: checkoutState.shippingData.phone,
            }
          }
        }
      );

      if (error) {
        throw new Error(error.message);
      }

      if (paymentIntent.status === 'succeeded') {
        // Guardar tarjeta si el usuario lo solicitó
        const saveCardCheckbox = document.getElementById('save-card');
        if (saveCardCheckbox?.checked && paymentIntent.payment_method) {
          await savePaymentMethod(paymentIntent.payment_method);
        }
        
        // 3. Crear el pedido en el backend
        await createOrder(paymentIntent.id);
      }
    }

    // Guardar método de pago para futuras compras
    async function savePaymentMethod(paymentMethodId) {
      try {
        const response = await fetch('/api/payment-methods/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ payment_method_id: paymentMethodId }),
        });
        
        if (!response.ok) {
          console.error('Error guardando método de pago');
        }
      } catch (error) {
        console.error('Error guardando método de pago:', error);
      }
    }

    // Pedido con contrareembolso
    async function processCODOrder() {
      await createOrder(null);
    }

    // Crear pedido en el backend
    async function createOrder(paymentIntentId) {
      const orderData = {
        items: checkoutState.cartItems.map(item => ({
          product_id: item.productId,
          product_name: item.name,
          product_image: item.image,
          product_slug: item.slug,
          quantity: item.quantity,
          size: item.size,
          color: item.color || null,
          unit_price: item.price,
        })),
        shipping_address: {
          full_name: `${checkoutState.shippingData.firstName} ${checkoutState.shippingData.lastName}`,
          phone: checkoutState.shippingData.phone,
          address_line1: checkoutState.shippingData.address,
          city: checkoutState.shippingData.city,
          province: checkoutState.shippingData.province,
          postal_code: checkoutState.shippingData.postalCode,
          country: 'España',
        },
        shipping_method: checkoutState.shippingData.shippingMethod,
        payment_method: checkoutState.paymentMethod,
        payment_intent_id: paymentIntentId,
        discount_code: checkoutState.discountCode,
        discount_amount: checkoutState.discountAmount,
        customer_email: checkoutState.shippingData.email,
        notes: checkoutState.shippingData.notes,
      };

      const response = await fetch('/api/orders/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderData),
      });

      const data = await response.json();

      if (!response.ok || data.error) {
        throw new Error(data.error || 'Error al crear el pedido');
      }

      // Pedido creado exitosamente
      await completeCheckout(data.order);
    }

    // ─────────────────────────────────────────────────────────────────────
    // FINALIZAR CHECKOUT
    // ─────────────────────────────────────────────────────────────────────
    async function completeCheckout(order) {
      console.log('🎉 Completando checkout, limpiando carrito...');
      
      // LIMPIAR CARRITO DE FORMA EXHAUSTIVA
      // 1. Limpiar sessionStorage (invitados)
      sessionStorage.removeItem('fashionmarket-cart-guest');
      
      // 2. Limpiar localStorage viejo
      localStorage.removeItem('fashionmarket-cart');
      
      // 3. Limpiar TODAS las claves de carrito por usuario
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('fashionmarket-cart')) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => {
        console.log('🗑️ Eliminando:', key);
        localStorage.removeItem(key);
      });
      
      // 4. Limpiar estado en memoria
      checkoutState.cartItems = [];
      
      // 5. Disparar evento personalizado
      window.dispatchEvent(new CustomEvent('cart-cleared'));
      
      // 6. Forzar recarga del contador del carrito actualizando el DOM directamente
      const cartBadges = document.querySelectorAll('.cart-badge');
      cartBadges.forEach(badge => {
        badge.textContent = '0';
        badge.style.display = 'none';
      });
      
      // 7. CRÍTICO: Sincronizar carrito vacío al servidor para usuarios logueados
      try {
        await fetch('/api/cart/sync', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: [] }),
        });
        console.log('✅ Carrito sincronizado vacío al servidor');
      } catch (e) {
        console.error('Error sincronizando carrito vacío:', e);
      }
      
      console.log('✅ Carrito limpiado completamente');

      // Actualizar UI de confirmación
      document.getElementById('confirmation-email').textContent = checkoutState.shippingData.email;
      document.getElementById('order-number').textContent = order.order_number || order.orderNumber || '-';

      // Ir al paso de confirmación
      goToStep(3);

      // Ocultar resumen del pedido en confirmación
      document.getElementById('order-summary-aside').classList.add('lg:hidden');
    }
  </script>
</BaseLayout>

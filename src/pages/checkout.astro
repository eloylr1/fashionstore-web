---
/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * FASHIONMARKET - Checkout Profesional
 * Proceso de compra completo: Env√≠o ‚Üí Pago ‚Üí Confirmaci√≥n
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */

export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase/client';

// Obtener clave p√∫blica de Stripe
const stripePublicKey = import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY || '';

// Verificar autenticaci√≥n (opcional - permite invitados)
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let user: any = null;
let userProfile: any = null;

if (accessToken && refreshToken && supabase) {
  const { data: sessionData } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
  
  if (sessionData?.user) {
    user = sessionData.user;
    const { data: profile } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user.id)
      .single();
    if (profile) userProfile = profile;
  }
}

const isGuest = !user;
---

<BaseLayout title="Finalizar Compra | FashionMarket">
  <!-- Cargar Stripe.js -->
  <script is:inline src="https://js.stripe.com/v3/"></script>
  
  <!-- Pasar configuraci√≥n al cliente -->
  <script is:inline define:vars={{ stripePublicKey, isGuest, userEmail: user?.email || '' }}>
    window.STRIPE_PUBLIC_KEY = stripePublicKey;
    window.IS_GUEST = isGuest;
    window.USER_EMAIL = userEmail;
  </script>

  <main class="min-h-screen bg-gray-50">
    <!-- Header del checkout -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <a href="/" class="flex items-center gap-2 text-gray-900">
            <span class="text-xl font-bold">FashionMarket</span>
          </a>
          
          <!-- Indicador de pasos -->
          <div class="hidden sm:flex items-center gap-2" id="steps-indicator">
            <div class="flex items-center" data-step="1">
              <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-medium">1</div>
              <span class="ml-2 text-sm font-medium text-gray-900">Env√≠o</span>
            </div>
            <div class="w-8 h-px bg-gray-300 mx-2"></div>
            <div class="flex items-center" data-step="2">
              <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-medium">2</div>
              <span class="ml-2 text-sm font-medium text-gray-500">Pago</span>
            </div>
            <div class="w-8 h-px bg-gray-300 mx-2"></div>
            <div class="flex items-center" data-step="3">
              <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-medium">3</div>
              <span class="ml-2 text-sm font-medium text-gray-500">Confirmaci√≥n</span>
            </div>
          </div>
          
          <a href="/carrito" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Volver al carrito
          </a>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="lg:grid lg:grid-cols-12 lg:gap-8">
        
        <!-- Columna principal (pasos) -->
        <div class="lg:col-span-7">
          
          <!-- PASO 1: Datos de env√≠o -->
          <section id="step-shipping" class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-3">
              <span class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm">1</span>
              Datos de env√≠o
            </h2>
            
            <form id="shipping-form" class="space-y-4">
              <!-- Nombre y apellidos -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                  <input type="text" id="firstName" name="firstName" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="Tu nombre" />
                </div>
                <div>
                  <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Apellidos *</label>
                  <input type="text" id="lastName" name="lastName" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="Tus apellidos" />
                </div>
              </div>
              
              <!-- Email y tel√©fono -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                  <input type="email" id="email" name="email" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="email@ejemplo.com" />
                </div>
                <div>
                  <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono *</label>
                  <input type="tel" id="phone" name="phone" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="600 000 000" />
                </div>
              </div>
              
              <!-- Direcci√≥n -->
              <div>
                <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n *</label>
                <input type="text" id="address" name="address" required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                  placeholder="Calle, n√∫mero, piso, puerta" />
              </div>
              
              <!-- Ciudad, provincia, CP -->
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                <div>
                  <label for="postalCode" class="block text-sm font-medium text-gray-700 mb-1">C√≥digo Postal *</label>
                  <input type="text" id="postalCode" name="postalCode" required pattern="[0-9]{5}"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="28001" maxlength="5" />
                </div>
                <div>
                  <label for="city" class="block text-sm font-medium text-gray-700 mb-1">Ciudad *</label>
                  <input type="text" id="city" name="city" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="Madrid" />
                </div>
                <div class="col-span-2 sm:col-span-1">
                  <label for="province" class="block text-sm font-medium text-gray-700 mb-1">Provincia *</label>
                  <input type="text" id="province" name="province" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="Madrid" />
                </div>
              </div>
              
              <!-- M√©todo de env√≠o -->
              <div class="pt-4 border-t border-gray-200">
                <label class="block text-sm font-medium text-gray-700 mb-3">M√©todo de env√≠o</label>
                <div class="space-y-3" id="shipping-methods">
                  <!-- Env√≠o est√°ndar -->
                  <label class="flex items-center justify-between p-4 border-2 border-blue-600 bg-blue-50 rounded-lg cursor-pointer shipping-option" data-method="standard">
                    <div class="flex items-center gap-3">
                      <input type="radio" name="shippingMethod" value="standard" checked class="w-4 h-4 text-blue-600" />
                      <div>
                        <span class="font-medium text-gray-900">Env√≠o Est√°ndar</span>
                        <p class="text-sm text-gray-500">Entrega en 3-5 d√≠as laborables</p>
                      </div>
                    </div>
                    <span id="standard-shipping-price" class="font-medium text-gray-900">4,99 ‚Ç¨</span>
                  </label>
                  
                  <!-- Env√≠o express -->
                  <label class="flex items-center justify-between p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300 shipping-option" data-method="express">
                    <div class="flex items-center gap-3">
                      <input type="radio" name="shippingMethod" value="express" class="w-4 h-4 text-blue-600" />
                      <div>
                        <span class="font-medium text-gray-900">Env√≠o Express</span>
                        <p class="text-sm text-gray-500">Entrega en 24-48 horas</p>
                      </div>
                    </div>
                    <span id="express-shipping-price" class="font-medium text-gray-900">9,99 ‚Ç¨</span>
                  </label>
                </div>
                
                <!-- Mensaje env√≠o gratis -->
                <div id="free-shipping-msg" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                  <p class="text-sm text-green-700 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    ¬°Env√≠o gratis en pedidos superiores a 100‚Ç¨!
                  </p>
                </div>
              </div>
              
              <!-- Bot√≥n continuar -->
              <button type="submit" id="btn-continue-payment"
                class="w-full mt-6 bg-blue-600 text-white py-4 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                Continuar al pago
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
            </form>
          </section>
          
          <!-- PASO 2: M√©todo de pago -->
          <section id="step-payment" class="bg-white rounded-xl shadow-sm p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-3">
              <span class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm">2</span>
              M√©todo de pago
            </h2>
            
            <!-- Resumen de env√≠o -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm text-gray-500">Enviar a:</p>
                  <p id="shipping-summary" class="font-medium text-gray-900">-</p>
                  <p id="shipping-email-summary" class="text-sm text-gray-600">-</p>
                </div>
                <button type="button" onclick="goToStep(1)" class="text-sm text-blue-600 hover:underline">Modificar</button>
              </div>
            </div>
            
            <!-- Selector de m√©todo de pago -->
            <div class="space-y-3 mb-6">
              <!-- Tarjeta -->
              <label id="payment-card-option" class="flex items-center justify-between p-4 border-2 border-blue-600 bg-blue-50 rounded-lg cursor-pointer">
                <div class="flex items-center gap-3">
                  <input type="radio" name="paymentMethod" value="card" checked class="w-4 h-4 text-blue-600" />
                  <div>
                    <span class="font-medium text-gray-900">Tarjeta de cr√©dito/d√©bito</span>
                    <p class="text-sm text-gray-500">Pago seguro con Stripe</p>
                  </div>
                </div>
                <div class="flex gap-1">
                  <div class="w-10 h-6 bg-[#1A1F71] rounded flex items-center justify-center">
                    <span class="text-white text-[8px] font-bold">VISA</span>
                  </div>
                  <div class="w-10 h-6 bg-gray-100 rounded flex items-center justify-center">
                    <div class="flex -space-x-1">
                      <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                      <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                    </div>
                  </div>
                </div>
              </label>
              
              <!-- Contrareembolso -->
              <label id="payment-cod-option" class="hidden items-center justify-between p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-gray-300">
                <div class="flex items-center gap-3">
                  <input type="radio" name="paymentMethod" value="cod" class="w-4 h-4 text-blue-600" />
                  <div>
                    <span class="font-medium text-gray-900">Contrareembolso</span>
                    <p class="text-sm text-gray-500">Paga en efectivo al recibir</p>
                  </div>
                </div>
                <span id="cod-extra-cost" class="text-sm font-medium text-amber-600"></span>
              </label>
            </div>
            
            <!-- Formulario de tarjeta -->
            <div id="card-form" class="space-y-4">
              <div>
                <label for="cardholderName" class="block text-sm font-medium text-gray-700 mb-1">Nombre del titular *</label>
                <input type="text" id="cardholderName" 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Como aparece en la tarjeta" />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de tarjeta *</label>
                <div id="card-number" class="px-4 py-3 border border-gray-300 rounded-lg bg-white min-h-[48px]"></div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de expiraci√≥n *</label>
                  <div id="card-expiry" class="px-4 py-3 border border-gray-300 rounded-lg bg-white min-h-[48px]"></div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">CVC *</label>
                  <div id="card-cvc" class="px-4 py-3 border border-gray-300 rounded-lg bg-white min-h-[48px]"></div>
                </div>
              </div>
              
              <!-- Errores de tarjeta -->
              <div id="card-errors" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-600"></div>
            </div>
            
            <!-- Info contrareembolso (oculto por defecto) -->
            <div id="cod-info" class="hidden p-4 bg-amber-50 border border-amber-200 rounded-lg">
              <p class="text-sm text-amber-800">
                <strong>Pago en efectivo:</strong> El repartidor te cobrar√° el importe total al entregar tu pedido.
              </p>
            </div>
            
            <!-- Error general -->
            <div id="payment-error" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
              <p id="payment-error-text" class="text-sm text-red-600"></p>
            </div>
            
            <!-- Botones -->
            <div class="flex gap-4 mt-6">
              <button type="button" onclick="goToStep(1)" class="px-6 py-3 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">
                Atr√°s
              </button>
              <button type="button" id="btn-pay" 
                class="flex-1 bg-blue-600 text-white py-4 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span id="btn-pay-text">Pagar 0,00 ‚Ç¨</span>
              </button>
            </div>
          </section>
          
          <!-- PASO 3: Confirmaci√≥n -->
          <section id="step-confirmation" class="hidden">
            <div class="bg-white rounded-xl shadow-sm p-8 text-center">
              <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              
              <h2 class="text-2xl font-bold text-gray-900 mb-2">¬°Pedido confirmado!</h2>
              <p class="text-gray-600 mb-4">Gracias por tu compra</p>
              
              <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <p class="text-sm text-gray-500">N√∫mero de pedido</p>
                <p id="order-number" class="text-xl font-bold text-blue-600">-</p>
              </div>
              
              <p class="text-sm text-gray-600 mb-6">
                Hemos enviado un email de confirmaci√≥n con todos los detalles a 
                <strong id="confirmation-email">tu correo</strong>
              </p>
              
              <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="/cuenta/pedidos" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                  Ver mis pedidos
                </a>
                <a href="/tienda" class="px-6 py-3 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">
                  Seguir comprando
                </a>
              </div>
            </div>
          </section>
          
        </div>
        
        <!-- Columna lateral: Resumen del pedido -->
        <div class="lg:col-span-5 mt-8 lg:mt-0">
          <div class="bg-white rounded-xl shadow-sm p-6 sticky top-24">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Resumen del pedido</h3>
            
            <!-- Lista de productos -->
            <div id="cart-items" class="space-y-4 max-h-80 overflow-y-auto mb-4">
              <p class="text-gray-500 text-center py-4">Cargando productos...</p>
            </div>
            
            <!-- C√≥digo de descuento -->
            <div class="border-t border-gray-200 pt-4 mb-4">
              <div class="flex gap-2">
                <input type="text" id="discount-code" placeholder="C√≥digo de descuento"
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500" />
                <button type="button" id="btn-apply-discount" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                  Aplicar
                </button>
              </div>
              <div id="discount-applied" class="hidden mt-2 p-2 bg-green-50 rounded-lg">
                <p class="text-sm text-green-700 flex items-center justify-between">
                  <span id="discount-text">Descuento aplicado</span>
                  <button type="button" id="btn-remove-discount" class="text-red-600 hover:underline text-xs">Eliminar</button>
                </p>
              </div>
            </div>
            
            <!-- Totales -->
            <div class="border-t border-gray-200 pt-4 space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Subtotal</span>
                <span id="subtotal" class="font-medium">0,00 ‚Ç¨</span>
              </div>
              <div id="discount-row" class="hidden flex justify-between text-sm">
                <span class="text-green-600">Descuento</span>
                <span id="discount-amount" class="font-medium text-green-600">-0,00 ‚Ç¨</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Env√≠o</span>
                <span id="shipping-cost" class="font-medium">0,00 ‚Ç¨</span>
              </div>
              <div id="cod-row" class="hidden flex justify-between text-sm">
                <span class="text-amber-600">Cargo contrareembolso</span>
                <span id="cod-cost" class="font-medium text-amber-600">0,00 ‚Ç¨</span>
              </div>
              <div class="flex justify-between text-lg font-bold pt-2 border-t border-gray-200">
                <span>Total</span>
                <span id="total">0,00 ‚Ç¨</span>
              </div>
            </div>
            
            <!-- Seguridad -->
            <div class="mt-6 pt-4 border-t border-gray-200">
              <div class="flex items-center gap-2 text-sm text-gray-500">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                <span>Pago 100% seguro con encriptaci√≥n SSL</span>
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </main>

  <script is:inline>
    (function() {
      'use strict';
      
      // Estado global
      var currentStep = 1;
      var cartItems = [];
      var shippingData = null;
      var selectedShippingMethod = 'standard';
      var appliedDiscount = null;
      var storeSettings = null;
      var clientSecret = null;
      
      // Stripe
      var stripe = null;
      var elements = null;
      var cardNumber = null;
      var cardExpiry = null;
      var cardCvc = null;
      
      // Utilidades
      function formatPrice(cents) {
        return (cents / 100).toLocaleString('es-ES', { style: 'currency', currency: 'EUR' });
      }
      
      function getCart() {
        try {
          var saved = localStorage.getItem('fashionmarket-cart');
          return saved ? JSON.parse(saved) : [];
        } catch (e) { return []; }
      }
      
      function clearCart() {
        localStorage.removeItem('fashionmarket-cart');
        window.dispatchEvent(new CustomEvent('cart-updated'));
      }
      
      // Navegaci√≥n
      function goToStep(step) {
        currentStep = step;
        document.getElementById('step-shipping').classList.add('hidden');
        document.getElementById('step-payment').classList.add('hidden');
        document.getElementById('step-confirmation').classList.add('hidden');
        
        if (step === 1) {
          document.getElementById('step-shipping').classList.remove('hidden');
        } else if (step === 2) {
          document.getElementById('step-payment').classList.remove('hidden');
          initStripe();
          updatePaymentSummary();
        } else if (step === 3) {
          document.getElementById('step-confirmation').classList.remove('hidden');
        }
        
        updateStepIndicators(step);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      window.goToStep = goToStep;
      
      function updateStepIndicators(activeStep) {
        var steps = document.querySelectorAll('#steps-indicator [data-step]');
        steps.forEach(function(el) {
          var step = parseInt(el.getAttribute('data-step') || '1');
          var circle = el.querySelector('div');
          var text = el.querySelector('span');
          
          if (step < activeStep) {
            circle.classList.remove('bg-gray-200', 'text-gray-500');
            circle.classList.add('bg-green-600', 'text-white');
            text.classList.remove('text-gray-500');
            text.classList.add('text-gray-900');
          } else if (step === activeStep) {
            circle.classList.remove('bg-gray-200', 'text-gray-500', 'bg-green-600');
            circle.classList.add('bg-blue-600', 'text-white');
            text.classList.remove('text-gray-500');
            text.classList.add('text-gray-900');
          } else {
            circle.classList.remove('bg-blue-600', 'bg-green-600', 'text-white');
            circle.classList.add('bg-gray-200', 'text-gray-500');
            text.classList.remove('text-gray-900');
            text.classList.add('text-gray-500');
          }
        });
      }
      
      // Configuraci√≥n tienda
      function loadStoreSettings() {
        fetch('/api/store/settings')
          .then(function(r) { return r.ok ? r.json() : Promise.reject(); })
          .then(function(data) {
            storeSettings = data;
            console.log('‚úÖ Config cargada');
            
            var codOption = document.getElementById('payment-cod-option');
            if (storeSettings.payments && storeSettings.payments.cash_on_delivery_enabled) {
              codOption.classList.remove('hidden');
              codOption.classList.add('flex');
              var codCost = storeSettings.payments.cod_extra_cost || 0;
              if (codCost > 0) {
                document.getElementById('cod-extra-cost').textContent = '+' + formatPrice(codCost);
              }
            }
            updateShippingPrices();
            updateTotals();
          })
          .catch(function(e) { console.error('Error config:', e); });
      }
      
      function updateShippingPrices() {
        if (!storeSettings) return;
        var s = storeSettings.shipping || {};
        var standardEl = document.getElementById('standard-shipping-price');
        var expressEl = document.getElementById('express-shipping-price');
        if (standardEl) standardEl.textContent = formatPrice(s.standard_shipping_cost || 499);
        if (expressEl) expressEl.textContent = formatPrice(s.express_shipping_cost || 999);
      }
      
      // Carrito
      function renderCart() {
        cartItems = getCart();
        var container = document.getElementById('cart-items');
        if (!container) return;
        
        if (cartItems.length === 0) {
          container.innerHTML = '<div class="text-center py-8"><p class="text-gray-500 mb-4">Tu carrito est√° vac√≠o</p><a href="/tienda" class="text-blue-600 hover:underline">Ir a la tienda</a></div>';
          return;
        }
        
        container.innerHTML = cartItems.map(function(item) {
          return '<div class="flex gap-4 pb-4 border-b border-gray-100">' +
            '<img src="' + item.image + '" alt="' + item.name + '" class="w-16 h-20 object-cover rounded-lg" />' +
            '<div class="flex-1 min-w-0"><h4 class="font-medium text-gray-900 truncate">' + item.name + '</h4>' +
            '<p class="text-sm text-gray-500">Talla: ' + item.size + (item.color ? ' | Color: ' + item.color : '') + '</p>' +
            '<div class="flex items-center justify-between mt-1"><span class="text-sm text-gray-600">Cantidad: ' + item.quantity + '</span>' +
            '<span class="font-medium">' + formatPrice(item.price * item.quantity) + '</span></div></div></div>';
        }).join('');
        updateTotals();
      }
      
      // Totales
      function calculateTotals() {
        var subtotal = cartItems.reduce(function(sum, item) { return sum + item.price * item.quantity; }, 0);
        var freeThreshold = (storeSettings && storeSettings.shipping) ? storeSettings.shipping.free_shipping_threshold : 10000;
        var shipping = 0;
        
        if (subtotal < freeThreshold) {
          var s = storeSettings && storeSettings.shipping;
          shipping = selectedShippingMethod === 'express' ? (s ? s.express_shipping_cost : 999) : (s ? s.standard_shipping_cost : 499);
        }
        
        var discount = appliedDiscount ? appliedDiscount.amount : 0;
        var paymentMethodEl = document.querySelector('input[name="paymentMethod"]:checked');
        var cod = 0;
        if (paymentMethodEl && paymentMethodEl.value === 'cod' && storeSettings && storeSettings.payments) {
          cod = storeSettings.payments.cod_extra_cost || 0;
        }
        
        return { subtotal: subtotal, shipping: shipping, discount: discount, cod: cod, total: Math.max(0, subtotal - discount + shipping + cod) };
      }
      
      function updateTotals() {
        var t = calculateTotals();
        document.getElementById('subtotal').textContent = formatPrice(t.subtotal);
        document.getElementById('shipping-cost').textContent = t.shipping === 0 ? 'Gratis' : formatPrice(t.shipping);
        document.getElementById('total').textContent = formatPrice(t.total);
        
        var discountRow = document.getElementById('discount-row');
        if (t.discount > 0) {
          discountRow.classList.remove('hidden');
          discountRow.classList.add('flex');
          document.getElementById('discount-amount').textContent = '-' + formatPrice(t.discount);
        } else {
          discountRow.classList.add('hidden');
        }
        
        var codRow = document.getElementById('cod-row');
        if (t.cod > 0) {
          codRow.classList.remove('hidden');
          codRow.classList.add('flex');
          document.getElementById('cod-cost').textContent = formatPrice(t.cod);
        } else {
          codRow.classList.add('hidden');
        }
        
        var freeThreshold = (storeSettings && storeSettings.shipping) ? storeSettings.shipping.free_shipping_threshold : 10000;
        var freeMsg = document.getElementById('free-shipping-msg');
        if (t.subtotal >= freeThreshold) freeMsg.classList.remove('hidden');
        else freeMsg.classList.add('hidden');
        
        var btnPayText = document.getElementById('btn-pay-text');
        if (btnPayText) btnPayText.textContent = 'Pagar ' + formatPrice(t.total);
      }
      
      // Formulario env√≠o
      function setupShippingForm() {
        var form = document.getElementById('shipping-form');
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          if (!form.checkValidity()) { form.reportValidity(); return; }
          
          shippingData = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            postalCode: document.getElementById('postalCode').value,
            city: document.getElementById('city').value,
            province: document.getElementById('province').value,
            country: 'ES',
            shippingMethod: selectedShippingMethod
          };
          localStorage.setItem('fashionmarket-shipping-address', JSON.stringify(shippingData));
          goToStep(2);
        });
        
        document.querySelectorAll('input[name="shippingMethod"]').forEach(function(radio) {
          radio.addEventListener('change', function(e) {
            selectedShippingMethod = e.target.value;
            document.querySelectorAll('.shipping-option').forEach(function(opt) {
              opt.classList.remove('border-blue-600', 'bg-blue-50');
              opt.classList.add('border-gray-200');
            });
            var selected = document.querySelector('.shipping-option[data-method="' + selectedShippingMethod + '"]');
            if (selected) {
              selected.classList.remove('border-gray-200');
              selected.classList.add('border-blue-600', 'bg-blue-50');
            }
            updateTotals();
          });
        });
        
        if (window.USER_EMAIL) document.getElementById('email').value = window.USER_EMAIL;
        
        var saved = localStorage.getItem('fashionmarket-shipping-address');
        if (saved) {
          try {
            var d = JSON.parse(saved);
            if (d.firstName) document.getElementById('firstName').value = d.firstName;
            if (d.lastName) document.getElementById('lastName').value = d.lastName;
            if (d.email) document.getElementById('email').value = d.email;
            if (d.phone) document.getElementById('phone').value = d.phone;
            if (d.address) document.getElementById('address').value = d.address;
            if (d.postalCode) document.getElementById('postalCode').value = d.postalCode;
            if (d.city) document.getElementById('city').value = d.city;
            if (d.province) document.getElementById('province').value = d.province;
          } catch (e) {}
        }
      }
      
      // Stripe
      function initStripe() {
        var key = window.STRIPE_PUBLIC_KEY;
        if (!key) { console.error('No Stripe key'); return; }
        if (stripe) { createPaymentIntent(); return; }
        if (typeof Stripe === 'undefined') { console.error('Stripe.js not loaded'); return; }
        
        try {
          stripe = Stripe(key);
          elements = stripe.elements({ locale: 'es' });
          var style = { base: { fontSize: '16px', color: '#374151', fontFamily: 'system-ui, sans-serif', '::placeholder': { color: '#9CA3AF' } }, invalid: { color: '#DC2626' } };
          
          cardNumber = elements.create('cardNumber', { style: style, showIcon: true });
          cardExpiry = elements.create('cardExpiry', { style: style });
          cardCvc = elements.create('cardCvc', { style: style });
          
          cardNumber.mount('#card-number');
          cardExpiry.mount('#card-expiry');
          cardCvc.mount('#card-cvc');
          
          var errorsEl = document.getElementById('card-errors');
          [cardNumber, cardExpiry, cardCvc].forEach(function(el) {
            el.on('change', function(ev) {
              if (ev.error) { errorsEl.textContent = ev.error.message; errorsEl.classList.remove('hidden'); }
              else { errorsEl.textContent = ''; errorsEl.classList.add('hidden'); }
            });
          });
          
          console.log('‚úÖ Stripe Elements montados');
          createPaymentIntent();
        } catch (err) { console.error('Error Stripe:', err); }
      }
      
      function createPaymentIntent() {
        var t = calculateTotals();
        if (t.total <= 0) return;
        
        fetch('/api/stripe/create-payment-intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: t.total, currency: 'eur', metadata: { customer_email: shippingData ? shippingData.email : '' } })
        })
        .then(function(r) { return r.ok ? r.json() : Promise.reject(); })
        .then(function(data) { clientSecret = data.clientSecret; console.log('‚úÖ Payment Intent creado'); })
        .catch(function(e) { console.error('Error PI:', e); });
      }
      
      function updatePaymentSummary() {
        if (!shippingData) return;
        document.getElementById('shipping-summary').textContent = shippingData.firstName + ' ' + shippingData.lastName + ', ' + shippingData.address + ', ' + shippingData.postalCode + ' ' + shippingData.city;
        document.getElementById('shipping-email-summary').textContent = shippingData.email;
      }
      
      // M√©todos de pago
      function setupPaymentMethods() {
        var cardOption = document.getElementById('payment-card-option');
        var codOption = document.getElementById('payment-cod-option');
        var cardForm = document.getElementById('card-form');
        var codInfo = document.getElementById('cod-info');
        
        document.querySelectorAll('input[name="paymentMethod"]').forEach(function(radio) {
          radio.addEventListener('change', function(e) {
            var v = e.target.value;
            if (v === 'card') {
              cardOption.classList.add('border-blue-600', 'bg-blue-50');
              cardOption.classList.remove('border-gray-200');
              codOption.classList.remove('border-blue-600', 'bg-blue-50');
              codOption.classList.add('border-gray-200');
              cardForm.classList.remove('hidden');
              codInfo.classList.add('hidden');
            } else {
              codOption.classList.add('border-blue-600', 'bg-blue-50');
              codOption.classList.remove('border-gray-200');
              cardOption.classList.remove('border-blue-600', 'bg-blue-50');
              cardOption.classList.add('border-gray-200');
              cardForm.classList.add('hidden');
              codInfo.classList.remove('hidden');
            }
            updateTotals();
          });
        });
      }
      
      // Procesar pago
      function processPayment() {
        var payButton = document.getElementById('btn-pay');
        var payButtonText = document.getElementById('btn-pay-text');
        var errorDiv = document.getElementById('payment-error');
        var errorText = document.getElementById('payment-error-text');
        
        var pmEl = document.querySelector('input[name="paymentMethod"]:checked');
        var pm = pmEl ? pmEl.value : 'card';
        
        payButton.disabled = true;
        payButtonText.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>Procesando...';
        errorDiv.classList.add('hidden');
        
        if (pm === 'cod') {
          createOrder('cash_on_delivery').catch(function(err) { showError(err.message); resetBtn(); });
        } else {
          var name = document.getElementById('cardholderName').value;
          if (!name || !name.trim()) { showError('Introduce el nombre del titular'); resetBtn(); return; }
          if (!stripe || !cardNumber) { showError('Formulario no listo. Recarga la p√°gina.'); resetBtn(); return; }
          if (!clientSecret) { showError('Error iniciando pago. Int√©ntalo de nuevo.'); resetBtn(); return; }
          
          stripe.confirmCardPayment(clientSecret, {
            payment_method: {
              card: cardNumber,
              billing_details: {
                name: name,
                email: shippingData ? shippingData.email : '',
                phone: shippingData ? shippingData.phone : '',
                address: { line1: shippingData ? shippingData.address : '', city: shippingData ? shippingData.city : '', state: shippingData ? shippingData.province : '', postal_code: shippingData ? shippingData.postalCode : '', country: 'ES' }
              }
            }
          }).then(function(result) {
            if (result.error) { showError(translateError(result.error)); resetBtn(); }
            else if (result.paymentIntent && result.paymentIntent.status === 'succeeded') {
              createOrder('card', result.paymentIntent.id).catch(function(err) { showError(err.message); resetBtn(); });
            }
          }).catch(function(err) { showError(err.message); resetBtn(); });
        }
        
        function showError(msg) { errorText.textContent = msg; errorDiv.classList.remove('hidden'); }
        function resetBtn() {
          payButton.disabled = false;
          payButtonText.textContent = 'Pagar ' + formatPrice(calculateTotals().total);
        }
        function translateError(err) {
          var tr = { 'card_declined': 'Tarjeta rechazada', 'expired_card': 'Tarjeta expirada', 'incorrect_cvc': 'CVC incorrecto', 'insufficient_funds': 'Fondos insuficientes', 'incorrect_number': 'N√∫mero incorrecto' };
          return tr[err.code] || err.message || 'Error al procesar';
        }
      }
      
      // Crear pedido
      function createOrder(paymentMethod, paymentIntentId) {
        var t = calculateTotals();
        var orderData = {
          items: cartItems.map(function(i) {
            return { product_id: i.productId, product_name: i.name, product_image: i.image, product_slug: i.slug, quantity: i.quantity, size: i.size, color: i.color || null, unit_price: i.price };
          }),
          shipping_address: { full_name: shippingData.firstName + ' ' + shippingData.lastName, phone: shippingData.phone, address_line1: shippingData.address, city: shippingData.city, province: shippingData.province, postal_code: shippingData.postalCode, country: 'ES' },
          shipping_method: selectedShippingMethod,
          payment_method: paymentMethod,
          payment_intent_id: paymentIntentId,
          discount_code: appliedDiscount ? appliedDiscount.code : null,
          discount_amount: t.discount,
          customer_email: shippingData.email,
          subtotal: t.subtotal,
          shipping_cost: t.shipping,
          cod_extra_cost: t.cod,
          total: t.total
        };
        
        return fetch('/api/orders/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        })
        .then(function(r) {
          if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || 'Error creando pedido'); });
          return r.json();
        })
        .then(function(result) {
          document.getElementById('order-number').textContent = result.order_number;
          document.getElementById('confirmation-email').textContent = shippingData.email;
          clearCart();
          goToStep(3);
        });
      }
      
      // Descuentos
      function setupDiscountCode() {
        var input = document.getElementById('discount-code');
        var btnApply = document.getElementById('btn-apply-discount');
        var btnRemove = document.getElementById('btn-remove-discount');
        var appliedDiv = document.getElementById('discount-applied');
        var discountText = document.getElementById('discount-text');
        
        btnApply.addEventListener('click', function() {
          var code = input.value.trim();
          if (!code) return;
          
          fetch('/api/discount/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code, subtotal: calculateTotals().subtotal })
          })
          .then(function(r) {
            if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || 'C√≥digo no v√°lido'); });
            return r.json();
          })
          .then(function(data) {
            appliedDiscount = { code: data.code, amount: data.discount_amount };
            discountText.textContent = data.code + ': -' + formatPrice(data.discount_amount);
            appliedDiv.classList.remove('hidden');
            input.value = '';
            updateTotals();
          })
          .catch(function(err) { alert(err.message); });
        });
        
        btnRemove.addEventListener('click', function() {
          appliedDiscount = null;
          appliedDiv.classList.add('hidden');
          updateTotals();
        });
      }
      
      // Init
      function init() {
        console.log('üöÄ Checkout iniciando...');
        cartItems = getCart();
        if (cartItems.length === 0) { renderCart(); return; }
        
        loadStoreSettings();
        renderCart();
        setupShippingForm();
        setupPaymentMethods();
        setupDiscountCode();
        document.getElementById('btn-pay').addEventListener('click', processPayment);
        console.log('‚úÖ Checkout listo');
      }
      
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
      else init();
    })();
  </script>
</BaseLayout>

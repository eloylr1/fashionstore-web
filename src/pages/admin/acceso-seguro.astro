---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Login de Administrador (SECRETO)
 * Acceso exclusivo para administradores - URL no pública
 * Ruta: /admin/acceso-seguro
 * ═══════════════════════════════════════════════════════════════════════════
 */

export const prerender = false; // SSR

import '../../styles/global.css';

// Si ya está autenticado como admin, redirigir al panel
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const userRole = Astro.cookies.get('user-role')?.value;

if (accessToken && userRole === 'admin') {
  return Astro.redirect('/admin');
}
---

<!doctype html>
<html lang="es" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Acceso Administrador | FashionMarket</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  
  <body class="min-h-screen bg-gradient-to-br from-navy-900 via-navy-800 to-charcoal-900 flex items-center justify-center p-4">
    <!-- Background Pattern -->
    <div class="absolute inset-0 opacity-5">
      <div class="absolute inset-0 bg-pattern"></div>
    </div>

    <div class="relative w-full max-w-md">
      <!-- Security Badge -->
      <div class="flex justify-center mb-6">
        <div class="bg-red-500/20 border border-red-500/30 rounded-full px-4 py-2 flex items-center gap-2">
          <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          <span class="text-red-400 text-xs font-medium uppercase tracking-wider">Acceso Restringido</span>
        </div>
      </div>

      <!-- Logo -->
      <div class="text-center mb-8">
        <span class="font-serif text-3xl font-semibold text-white tracking-tight">
          Fashion<span class="text-gold-matte">Market</span>
        </span>
        <p class="text-white/50 text-sm mt-2">Panel de Administración</p>
      </div>
      
      <!-- Login Card -->
      <div class="bg-white/10 backdrop-blur-xl rounded-2xl p-8 border border-white/10 shadow-2xl">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-12 h-12 bg-gold-matte/20 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-gold-matte" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-semibold text-white">Acceso Administrador</h1>
            <p class="text-white/50 text-sm">Solo personal autorizado</p>
          </div>
        </div>
        
        <!-- Error Message -->
        <div id="error-message" class="hidden mb-6 p-4 bg-red-500/20 border border-red-500/30 rounded-lg text-red-300 text-sm">
        </div>

        <!-- Success Message -->
        <div id="success-message" class="hidden mb-6 p-4 bg-green-500/20 border border-green-500/30 rounded-lg text-green-300 text-sm">
        </div>
        
        <!-- Login Form -->
        <form id="admin-login-form" class="space-y-5">
          <div>
            <label for="email" class="block text-sm font-medium text-white/70 mb-2">
              Correo electrónico
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="w-5 h-5 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" />
                </svg>
              </div>
              <input 
                type="email" 
                id="email" 
                name="email"
                required
                autocomplete="email"
                class="w-full pl-12 pr-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/30 focus:outline-none focus:ring-2 focus:ring-gold-matte/50 focus:border-gold-matte/50 transition-all"
                placeholder="admin@fashionmarket.com"
              />
            </div>
          </div>
          
          <div>
            <label for="password" class="block text-sm font-medium text-white/70 mb-2">
              Contraseña
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="w-5 h-5 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
              </div>
              <input 
                type="password" 
                id="password" 
                name="password"
                required
                autocomplete="current-password"
                class="w-full pl-12 pr-12 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/30 focus:outline-none focus:ring-2 focus:ring-gold-matte/50 focus:border-gold-matte/50 transition-all"
                placeholder="••••••••••••"
              />
              <button 
                type="button" 
                id="toggle-password"
                class="absolute inset-y-0 right-0 pr-4 flex items-center text-white/30 hover:text-white/60 transition-colors"
              >
                <svg id="eye-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
              </button>
            </div>
          </div>
          
          <button 
            type="submit"
            id="submit-btn"
            class="w-full py-3.5 px-4 bg-gradient-to-r from-gold-matte to-yellow-600 text-navy-900 rounded-lg font-semibold transition-all duration-200 hover:shadow-lg hover:shadow-gold-matte/25 focus:outline-none focus:ring-2 focus:ring-gold-matte/50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
            </svg>
            <span>Acceder al Panel</span>
          </button>
        </form>

        <!-- Security Notice -->
        <div class="mt-6 pt-6 border-t border-white/10">
          <div class="flex items-start gap-3 text-white/40 text-xs">
            <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p>Esta página es de acceso restringido. Todos los intentos de acceso son registrados por motivos de seguridad.</p>
          </div>
        </div>
      </div>
      
      <!-- Back Link -->
      <div class="mt-6 text-center">
        <a href="/" class="text-white/40 hover:text-white/60 text-sm transition-colors">
          ← Volver a la tienda
        </a>
      </div>
    </div>
    
    <script>
      import { createClient } from '@supabase/supabase-js';
      
      const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
      const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
      const supabase = createClient(supabaseUrl, supabaseAnonKey);
      
      const form = document.getElementById('admin-login-form') as HTMLFormElement;
      const errorMessage = document.getElementById('error-message');
      const successMessage = document.getElementById('success-message');
      const submitBtn = document.getElementById('submit-btn');
      const togglePassword = document.getElementById('toggle-password');
      const passwordInput = document.getElementById('password') as HTMLInputElement;
      
      // Toggle password visibility
      togglePassword?.addEventListener('click', () => {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;
      });
      
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = (document.getElementById('email') as HTMLInputElement).value;
        const password = (document.getElementById('password') as HTMLInputElement).value;
        
        // Hide messages
        errorMessage?.classList.add('hidden');
        successMessage?.classList.add('hidden');
        
        // Disable button
        if (submitBtn) {
          submitBtn.setAttribute('disabled', 'true');
          submitBtn.innerHTML = `
            <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Verificando credenciales...</span>
          `;
        }
        
        try {
          // Try to sign in
          const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
            email,
            password,
          });
          
          if (authError) throw authError;
          
          if (!authData.user) {
            throw new Error('No se pudo obtener información del usuario');
          }
          
          // Check if user is admin
          const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('role, full_name')
            .eq('id', authData.user.id)
            .single();
          
          if (profileError) throw profileError;
          
          if (profile?.role !== 'admin') {
            // Sign out if not admin
            await supabase.auth.signOut();
            throw new Error('Acceso denegado. Solo administradores pueden acceder a esta página.');
          }
          
          // Set cookies
          const maxAge = 60 * 60 * 24 * 7; // 7 days
          document.cookie = `sb-access-token=${authData.session?.access_token}; path=/; max-age=${maxAge}; SameSite=Lax`;
          document.cookie = `sb-refresh-token=${authData.session?.refresh_token}; path=/; max-age=${maxAge}; SameSite=Lax`;
          document.cookie = `user-role=${profile.role}; path=/; max-age=${maxAge}; SameSite=Lax`;
          
          // Save name to localStorage
          if (profile.full_name) {
            localStorage.setItem('user-name', profile.full_name);
          }
          
          // Show success
          if (successMessage) {
            successMessage.textContent = '✓ Acceso autorizado. Redirigiendo al panel...';
            successMessage.classList.remove('hidden');
          }
          
          // Redirect to admin panel
          setTimeout(() => {
            window.location.href = '/admin';
          }, 1000);
          
        } catch (error: any) {
          console.error('Admin login error:', error);
          
          if (errorMessage) {
            if (error.message.includes('Invalid login credentials')) {
              errorMessage.textContent = 'Credenciales incorrectas. Verifica tu email y contraseña.';
            } else if (error.message.includes('Acceso denegado')) {
              errorMessage.textContent = error.message;
            } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
              errorMessage.textContent = 'Error de conexión con el servidor. Verifica tu conexión a internet.';
            } else if (error.message.includes('Email not confirmed')) {
              errorMessage.textContent = 'Email no confirmado. Revisa tu bandeja de entrada.';
            } else {
              errorMessage.textContent = `Error: ${error.message}`;
            }
            errorMessage.classList.remove('hidden');
          }
          
          // Re-enable button
          if (submitBtn) {
            submitBtn.removeAttribute('disabled');
            submitBtn.innerHTML = `
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
              </svg>
              <span>Acceder al Panel</span>
            `;
          }
        }
      });
    </script>
  </body>
</html>

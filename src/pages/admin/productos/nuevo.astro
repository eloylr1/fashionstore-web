---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Admin New Product
 * Formulario de creación de producto (SSR Protegido)
 * ═══════════════════════════════════════════════════════════════════════════
 */

export const prerender = false; // SSR

import AdminLayout from '../../../layouts/AdminLayout.astro';
import ImageUploader from '../../../components/admin/ImageUploader';
import { supabaseAdmin, isSupabaseAdminConfigured } from '../../../lib/supabase/server';

// La autenticación ya está verificada por el middleware

// Datos de demostración
let categories: any[] = [
  { id: '1', name: 'Trajes', slug: 'trajes', image_url: '/placeholder-category.svg', description: 'Trajes de vestir premium' },
  { id: '2', name: 'Camisas', slug: 'camisas', image_url: '/placeholder-category.svg', description: 'Camisas de alta calidad' },
  { id: '3', name: 'Accesorios', slug: 'accesorios', image_url: '/placeholder-category.svg', description: 'Complementos elegantes' },
];

// Obtener categorías reales para el select
if (isSupabaseAdminConfigured() && supabaseAdmin) {
  const { data: realCategories, error } = await supabaseAdmin
    .from('categories')
    .select('*')
    .order('name');
  
  if (error) console.error('Error fetching categories:', error);
  if (realCategories?.length) categories = realCategories;
}

// Tallas por defecto (ropa)
const defaultSizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];

// Mapeo de categorías a tipos de talla
const categorySizeTypes: Record<string, string> = {
  'pantalones': 'pantalones',
  'zapatos-de-vestir': 'zapatos',
  'calcetines': 'calcetines',
  'cinturones': 'cinturones',
  'corbatas': 'unica',
  'panuelos': 'unica',
  'gemelos': 'unica',
  'tirantes': 'unica',
};

// Opciones de tallas por tipo
const sizeOptions: Record<string, string[]> = {
  'ropa': ['XS', 'S', 'M', 'L', 'XL', 'XXL'],
  'pantalones': ['46', '48', '50', '52', '54', '56'],
  'zapatos': ['39', '40', '41', '42', '43', '44', '45'],
  'calcetines': ['39-42', '43-46'],
  'cinturones': ['85', '90', '95', '100', '105', '110'],
  'unica': ['Única'],
};
---

<AdminLayout title="Nuevo Producto">
  <div class="max-w-4xl">
    <!-- Back -->
    <a 
      href="/admin/productos"
      class="inline-flex items-center gap-2 text-sm text-charcoal-600 hover:text-navy-900 transition-colors mb-6"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Volver a productos
    </a>
    
    <form id="product-form" class="space-y-8">
      <!-- Basic Info -->
      <div class="bg-white border border-charcoal-100 p-6">
        <h2 class="font-medium text-navy-900 mb-6">Información básica</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2">
            <label for="name" class="block text-sm font-medium text-charcoal-700 mb-2">
              Nombre del producto *
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="input-elegant"
              placeholder="Ej: Camisa Oxford Clásica"
            />
          </div>
          
          <div>
            <label for="slug" class="block text-sm font-medium text-charcoal-700 mb-2">
              Slug (URL) *
            </label>
            <input
              type="text"
              id="slug"
              name="slug"
              required
              pattern="^[a-z0-9]+(?:-[a-z0-9]+)*$"
              class="input-elegant"
              placeholder="camisa-oxford-clasica"
            />
            <p class="text-xs text-charcoal-400 mt-1">
              Solo letras minúsculas, números y guiones
            </p>
          </div>
          
          <div>
            <label for="category_id" class="block text-sm font-medium text-charcoal-700 mb-2">
              Categoría *
            </label>
            <select
              id="category_id"
              name="category_id"
              required
              class="select-elegant"
            >
              <option value="">Seleccionar categoría</option>
              {categories?.map((cat) => (
                <option value={cat.id} data-slug={cat.slug}>{cat.name}</option>
              ))}
            </select>
          </div>
          
          <div class="md:col-span-2">
            <label for="description" class="block text-sm font-medium text-charcoal-700 mb-2">
              Descripción *
            </label>
            <textarea
              id="description"
              name="description"
              required
              rows="4"
              class="input-elegant resize-none"
              placeholder="Describe el producto en detalle..."
            ></textarea>
          </div>
        </div>
      </div>
      
      <!-- Pricing & Stock -->
      <div class="bg-white border border-charcoal-100 p-6">
        <h2 class="font-medium text-navy-900 mb-6">Precio e inventario</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label for="price" class="block text-sm font-medium text-charcoal-700 mb-2">
              Precio (€) *
            </label>
            <input
              type="number"
              id="price"
              name="price"
              required
              min="0"
              step="0.01"
              class="input-elegant"
              placeholder="59.99"
            />
            <p class="text-xs text-charcoal-400 mt-1">
              Se guardará en céntimos
            </p>
          </div>
          
          <div>
            <label for="stock" class="block text-sm font-medium text-charcoal-700 mb-2">
              Stock *
            </label>
            <input
              type="number"
              id="stock"
              name="stock"
              required
              min="0"
              class="input-elegant"
              placeholder="50"
            />
          </div>
          
          <div class="flex items-end">
            <label class="flex items-center gap-3 cursor-pointer">
              <input
                type="checkbox"
                id="featured"
                name="featured"
                class="w-5 h-5 text-navy-900 border-charcoal-300 rounded focus:ring-navy-700"
              />
              <span class="text-sm font-medium text-charcoal-700">
                Producto destacado
              </span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Sizes & Details -->
      <div class="bg-white border border-charcoal-100 p-6">
        <h2 class="font-medium text-navy-900 mb-6">Tallas y detalles</h2>
        
        <div class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-charcoal-700 mb-3">
              Tallas disponibles *
              <span id="size-type-label" class="text-xs font-normal text-charcoal-400 ml-2">(Ropa)</span>
            </label>
            <div id="sizes-container" class="flex flex-wrap gap-3">
              {defaultSizes.map((size) => (
                <label class="cursor-pointer size-option">
                  <input
                    type="checkbox"
                    name="sizes"
                    value={size}
                    class="peer sr-only"
                  />
                  <span class="inline-flex items-center justify-center min-w-[48px] h-12 px-3 border border-charcoal-200 text-sm font-medium text-charcoal-600 peer-checked:border-navy-900 peer-checked:bg-navy-900 peer-checked:text-white transition-colors">
                    {size}
                  </span>
                </label>
              ))}
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="colors" class="block text-sm font-medium text-charcoal-700 mb-2">
                Colores <span class="text-charcoal-400">(separados por coma)</span>
              </label>
              <input
                type="text"
                id="colors"
                name="colors"
                class="input-elegant"
                placeholder="Ej: Azul marino, Gris carbón, Negro"
              />
            </div>
            
            <div>
              <label for="material" class="block text-sm font-medium text-charcoal-700 mb-2">
                Material
              </label>
              <input
                type="text"
                id="material"
                name="material"
                class="input-elegant"
                placeholder="Ej: 100% Algodón"
              />
            </div>
          </div>
        </div>
      </div>
      
      <!-- Images -->
      <div class="bg-white border border-charcoal-100 p-6">
        <ImageUploader client:load onImagesChange={() => {}} />
        <input type="hidden" id="images" name="images" value="[]" />
      </div>
      
      <!-- Submit -->
      <div class="flex items-center justify-end gap-4">
        <a href="/admin/productos" class="btn-secondary">
          Cancelar
        </a>
        <button type="submit" class="btn-primary" id="submit-btn">
          Crear producto
        </button>
      </div>
    </form>
  </div>
  
  <script>
    // Configuración de tallas por categoría (soporta múltiples variantes de slug)
    const categorySizeTypes: Record<string, string> = {
      // Pantalones
      'pantalones': 'pantalones',
      // Zapatos - todas las variantes posibles
      'zapatos-de-vestir': 'zapatos',
      'zapatos-vestir': 'zapatos',
      'zapatos': 'zapatos',
      // Calcetines
      'calcetines': 'calcetines',
      // Cinturones
      'cinturones': 'cinturones',
      // Talla única
      'corbatas': 'unica',
      'panuelos': 'unica',
      'gemelos': 'unica',
      'tirantes': 'unica',
    };

    // Palabras clave para detectar categoría por nombre (fallback)
    const categoryKeywords: Record<string, string> = {
      'zapato': 'zapatos',
      'calcetin': 'calcetines',
      'cinturon': 'cinturones',
      'pantalon': 'pantalones',
      'corbata': 'unica',
      'pañuelo': 'unica',
      'panuelo': 'unica',
      'gemelo': 'unica',
      'tirante': 'unica',
    };

    const sizeOptions: Record<string, { sizes: string[], label: string }> = {
      'ropa': { sizes: ['XS', 'S', 'M', 'L', 'XL', 'XXL'], label: 'Ropa' },
      'pantalones': { sizes: ['46', '48', '50', '52', '54', '56'], label: 'Talla europea' },
      'zapatos': { sizes: ['39', '40', '41', '42', '43', '44', '45'], label: 'Número de pie' },
      'calcetines': { sizes: ['39-42', '43-46'], label: 'Rango de talla' },
      'cinturones': { sizes: ['85', '90', '95', '100', '105', '110'], label: 'Centímetros' },
      'unica': { sizes: ['Única'], label: 'Talla única' },
    };

    // Elementos del DOM
    const categorySelect = document.getElementById('category_id') as HTMLSelectElement;
    const sizesContainer = document.getElementById('sizes-container') as HTMLDivElement;
    const sizeTypeLabel = document.getElementById('size-type-label') as HTMLSpanElement;

    // Función para detectar el tipo de talla
    function getSizeType(slug: string, categoryName: string): string {
      // Primero intentar por slug
      if (categorySizeTypes[slug]) {
        return categorySizeTypes[slug];
      }
      
      // Si no, buscar por palabra clave en el nombre
      const nameLower = categoryName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      for (const [keyword, type] of Object.entries(categoryKeywords)) {
        if (nameLower.includes(keyword)) {
          return type;
        }
      }
      
      // Por defecto, ropa
      return 'ropa';
    }

    // Función para actualizar las tallas según la categoría
    function updateSizesForCategory(categorySlug: string, categoryName: string) {
      const sizeType = getSizeType(categorySlug, categoryName);
      const { sizes, label } = sizeOptions[sizeType];
      
      console.log('Categoría:', categoryName, '| Slug:', categorySlug, '| Tipo talla:', sizeType);
      
      // Actualizar etiqueta
      sizeTypeLabel.textContent = `(${label})`;
      
      // Generar nuevos checkboxes
      sizesContainer.innerHTML = sizes.map(size => `
        <label class="cursor-pointer size-option">
          <input
            type="checkbox"
            name="sizes"
            value="${size}"
            class="peer sr-only"
          />
          <span class="inline-flex items-center justify-center min-w-[48px] h-12 px-3 border border-charcoal-200 text-sm font-medium text-charcoal-600 peer-checked:border-navy-900 peer-checked:bg-navy-900 peer-checked:text-white transition-colors">
            ${size}
          </span>
        </label>
      `).join('');
      
      // Si es talla única, seleccionarla automáticamente
      if (sizeType === 'unica') {
        const checkbox = sizesContainer.querySelector('input[type="checkbox"]') as HTMLInputElement;
        if (checkbox) checkbox.checked = true;
      }
    }

    // Evento de cambio de categoría
    categorySelect.addEventListener('change', () => {
      const selectedOption = categorySelect.options[categorySelect.selectedIndex];
      const slug = selectedOption.dataset.slug || '';
      const name = selectedOption.textContent || '';
      updateSizesForCategory(slug, name);
    });

    // Auto-generate slug from name
    const nameInput = document.getElementById('name') as HTMLInputElement;
    const slugInput = document.getElementById('slug') as HTMLInputElement;
    
    nameInput.addEventListener('input', () => {
      const slug = nameInput.value
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
      
      slugInput.value = slug;
    });
    
    // Form submission
    const form = document.getElementById('product-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creando...';
      
      try {
        const formData = new FormData(form);
        
        // Get selected sizes
        const sizes = Array.from(
          document.querySelectorAll('input[name="sizes"]:checked')
        ).map((input) => (input as HTMLInputElement).value);
        
        if (sizes.length === 0) {
          throw new Error('Selecciona al menos una talla');
        }
        
        // Get images from ImageUploader (stored in hidden input)
        const imagesInput = document.getElementById('images') as HTMLInputElement;
        const images = JSON.parse(imagesInput.value || '[]');
        
        // Get colors from input (comma-separated)
        const colorsInput = formData.get('colors') as string;
        const colors = colorsInput ? colorsInput.split(',').map(c => c.trim()).filter(Boolean) : [];
        
        // Convert price to cents
        const priceInEuros = parseFloat(formData.get('price') as string);
        const priceInCents = Math.round(priceInEuros * 100);
        
        const productData = {
          name: formData.get('name') as string,
          slug: formData.get('slug') as string,
          description: formData.get('description') as string,
          category_id: formData.get('category_id') as string,
          price: priceInCents,
          stock: parseInt(formData.get('stock') as string),
          featured: formData.get('featured') === 'on',
          sizes,
          colors,
          material: (formData.get('material') as string) || null,
          images,
        };
        
        console.log('Creando producto:', productData);
        
        // Usar la API en lugar de Supabase directamente
        const response = await fetch('/api/admin/products', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(productData)
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'Error al crear el producto');
        }
        
        window.location.href = '/admin/productos';
      } catch (error: any) {
        alert(error.message || 'Error al crear el producto');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Crear producto';
      }
    });
    
    // Listen for image changes from ImageUploader
    window.addEventListener('imagesUpdated', ((e: CustomEvent) => {
      const imagesInput = document.getElementById('images') as HTMLInputElement;
      imagesInput.value = JSON.stringify(e.detail);
    }) as EventListener);
  </script>
</AdminLayout>

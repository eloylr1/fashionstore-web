---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Admin Categories
 * Gestión de categorías de productos con modales profesionales
 * ═══════════════════════════════════════════════════════════════════════════
 */

export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';
import CategoriesManager from '../../../components/admin/CategoriesManager.tsx';
import { supabaseAdmin, isSupabaseAdminConfigured } from '../../../lib/supabase/server';

// La autenticación ya está verificada por el middleware

// Obtener categorías
let categories: any[] = [];
let productsPerCategory: Record<string, number> = {};

if (isSupabaseAdminConfigured() && supabaseAdmin) {
  try {
    const { data, error } = await supabaseAdmin
      .from('categories')
      .select('*')
      .order('name', { ascending: true });
    
    if (error) console.error('Error fetching categories:', error);
    categories = data || [];

    // Contar productos por categoría
    for (const cat of categories) {
      const { count } = await supabaseAdmin
        .from('products')
        .select('*', { count: 'exact', head: true })
        .eq('category_id', cat.id);
      productsPerCategory[cat.id] = count || 0;
    }
  } catch (error) {
    console.error('Error fetching categories:', error);
  }
}

// Preparar datos para el componente React
const categoriesWithCount = categories.map(cat => ({
  id: cat.id,
  name: cat.name,
  slug: cat.slug,
  productCount: productsPerCategory[cat.id] || 0
}));
---

<AdminLayout title="Categorías">
  <CategoriesManager client:load initialCategories={categoriesWithCount} />
</AdminLayout>

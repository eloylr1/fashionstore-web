---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Admin Categories
 * Gestión de categorías de productos con modales profesionales
 * ═══════════════════════════════════════════════════════════════════════════
 */

export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';
import CategoriesManager from '../../../components/admin/CategoriesManager.tsx';
import { supabase, isSupabaseConfigured } from '../../../lib/supabase/client';

// Verificar autenticación
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const userRole = Astro.cookies.get('user-role')?.value;

if (!accessToken || userRole !== 'admin') {
  return Astro.redirect('/admin/acceso-seguro');
}

// Obtener categorías
let categories: any[] = [];
let productsPerCategory: Record<string, number> = {};

if (isSupabaseConfigured() && supabase) {
  try {
    const { data } = await supabase
      .from('categories')
      .select('*')
      .order('name', { ascending: true });
    
    categories = data || [];

    // Contar productos por categoría
    for (const cat of categories) {
      const { count } = await supabase
        .from('products')
        .select('*', { count: 'exact', head: true })
        .eq('category_id', cat.id);
      productsPerCategory[cat.id] = count || 0;
    }
  } catch (error) {
    console.error('Error fetching categories:', error);
  }
}

// Preparar datos para el componente React
const categoriesWithCount = categories.map(cat => ({
  id: cat.id,
  name: cat.name,
  slug: cat.slug,
  productCount: productsPerCategory[cat.id] || 0
}));
---

<AdminLayout title="Categorías">
  <CategoriesManager client:load initialCategories={categoriesWithCount} />
</AdminLayout>

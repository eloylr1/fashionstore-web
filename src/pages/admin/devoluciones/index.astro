---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Admin: Gestión de Devoluciones
 * Lista todas las devoluciones con filtros y acciones
 * ═══════════════════════════════════════════════════════════════════════════
 */

export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseAdmin, isSupabaseAdminConfigured } from '../../../lib/supabase/server';

let returns: any[] = [];

if (isSupabaseAdminConfigured() && supabaseAdmin) {
  try {
    const { data, error } = await supabaseAdmin
      .from('returns')
      .select(`
        *,
        orders (order_number, total)
      `)
      .order('created_at', { ascending: false });
    
    if (error) console.error('Error fetching returns:', error);
    returns = data || [];

    // Obtener perfiles de los usuarios de las devoluciones
    if (returns.length > 0) {
      const userIds = [...new Set(returns.map((r: any) => r.user_id).filter(Boolean))];
      if (userIds.length > 0) {
        const { data: profiles } = await supabaseAdmin
          .from('profiles')
          .select('id, full_name, email')
          .in('id', userIds);

        const profileMap = new Map((profiles || []).map((p: any) => [p.id, p]));
        returns = returns.map((ret: any) => ({
          ...ret,
          profiles: profileMap.get(ret.user_id) || null,
        }));
      }
    }
  } catch (error) {
    console.error('Error fetching returns:', error);
  }
}

function formatDate(dateString: string) {
  return new Date(dateString).toLocaleDateString('es-ES', {
    day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
  });
}

const returnStatuses: Record<string, { label: string; color: string; bg: string }> = {
  'requested': { label: 'Pendiente', color: 'text-amber-700', bg: 'bg-amber-100' },
  'approved': { label: 'Aprobada', color: 'text-blue-700', bg: 'bg-blue-100' },
  'in_transit': { label: 'En tránsito', color: 'text-purple-700', bg: 'bg-purple-100' },
  'received': { label: 'Recibida', color: 'text-indigo-700', bg: 'bg-indigo-100' },
  'refunded': { label: 'Reembolsada', color: 'text-green-700', bg: 'bg-green-100' },
  'rejected': { label: 'Rechazada', color: 'text-red-700', bg: 'bg-red-100' },
};

const reasonLabels: Record<string, string> = {
  wrong_size: 'Talla incorrecta',
  defective: 'Defectuoso',
  not_as_described: 'No coincide',
  changed_mind: 'Cambio de opinión',
  other: 'Otro',
};

// Contadores por estado
const pendingCount = returns.filter(r => r.status === 'requested').length;
const approvedCount = returns.filter(r => r.status === 'approved').length;
const totalCount = returns.length;
---

<AdminLayout title="Devoluciones">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <p class="text-charcoal-500">
          {totalCount} devoluciones en total
          {pendingCount > 0 && <span class="ml-2 px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-medium rounded-full">{pendingCount} pendientes</span>}
        </p>
      </div>
      
      <div class="flex items-center gap-3">
        <select 
          id="status-filter"
          class="px-4 py-2 border border-charcoal-200 text-sm focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none"
        >
          <option value="">Todos los estados</option>
          <option value="requested">Pendientes</option>
          <option value="approved">Aprobadas</option>
          <option value="in_transit">En tránsito</option>
          <option value="received">Recibidas</option>
          <option value="refunded">Reembolsadas</option>
          <option value="rejected">Rechazadas</option>
        </select>
      </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
      <div class="bg-white border border-charcoal-100 p-4">
        <p class="text-2xl font-bold text-amber-600">{pendingCount}</p>
        <p class="text-xs text-charcoal-500 mt-1">Pendientes de revisión</p>
      </div>
      <div class="bg-white border border-charcoal-100 p-4">
        <p class="text-2xl font-bold text-blue-600">{approvedCount}</p>
        <p class="text-xs text-charcoal-500 mt-1">Aprobadas</p>
      </div>
      <div class="bg-white border border-charcoal-100 p-4">
        <p class="text-2xl font-bold text-green-600">{returns.filter(r => r.status === 'refunded').length}</p>
        <p class="text-xs text-charcoal-500 mt-1">Reembolsadas</p>
      </div>
      <div class="bg-white border border-charcoal-100 p-4">
        <p class="text-2xl font-bold text-red-600">{returns.filter(r => r.status === 'rejected').length}</p>
        <p class="text-xs text-charcoal-500 mt-1">Rechazadas</p>
      </div>
    </div>

    <!-- Tabla -->
    {returns.length > 0 ? (
      <div class="bg-white border border-charcoal-100 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="bg-charcoal-50 border-b border-charcoal-100">
                <th class="text-left px-6 py-4 text-xs font-semibold uppercase tracking-wider text-charcoal-600">Devolución</th>
                <th class="text-left px-6 py-4 text-xs font-semibold uppercase tracking-wider text-charcoal-600">Cliente</th>
                <th class="text-left px-6 py-4 text-xs font-semibold uppercase tracking-wider text-charcoal-600">Pedido</th>
                <th class="text-left px-6 py-4 text-xs font-semibold uppercase tracking-wider text-charcoal-600">Motivo</th>
                <th class="text-left px-6 py-4 text-xs font-semibold uppercase tracking-wider text-charcoal-600">Importe</th>
                <th class="text-left px-6 py-4 text-xs font-semibold uppercase tracking-wider text-charcoal-600">Estado</th>
                <th class="text-left px-6 py-4 text-xs font-semibold uppercase tracking-wider text-charcoal-600">Fecha</th>
                <th class="text-right px-6 py-4 text-xs font-semibold uppercase tracking-wider text-charcoal-600">Acciones</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-charcoal-100">
              {returns.map((ret) => {
                const status = returnStatuses[ret.status] || returnStatuses['requested'];
                return (
                  <tr class="hover:bg-charcoal-50/50 transition-colors return-row" data-status={ret.status}>
                    <td class="px-6 py-4">
                      <p class="text-sm font-semibold text-navy-900 font-mono">{ret.return_number}</p>
                    </td>
                    <td class="px-6 py-4">
                      <div>
                        <p class="text-sm font-medium text-charcoal-700">{ret.profiles?.full_name || 'Sin nombre'}</p>
                        <p class="text-xs text-charcoal-400">{ret.profiles?.email || ''}</p>
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <a href={`/admin/pedidos/${ret.order_id}`} class="text-sm text-navy-700 hover:text-leather font-mono underline">
                        {ret.orders?.order_number || 'N/A'}
                      </a>
                    </td>
                    <td class="px-6 py-4">
                      <span class="text-sm text-charcoal-600">{reasonLabels[ret.reason] || ret.reason}</span>
                    </td>
                    <td class="px-6 py-4">
                      <span class="text-sm font-semibold text-navy-900">
                        {ret.refund_amount ? (ret.refund_amount / 100).toFixed(2) + '€' : '-'}
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <span class={`inline-flex items-center gap-1.5 px-3 py-1 text-xs font-medium rounded-full ${status.bg} ${status.color}`}>
                        <span class="w-1.5 h-1.5 rounded-full bg-current"></span>
                        {status.label}
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <span class="text-sm text-charcoal-600">{formatDate(ret.created_at)}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <div class="flex items-center justify-end gap-2">
                        <a 
                          href={`/admin/devoluciones/${ret.id}`}
                          class="p-2 text-charcoal-400 hover:text-navy-700 hover:bg-navy-50 transition-colors"
                          title="Ver detalles"
                        >
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                          </svg>
                        </a>
                        
                        {ret.status === 'requested' && (
                          <>
                            <button
                              data-return-id={ret.id}
                              data-action="approve"
                              class="action-btn p-2 text-green-600 hover:bg-green-50 transition-colors rounded"
                              title="Aprobar"
                            >
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                              </svg>
                            </button>
                            <button
                              data-return-id={ret.id}
                              data-action="reject"
                              class="action-btn p-2 text-red-600 hover:bg-red-50 transition-colors rounded"
                              title="Rechazar"
                            >
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>
                          </>
                        )}
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    ) : (
      <div class="bg-white border border-charcoal-100 p-12 text-center">
        <div class="w-16 h-16 mx-auto bg-charcoal-100 flex items-center justify-center mb-4 rounded-full">
          <svg class="w-8 h-8 text-charcoal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
          </svg>
        </div>
        <h4 class="text-lg font-medium text-navy-900 mb-2">No hay devoluciones</h4>
        <p class="text-charcoal-500">Las solicitudes de devolución de los clientes aparecerán aquí</p>
      </div>
    )}
  </div>

  <!-- Modal de confirmación -->
  <div id="action-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="action-modal-backdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
        <div class="p-6">
          <div id="modal-icon-approve" class="hidden">
            <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-full bg-green-100">
              <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
          </div>
          <div id="modal-icon-reject" class="hidden">
            <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-full bg-red-100">
              <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
          </div>
          
          <h3 id="modal-title" class="text-xl font-serif text-navy-900 text-center mb-4"></h3>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-charcoal-700 mb-2">Nota para el cliente (opcional)</label>
            <textarea 
              id="admin-notes" 
              rows="3"
              class="w-full px-4 py-3 border border-charcoal-200 rounded-lg focus:border-navy-500 focus:ring-2 focus:ring-navy-500/20 outline-none text-sm resize-none"
              placeholder="Escribe un mensaje para el cliente..."
            ></textarea>
          </div>

          <div id="modal-error" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm text-center"></div>

          <div class="flex gap-3">
            <button type="button" id="modal-cancel" class="flex-1 px-4 py-3 border border-charcoal-200 rounded-lg text-charcoal-700 hover:bg-charcoal-50 transition-colors font-medium">
              Cancelar
            </button>
            <button type="button" id="modal-confirm" class="flex-1 px-4 py-3 rounded-lg text-white font-medium flex items-center justify-center gap-2">
              <span id="modal-confirm-text"></span>
              <svg id="modal-spinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // Filtro por estado
  const statusFilter = document.getElementById('status-filter') as HTMLSelectElement;
  statusFilter?.addEventListener('change', () => {
    const val = statusFilter.value;
    document.querySelectorAll('.return-row').forEach(row => {
      const rowStatus = row.getAttribute('data-status');
      (row as HTMLElement).style.display = (!val || rowStatus === val) ? '' : 'none';
    });
  });

  // Modal de acción
  const modal = document.getElementById('action-modal')!;
  const modalTitle = document.getElementById('modal-title')!;
  const modalConfirm = document.getElementById('modal-confirm')!;
  const modalConfirmText = document.getElementById('modal-confirm-text')!;
  const modalSpinner = document.getElementById('modal-spinner')!;
  const modalError = document.getElementById('modal-error')!;
  const adminNotes = document.getElementById('admin-notes') as HTMLTextAreaElement;
  const iconApprove = document.getElementById('modal-icon-approve')!;
  const iconReject = document.getElementById('modal-icon-reject')!;

  let currentReturnId = '';
  let currentAction = '';

  function openModal(returnId: string, action: string) {
    currentReturnId = returnId;
    currentAction = action;
    modalError.classList.add('hidden');
    adminNotes.value = '';

    if (action === 'approve') {
      modalTitle.textContent = '¿Aprobar esta devolución?';
      modalConfirmText.textContent = 'Aprobar';
      modalConfirm.className = 'flex-1 px-4 py-3 rounded-lg text-white font-medium flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 transition-colors';
      iconApprove.classList.remove('hidden');
      iconReject.classList.add('hidden');
      adminNotes.placeholder = 'Instrucciones adicionales para el cliente...';
    } else {
      modalTitle.textContent = '¿Rechazar esta devolución?';
      modalConfirmText.textContent = 'Rechazar';
      modalConfirm.className = 'flex-1 px-4 py-3 rounded-lg text-white font-medium flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 transition-colors';
      iconApprove.classList.add('hidden');
      iconReject.classList.remove('hidden');
      adminNotes.placeholder = 'Motivo del rechazo (se enviará al cliente)...';
    }

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  }

  // Event listeners para botones de acción
  document.querySelectorAll('.action-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const returnId = btn.getAttribute('data-return-id')!;
      const action = btn.getAttribute('data-action')!;
      openModal(returnId, action);
    });
  });

  document.getElementById('modal-cancel')?.addEventListener('click', closeModal);
  document.getElementById('action-modal-backdrop')?.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

  // Confirmar acción
  modalConfirm.addEventListener('click', async () => {
    modalConfirm.setAttribute('disabled', 'true');
    modalSpinner.classList.remove('hidden');
    modalError.classList.add('hidden');

    try {
      const response = await fetch(`/api/admin/returns/${currentReturnId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: currentAction,
          admin_notes: adminNotes.value.trim() || undefined,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Error al procesar');
      }

      window.location.reload();
    } catch (error: any) {
      modalError.textContent = error.message || 'Error inesperado';
      modalError.classList.remove('hidden');
    } finally {
      modalConfirm.removeAttribute('disabled');
      modalSpinner.classList.add('hidden');
    }
  });
</script>

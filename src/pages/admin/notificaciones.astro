---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Admin Notificaciones
 * Lista completa de todas las notificaciones
 * ═══════════════════════════════════════════════════════════════════════════
 */

export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import { supabase, isSupabaseConfigured } from '../../lib/supabase/client';

// Obtener notificaciones
let notifications: any[] = [];
let lowStockProducts: any[] = [];
let recentCustomers: any[] = [];
let recentOrders: any[] = [];

if (isSupabaseConfigured() && supabase) {
  // Productos con stock bajo
  const { data: lowStock } = await supabase
    .from('products')
    .select('id, name, stock, slug')
    .lt('stock', 10)
    .order('stock', { ascending: true })
    .limit(20);
  lowStockProducts = lowStock || [];

  // Clientes recientes (últimos 7 días)
  const sevenDaysAgo = new Date();
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
  
  const { data: customers } = await supabase
    .from('profiles')
    .select('id, full_name, email, created_at')
    .eq('role', 'customer')
    .gte('created_at', sevenDaysAgo.toISOString())
    .order('created_at', { ascending: false })
    .limit(20);
  recentCustomers = customers || [];

  // Pedidos recientes
  const { data: orders } = await supabase
    .from('orders')
    .select('id, total, status, created_at')
    .order('created_at', { ascending: false })
    .limit(20);
  recentOrders = orders || [];

  // Crear lista de notificaciones combinada
  lowStockProducts.forEach(product => {
    notifications.push({
      id: `stock-${product.id}`,
      type: 'stock',
      title: 'Stock bajo',
      message: `${product.name} - Solo quedan ${product.stock} unidades`,
      timestamp: new Date().toISOString(),
      link: `/admin/productos/${product.id}/editar`
    });
  });

  recentCustomers.forEach(customer => {
    notifications.push({
      id: `customer-${customer.id}`,
      type: 'customer',
      title: 'Nuevo cliente registrado',
      message: `${customer.full_name || customer.email?.split('@')[0]} se ha registrado`,
      timestamp: customer.created_at,
      link: `/admin/clientes`
    });
  });

  recentOrders.forEach(order => {
    notifications.push({
      id: `order-${order.id}`,
      type: 'order',
      title: 'Nuevo pedido',
      message: `Pedido #${order.id.slice(0, 8)} por ${((order.total || 0) / 100).toFixed(2)}€`,
      timestamp: order.created_at,
      link: `/admin/pedidos/${order.id}`
    });
  });

  // Ordenar por fecha
  notifications.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
}

// Función para formatear tiempo relativo
function formatTime(timestamp: string) {
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  
  const minutes = Math.floor(diffMs / 60000);
  const hours = Math.floor(diffMs / 3600000);
  const days = Math.floor(diffMs / 86400000);

  if (minutes < 1) return 'Ahora mismo';
  if (minutes < 60) return `Hace ${minutes} min`;
  if (hours < 24) return `Hace ${hours}h`;
  if (days === 1) return 'Ayer';
  if (days < 7) return `Hace ${days} días`;
  
  return date.toLocaleDateString('es-ES', { 
    day: 'numeric', 
    month: 'short',
    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
  });
}

// Agrupar por tipo
const stockNotifications = notifications.filter(n => n.type === 'stock');
const customerNotifications = notifications.filter(n => n.type === 'customer');
const orderNotifications = notifications.filter(n => n.type === 'order');
---

<AdminLayout title="Notificaciones">
  <div class="space-y-6 max-w-4xl">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-semibold text-navy-900">Notificaciones</h1>
        <p class="text-charcoal-500 mt-1">Historial de actividad de la tienda</p>
      </div>
      <div class="flex items-center gap-4 text-sm text-charcoal-500">
        <span>{notifications.length} notificaciones</span>
      </div>
    </div>

    <!-- Filtros rápidos -->
    <div class="flex gap-4">
      <a href="#stock" class="px-4 py-2 bg-amber-100 text-amber-700 hover:bg-amber-200 transition-colors flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        Stock bajo ({stockNotifications.length})
      </a>
      <a href="#customers" class="px-4 py-2 bg-green-100 text-green-700 hover:bg-green-200 transition-colors flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
        </svg>
        Nuevos clientes ({customerNotifications.length})
      </a>
      <a href="#orders" class="px-4 py-2 bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
        </svg>
        Pedidos ({orderNotifications.length})
      </a>
    </div>

    <!-- Stock Bajo -->
    {stockNotifications.length > 0 && (
      <div id="stock" class="bg-white border border-charcoal-100">
        <div class="px-6 py-4 border-b border-charcoal-100 bg-amber-50">
          <h2 class="font-semibold text-amber-800 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Alertas de Stock
          </h2>
        </div>
        <div class="divide-y divide-charcoal-100">
          {stockNotifications.map(notif => (
            <a href={notif.link} class="flex items-center gap-4 px-6 py-4 hover:bg-charcoal-50 transition-colors">
              <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <p class="font-medium text-charcoal-900">{notif.title}</p>
                <p class="text-sm text-charcoal-500 truncate">{notif.message}</p>
              </div>
              <span class="text-xs text-charcoal-400">{formatTime(notif.timestamp)}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Nuevos Clientes -->
    {customerNotifications.length > 0 && (
      <div id="customers" class="bg-white border border-charcoal-100">
        <div class="px-6 py-4 border-b border-charcoal-100 bg-green-50">
          <h2 class="font-semibold text-green-800 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
            Nuevos Clientes
          </h2>
        </div>
        <div class="divide-y divide-charcoal-100">
          {customerNotifications.map(notif => (
            <a href={notif.link} class="flex items-center gap-4 px-6 py-4 hover:bg-charcoal-50 transition-colors">
              <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <p class="font-medium text-charcoal-900">{notif.title}</p>
                <p class="text-sm text-charcoal-500 truncate">{notif.message}</p>
              </div>
              <span class="text-xs text-charcoal-400">{formatTime(notif.timestamp)}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Pedidos -->
    {orderNotifications.length > 0 && (
      <div id="orders" class="bg-white border border-charcoal-100">
        <div class="px-6 py-4 border-b border-charcoal-100 bg-blue-50">
          <h2 class="font-semibold text-blue-800 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            Pedidos Recientes
          </h2>
        </div>
        <div class="divide-y divide-charcoal-100">
          {orderNotifications.map(notif => (
            <a href={notif.link} class="flex items-center gap-4 px-6 py-4 hover:bg-charcoal-50 transition-colors">
              <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <p class="font-medium text-charcoal-900">{notif.title}</p>
                <p class="text-sm text-charcoal-500 truncate">{notif.message}</p>
              </div>
              <span class="text-xs text-charcoal-400">{formatTime(notif.timestamp)}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Empty State -->
    {notifications.length === 0 && (
      <div class="bg-white border border-charcoal-100 p-12 text-center">
        <svg class="w-16 h-16 mx-auto text-charcoal-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        <p class="text-lg font-medium text-charcoal-600">No hay notificaciones</p>
        <p class="text-charcoal-400 mt-1">Las notificaciones aparecerán cuando haya actividad en tu tienda</p>
      </div>
    )}
  </div>
</AdminLayout>

---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Admin Profile Page
 * Página de perfil del administrador
 * ═══════════════════════════════════════════════════════════════════════════
 */

export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseAdmin, isSupabaseAdminConfigured } from '../../../lib/supabase/server';

// La autenticación ya está verificada por el middleware
const accessToken = Astro.cookies.get('sb-access-token')?.value;

// Obtener datos del usuario actual
let user: any = null;
let profile: any = null;

if (isSupabaseAdminConfigured() && supabaseAdmin && accessToken) {
  try {
    const { data: userData, error: authError } = await supabaseAdmin.auth.getUser(accessToken);
    
    if (!authError && userData.user) {
      user = userData.user;
    
      // Obtener perfil
      const { data: profileData } = await supabaseAdmin
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single();
    
      profile = profileData;
    }
  } catch (error) {
    console.error('Error fetching user:', error);
  }
}

// Datos de demostración si no hay usuario real
const displayUser = {
  email: user?.email || 'admin@fashionmarket.com',
  name: profile?.full_name || 'Administrador',
  phone: profile?.phone || '',
  created_at: user?.created_at || new Date().toISOString(),
  last_sign_in: user?.last_sign_in_at || new Date().toISOString(),
};
---

<AdminLayout title="Mi Perfil">
  <div class="max-w-4xl mx-auto space-y-6">
    
    <!-- Profile Header -->
    <div class="bg-white border border-charcoal-100 p-6">
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-6">
        <div class="w-24 h-24 bg-gradient-to-br from-navy-700 to-navy-900 rounded-full flex items-center justify-center shadow-lg">
          <span class="text-3xl font-bold text-white">
            {displayUser.name.charAt(0).toUpperCase()}
          </span>
        </div>
        <div class="flex-1">
          <h2 class="text-2xl font-serif font-semibold text-navy-900">
            {displayUser.name}
          </h2>
          <p class="text-charcoal-500">{displayUser.email}</p>
          <div class="mt-2 flex flex-wrap gap-2">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-leather/10 text-leather">
              <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              Administrador
            </span>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
              Cuenta activa
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Form -->
    <form id="profile-form" class="bg-white border border-charcoal-100 divide-y divide-charcoal-100">
      
      <!-- Personal Info Section -->
      <div class="p-6">
        <h3 class="text-lg font-semibold text-navy-900 mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-charcoal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          Información Personal
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-charcoal-700 mb-1.5">
              Nombre completo
            </label>
            <input 
              type="text" 
              name="full_name"
              value={displayUser.name}
              class="w-full px-4 py-2.5 border border-charcoal-200 focus:border-navy-500 focus:ring-1 focus:ring-navy-500 outline-none transition-all"
              placeholder="Tu nombre"
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-charcoal-700 mb-1.5">
              Teléfono
            </label>
            <input 
              type="tel" 
              name="phone"
              value={displayUser.phone}
              class="w-full px-4 py-2.5 border border-charcoal-200 focus:border-navy-500 focus:ring-1 focus:ring-navy-500 outline-none transition-all"
              placeholder="+34 600 000 000"
            />
          </div>
        </div>
      </div>
      
      <!-- Email Section -->
      <div class="p-6">
        <h3 class="text-lg font-semibold text-navy-900 mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-charcoal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          Correo Electrónico
        </h3>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-charcoal-700 mb-1.5">
              Email actual
            </label>
            <input 
              type="email" 
              name="email"
              value={displayUser.email}
              class="w-full px-4 py-2.5 border border-charcoal-200 focus:border-navy-500 focus:ring-1 focus:ring-navy-500 outline-none transition-all"
            />
            <p class="text-xs text-charcoal-400 mt-1">
              Cambiar el email requerirá verificación
            </p>
          </div>
        </div>
      </div>
      
      <!-- Password Section -->
      <div class="p-6">
        <h3 class="text-lg font-semibold text-navy-900 mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-charcoal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          Cambiar Contraseña
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-charcoal-700 mb-1.5">
              Nueva contraseña
            </label>
            <input 
              type="password" 
              name="new_password"
              class="w-full px-4 py-2.5 border border-charcoal-200 focus:border-navy-500 focus:ring-1 focus:ring-navy-500 outline-none transition-all"
              placeholder="••••••••"
              minlength="8"
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-charcoal-700 mb-1.5">
              Confirmar contraseña
            </label>
            <input 
              type="password" 
              name="confirm_password"
              class="w-full px-4 py-2.5 border border-charcoal-200 focus:border-navy-500 focus:ring-1 focus:ring-navy-500 outline-none transition-all"
              placeholder="••••••••"
              minlength="8"
            />
          </div>
        </div>
        <p class="text-xs text-charcoal-400 mt-2">
          Deja los campos en blanco si no deseas cambiar la contraseña. Mínimo 8 caracteres.
        </p>
      </div>

      <!-- Submit Button -->
      <div class="p-6 bg-charcoal-50 flex items-center justify-between">
        <p id="save-message" class="text-sm text-green-600 hidden">
          ✓ Cambios guardados correctamente
        </p>
        <p id="error-message" class="text-sm text-red-600 hidden"></p>
        <div class="flex gap-3 ml-auto">
          <button 
            type="button"
            onclick="window.location.reload()"
            class="px-6 py-2.5 text-sm font-medium text-charcoal-700 bg-white border border-charcoal-200 hover:bg-charcoal-50 transition-colors"
          >
            Cancelar
          </button>
          <button 
            type="submit"
            class="px-6 py-2.5 text-sm font-medium text-white bg-navy-900 hover:bg-navy-800 transition-colors flex items-center gap-2"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Guardar cambios
          </button>
        </div>
      </div>
    </form>

    <!-- Account Info -->
    <div class="bg-white border border-charcoal-100 p-6">
      <h3 class="text-lg font-semibold text-navy-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-charcoal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Información de la Cuenta
      </h3>
      
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
        <div class="flex justify-between py-3 border-b border-charcoal-100">
          <span class="text-charcoal-500">Cuenta creada</span>
          <span class="text-charcoal-800 font-medium">
            {new Date(displayUser.created_at).toLocaleDateString('es-ES', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </span>
        </div>
        <div class="flex justify-between py-3 border-b border-charcoal-100">
          <span class="text-charcoal-500">Último acceso</span>
          <span class="text-charcoal-800 font-medium">
            {new Date(displayUser.last_sign_in).toLocaleDateString('es-ES', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}
          </span>
        </div>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="bg-white border border-red-200 p-6">
      <h3 class="text-lg font-semibold text-red-700 mb-2 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        Zona de Peligro
      </h3>
      <p class="text-sm text-charcoal-500 mb-4">
        Acciones irreversibles. Ten cuidado.
      </p>
      
      <button 
        type="button"
        id="logout-btn"
        class="px-4 py-2 text-sm font-medium text-red-600 border border-red-300 hover:bg-red-50 transition-colors"
      >
        Cerrar sesión en todos los dispositivos
      </button>
    </div>
  </div>

  <script>
    import { supabase, isSupabaseConfigured } from '../../../lib/supabase/client';

    const form = document.getElementById('profile-form') as HTMLFormElement;
    const saveMessage = document.getElementById('save-message');
    const errorMessage = document.getElementById('error-message');
    const logoutBtn = document.getElementById('logout-btn');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const fullName = formData.get('full_name') as string;
      const phone = formData.get('phone') as string;
      const email = formData.get('email') as string;
      const newPassword = formData.get('new_password') as string;
      const confirmPassword = formData.get('confirm_password') as string;

      // Validar contraseñas
      if (newPassword && newPassword !== confirmPassword) {
        if (errorMessage) {
          errorMessage.textContent = 'Las contraseñas no coinciden';
          errorMessage.classList.remove('hidden');
        }
        return;
      }

      if (newPassword && newPassword.length < 8) {
        if (errorMessage) {
          errorMessage.textContent = 'La contraseña debe tener al menos 8 caracteres';
          errorMessage.classList.remove('hidden');
        }
        return;
      }

      // Ocultar mensajes previos
      saveMessage?.classList.add('hidden');
      errorMessage?.classList.add('hidden');

      if (!isSupabaseConfigured() || !supabase) {
        // Modo demo
        if (saveMessage) {
          saveMessage.classList.remove('hidden');
          setTimeout(() => saveMessage.classList.add('hidden'), 3000);
        }
        return;
      }

      try {
        // Actualizar perfil
        const { data: { user } } = await supabase.auth.getUser();
        
        if (user) {
          // Actualizar tabla profiles (usando any para evitar problemas de tipos)
          await (supabase as any)
            .from('profiles')
            .update({
              full_name: fullName,
              phone: phone,
              updated_at: new Date().toISOString()
            })
            .eq('id', user.id);

          // Actualizar email si cambió
          if (email && email !== user.email) {
            await supabase.auth.updateUser({ email });
          }

          // Actualizar contraseña si se proporcionó
          if (newPassword) {
            await supabase.auth.updateUser({ password: newPassword });
          }
        }

        if (saveMessage) {
          saveMessage.classList.remove('hidden');
          setTimeout(() => saveMessage.classList.add('hidden'), 3000);
        }
      } catch (error) {
        console.error('Error updating profile:', error);
        if (errorMessage) {
          errorMessage.textContent = 'Error al guardar los cambios';
          errorMessage.classList.remove('hidden');
        }
      }
    });

    logoutBtn?.addEventListener('click', async () => {
      if (!confirm('¿Cerrar sesión en todos los dispositivos?')) return;

      if (isSupabaseConfigured() && supabase) {
        await supabase.auth.signOut({ scope: 'global' });
      }
      
      window.location.href = '/api/auth/admin-logout';
    });
  </script>
</AdminLayout>

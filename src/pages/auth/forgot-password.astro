---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Olvidé mi contraseña
 * Página para solicitar recuperación de contraseña (usuarios no autenticados)
 * ═══════════════════════════════════════════════════════════════════════════
 */

export const prerender = false;

import '../../styles/global.css';
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recuperar Contraseña | FashionMarket</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet" />
  </head>
  
  <body class="min-h-screen bg-cream flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <!-- Logo -->
      <div class="text-center mb-8">
        <a href="/" class="inline-block">
          <span class="font-serif text-3xl font-semibold text-navy-900">
            Fashion<span class="text-gold-matte">Market</span>
          </span>
        </a>
      </div>

      <!-- Form Card -->
      <div id="form-state" class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="bg-gradient-to-r from-navy-900 to-navy-800 px-8 py-6 text-center">
          <div class="w-14 h-14 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-3">
            <svg class="w-7 h-7 text-gold-matte" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
            </svg>
          </div>
          <h1 class="font-serif text-2xl text-white">Recuperar Contraseña</h1>
          <p class="text-white/70 text-sm mt-1">Te enviaremos un enlace para restablecer tu contraseña</p>
        </div>

        <form id="forgot-form" class="p-8 space-y-5">
          <!-- Mensaje de estado -->
          <div id="form-message" class="hidden p-4 rounded-lg text-sm"></div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-navy-900 mb-2">
              Email
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 border border-charcoal-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gold-matte focus:border-transparent transition-all"
              placeholder="tu@email.com"
              autofocus
            />
          </div>

          <!-- Botón de envío -->
          <button
            type="submit"
            id="submit-btn"
            class="w-full py-3 bg-navy-900 text-white rounded-lg hover:bg-navy-800 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <span id="btn-text">Enviar enlace de recuperación</span>
            <svg id="btn-spinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>

          <!-- Link a login -->
          <p class="text-center text-sm text-charcoal-500">
            ¿Recordaste tu contraseña? 
            <a href="/login" class="text-navy-900 hover:underline font-medium">Iniciar sesión</a>
          </p>
        </form>
      </div>

      <!-- Success State -->
      <div id="success-state" class="hidden bg-white rounded-lg shadow-lg p-8 text-center">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 19v-8.93a2 2 0 01.89-1.664l7-4.666a2 2 0 012.22 0l7 4.666A2 2 0 0121 10.07V19M3 19a2 2 0 002 2h14a2 2 0 002-2M3 19l6.75-4.5M21 19l-6.75-4.5M3 10l6.75 4.5M21 10l-6.75 4.5m0 0l-1.14.76a2 2 0 01-2.22 0l-1.14-.76" />
          </svg>
        </div>
        <h2 class="font-serif text-2xl text-navy-900 mb-2">¡Email enviado!</h2>
        <p class="text-charcoal-600 mb-4">
          Si existe una cuenta con ese email, recibirás un enlace para restablecer tu contraseña.
        </p>
        <p class="text-sm text-charcoal-500 mb-6">
          Revisa tu bandeja de entrada y carpeta de spam. El enlace expira en 24 horas.
        </p>
        <div class="space-y-3">
          <button
            type="button"
            id="resend-btn"
            class="w-full py-3 border border-navy-900 text-navy-900 rounded-lg hover:bg-navy-50 transition-colors font-medium"
          >
            Reenviar email
          </button>
          <a 
            href="/login" 
            class="block w-full py-3 bg-navy-900 text-white rounded-lg hover:bg-navy-800 transition-colors font-medium text-center"
          >
            Volver a Iniciar sesión
          </a>
        </div>
      </div>
    </div>

    <script>
      import { createClient } from '@supabase/supabase-js';

      const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
      const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
      const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'http://localhost:4321';
      const supabase = createClient(supabaseUrl, supabaseAnonKey);

      // Elements
      const formState = document.getElementById('form-state');
      const successState = document.getElementById('success-state');
      const forgotForm = document.getElementById('forgot-form') as HTMLFormElement;
      const emailInput = document.getElementById('email') as HTMLInputElement;
      const formMessage = document.getElementById('form-message');
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
      const btnText = document.getElementById('btn-text');
      const btnSpinner = document.getElementById('btn-spinner');
      const resendBtn = document.getElementById('resend-btn');

      let lastEmail = '';

      // Show message
      const showMessage = (message: string, isError: boolean) => {
        if (!formMessage) return;
        formMessage.textContent = message;
        formMessage.classList.remove('hidden', 'bg-green-50', 'border-green-200', 'text-green-700', 'bg-red-50', 'border-red-200', 'text-red-700');
        formMessage.classList.add(
          isError ? 'bg-red-50' : 'bg-green-50',
          'border',
          isError ? 'border-red-200' : 'border-green-200',
          isError ? 'text-red-700' : 'text-green-700'
        );
      };

      // Send reset email
      const sendResetEmail = async (email: string) => {
        // Set loading state
        submitBtn.disabled = true;
        btnText!.textContent = 'Enviando...';
        btnSpinner?.classList.remove('hidden');

        try {
          const { error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: `${siteUrl}/auth/reset-password`,
          });

          if (error) {
            throw error;
          }

          lastEmail = email;
          formState?.classList.add('hidden');
          successState?.classList.remove('hidden');
        } catch (error: any) {
          console.error('Error sending reset email:', error);
          showMessage(error.message || 'Error al enviar el email. Inténtalo de nuevo.', true);
          submitBtn.disabled = false;
          btnText!.textContent = 'Enviar enlace de recuperación';
          btnSpinner?.classList.add('hidden');
        }
      };

      // Handle form submission
      forgotForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = emailInput.value.trim();

        if (!email) {
          showMessage('Por favor, introduce tu email', true);
          return;
        }

        await sendResetEmail(email);
      });

      // Handle resend
      resendBtn?.addEventListener('click', async () => {
        if (lastEmail) {
          formState?.classList.remove('hidden');
          successState?.classList.add('hidden');
          emailInput.value = lastEmail;
          submitBtn.disabled = false;
          btnText!.textContent = 'Enviar enlace de recuperación';
          btnSpinner?.classList.add('hidden');
          await sendResetEmail(lastEmail);
        }
      });
    </script>
  </body>
</html>

---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Página de Categoría
 * Listado de productos por categoría (SSR para Header dinámico)
 * ═══════════════════════════════════════════════════════════════════════════
 */

export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import ProductCard from '../../components/product/ProductCard.astro';
import { supabase, isSupabaseConfigured } from '../../lib/supabase/client';

// Generar rutas estáticas para todas las categorías
export async function getStaticPaths() {
  // Datos de demostración (dentro de getStaticPaths para que estén disponibles)
  const fallbackCategories = [
    { slug: 'trajes', name: 'Trajes' },
    { slug: 'camisas', name: 'Camisas' },
    { slug: 'pantalones', name: 'Pantalones' },
    { slug: 'accesorios', name: 'Accesorios' },
  ];
  
  if (isSupabaseConfigured() && supabase) {
    const { data: categories } = await supabase
      .from('categories')
      .select('slug, name');
    
    if (categories && categories.length > 0) {
      return categories.map((cat: { slug: string; name: string }) => ({
        params: { slug: cat.slug },
        props: { categoryName: cat.name },
      }));
    }
  }
  
  // Rutas de demostración
  return fallbackCategories.map((category) => ({
    params: { slug: category.slug },
    props: { categoryName: category.name },
  }));
}

// Datos de demostración para el resto del componente
const demoCategories = [
  { id: '1', name: 'Trajes', slug: 'trajes', image_url: 'https://images.unsplash.com/photo-1594938298603-c8148c4dae35?w=800&q=80', description: 'Trajes de vestir premium' },
  { id: '2', name: 'Camisas', slug: 'camisas', image_url: 'https://images.unsplash.com/photo-1596755094514-f87e34085b2c?w=800&q=80', description: 'Camisas de alta calidad' },
  { id: '3', name: 'Pantalones', slug: 'pantalones', image_url: 'https://images.unsplash.com/photo-1473966968600-fa801b869a1a?w=800&q=80', description: 'Pantalones elegantes y casuales' },
  { id: '4', name: 'Accesorios', slug: 'accesorios', image_url: 'https://images.unsplash.com/photo-1624222247344-550fb60583dc?w=800&q=80', description: 'Complementos elegantes' },
];

const demoProducts = [
  { id: '1', name: 'Traje Italiano Slim Fit', slug: 'traje-italiano-slim-fit', price: 59900, images: ['https://images.unsplash.com/photo-1594938298603-c8148c4dae35?w=600&q=80'], category_id: '1', featured: true, stock: 10, sizes: ['S','M','L','XL'], colors: ['Navy', 'Charcoal'], description: 'Traje de corte italiano', material: 'Lana 100%', created_at: new Date().toISOString(), updated_at: new Date().toISOString() },
  { id: '2', name: 'Camisa Oxford Premium', slug: 'camisa-oxford-premium', price: 8900, images: ['https://images.unsplash.com/photo-1596755094514-f87e34085b2c?w=600&q=80'], category_id: '2', featured: true, stock: 25, sizes: ['S','M','L','XL'], colors: ['White', 'Light Blue'], description: 'Camisa oxford clásica', material: 'Algodón 100%', created_at: new Date().toISOString(), updated_at: new Date().toISOString() },
  { id: '3', name: 'Pantalón Chino Slim', slug: 'pantalon-chino-slim', price: 7900, images: ['https://images.unsplash.com/photo-1473966968600-fa801b869a1a?w=600&q=80'], category_id: '3', featured: true, stock: 30, sizes: ['S','M','L','XL','XXL'], colors: ['Beige', 'Navy'], description: 'Pantalón chino elegante', material: 'Algodón 98%, Elastano 2%', created_at: new Date().toISOString(), updated_at: new Date().toISOString() },
  { id: '4', name: 'Pantalón de Vestir', slug: 'pantalon-vestir-clasico', price: 9900, images: ['https://images.unsplash.com/photo-1624378439575-d8705ad7ae80?w=600&q=80'], category_id: '3', featured: true, stock: 20, sizes: ['S','M','L','XL'], colors: ['Negro', 'Gris'], description: 'Pantalón de vestir clásico', material: 'Lana 100%', created_at: new Date().toISOString(), updated_at: new Date().toISOString() },
  { id: '5', name: 'Cinturón de Cuero', slug: 'cinturon-cuero', price: 7500, images: ['https://images.unsplash.com/photo-1624222247344-550fb60583dc?w=600&q=80'], category_id: '4', featured: true, stock: 50, sizes: ['85cm','90cm','95cm','100cm'], colors: ['Brown', 'Black'], description: 'Cinturón artesanal', material: 'Cuero genuino', created_at: new Date().toISOString(), updated_at: new Date().toISOString() },
  { id: '6', name: 'Blazer Casual Lino', slug: 'blazer-casual-lino', price: 29900, images: ['https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=600&q=80'], category_id: '1', featured: true, stock: 15, sizes: ['S','M','L','XL'], colors: ['Beige', 'Navy'], description: 'Blazer de verano', material: 'Lino 100%', created_at: new Date().toISOString(), updated_at: new Date().toISOString() },
];

const { slug } = Astro.params;
const { categoryName } = Astro.props;

// Obtener parámetros de URL para ordenación
const url = new URL(Astro.request.url);
const sortFilter = url.searchParams.get('orden') || 'novedades';

// Opciones de ordenación
const sortOptions = [
  { value: 'novedades', label: 'Ordenar por: Novedades' },
  { value: 'precio-asc', label: 'Precio: Menor a mayor' },
  { value: 'precio-desc', label: 'Precio: Mayor a menor' },
];

// Obtener la categoría actual
let category = demoCategories.find(c => c.slug === slug) || null;
let products = demoProducts.filter(p => p.category_id === category?.id);
let allCategories = demoCategories;

if (isSupabaseConfigured() && supabase) {
  const { data: realCategory } = await supabase
    .from('categories')
    .select('*')
    .eq('slug', slug as string)
    .single();

  if (realCategory) {
    category = realCategory as typeof category;
    
    // Construir query con ordenación
    let query = supabase
      .from('products')
      .select('*')
      .eq('category_id', category!.id);
    
    // Aplicar ordenación según el filtro
    switch (sortFilter) {
      case 'precio-asc':
        query = query.order('price', { ascending: true });
        break;
      case 'precio-desc':
        query = query.order('price', { ascending: false });
        break;
      case 'novedades':
      default:
        query = query.order('created_at', { ascending: false });
        break;
    }
    
    const { data: realProducts } = await query;
    
    if (realProducts) products = realProducts as typeof products;
  }

  const { data: realCategories } = await supabase
    .from('categories')
    .select('*')
    .order('name');
  
  if (realCategories?.length) allCategories = realCategories as typeof allCategories;
}
---

<BaseLayout 
  title={category?.name || 'Categoría'}
  description={category?.description || `Explora nuestra colección de ${category?.name?.toLowerCase()}`}
>
  <div class="container-custom py-12">
    <!-- Breadcrumb -->
    <nav class="mb-8">
      <ol class="flex items-center gap-2 text-sm text-charcoal-500">
        <li><a href="/" class="hover:text-navy-900 transition-colors">Inicio</a></li>
        <li>/</li>
        <li><a href="/tienda" class="hover:text-navy-900 transition-colors">Tienda</a></li>
        <li>/</li>
        <li class="text-navy-900">{category?.name}</li>
      </ol>
    </nav>
    
    <!-- Category Header -->
    <div class="mb-10">
      <h1 class="font-serif text-4xl font-medium text-navy-900 mb-4">
        {category?.name}
      </h1>
      {category?.description && (
        <p class="text-charcoal-500 max-w-2xl">
          {category.description}
        </p>
      )}
    </div>
    
    <div class="flex flex-col lg:flex-row gap-10">
      <!-- Sidebar -->
      <aside class="lg:w-64 flex-shrink-0">
        <div class="sticky top-24 space-y-8">
          <!-- Categories Navigation -->
          <div>
            <h3 class="font-medium text-navy-900 mb-4">Categorías</h3>
            <ul class="space-y-2">
              <li>
                <a 
                  href="/tienda"
                  class="text-sm text-charcoal-600 hover:text-navy-900 transition-colors"
                >
                  Todos los productos
                </a>
              </li>
              {allCategories?.map((cat) => (
                <li>
                  <a 
                    href={`/categoria/${cat.slug}`}
                    class={`text-sm transition-colors ${
                      cat.slug === slug 
                        ? 'text-navy-900 font-medium' 
                        : 'text-charcoal-600 hover:text-navy-900'
                    }`}
                  >
                    {cat.name}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </aside>
      
      <!-- Products Grid -->
      <main class="flex-1">
        <!-- Sort & Count -->
        <div class="flex items-center justify-between mb-6 pb-6 border-b border-charcoal-100">
          <p class="text-sm text-charcoal-500">
            {products?.length || 0} productos
          </p>
          <select id="sort-select" class="select-elegant w-auto pr-10">
            {sortOptions.map((option) => (
              <option value={option.value} selected={sortFilter === option.value}>
                {option.label}
              </option>
            ))}
          </select>
        </div>
        
        <!-- Grid -->
        {products && products.length > 0 ? (
          <div class="product-grid">
            {products.map((product) => (
              <ProductCard product={product} />
            ))}
          </div>
        ) : (
          <div class="text-center py-16">
            <svg class="w-16 h-16 mx-auto text-charcoal-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <h3 class="font-serif text-xl text-navy-900 mb-2">
              No hay productos en esta categoría
            </h3>
            <p class="text-charcoal-500 mb-6">
              Explora otras categorías de nuestra tienda.
            </p>
            <a href="/tienda" class="btn-primary">
              Ver todo
            </a>
          </div>
        )}
      </main>
    </div>
  </div>

  <script>
    // Ordenación por select
    const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
    if (sortSelect) {
      sortSelect.addEventListener('change', () => {
        const url = new URL(window.location.href);
        url.searchParams.set('orden', sortSelect.value);
        window.location.href = url.toString();
      });
    }
  </script>
</BaseLayout>

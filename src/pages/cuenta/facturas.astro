---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * PÁGINA: Mis Facturas
 * Lista todas las facturas y notas de crédito del usuario con filtros
 * ═══════════════════════════════════════════════════════════════════════════
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabase } from '../../lib/supabase/client';

// Verificar autenticación
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

if (!accessToken || !refreshToken || !supabase) {
  return Astro.redirect('/login?redirect=/cuenta/facturas');
}

const { data: sessionData, error: sessionError } = await supabase.auth.setSession({
  access_token: accessToken,
  refresh_token: refreshToken,
});

if (sessionError || !sessionData.user) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/login?redirect=/cuenta/facturas');
}

const user = sessionData.user;

// Debug: mostrar info del usuario
console.log('[FACTURAS] Usuario:', user.id, user.email);

// Obtener pedidos del usuario primero (para poder buscar facturas por order_id)
// Buscar por user_id
const { data: ordersByUserId } = await supabase
  .from('orders')
  .select('id')
  .eq('user_id', user.id);

// Buscar por guest_email
let ordersByEmail: any[] = [];
if (user.email) {
  const { data: ordersEmail } = await supabase
    .from('orders')
    .select('id')
    .eq('guest_email', user.email);
  ordersByEmail = ordersEmail || [];
}

// Combinar order IDs
const orderIdsSet = new Set<string>();
(ordersByUserId || []).forEach((o: any) => orderIdsSet.add(o.id));
ordersByEmail.forEach((o: any) => orderIdsSet.add(o.id));
const orderIds = Array.from(orderIdsSet);

console.log('[FACTURAS] Pedidos encontrados:', orderIds.length);

// Obtener facturas del usuario - buscar por user_id, email O order_id
const { data: invoicesByUserId, error: errorByUserId } = await supabase
  .from('invoices')
  .select('*')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false });

console.log('[FACTURAS] Por user_id:', invoicesByUserId?.length || 0, errorByUserId?.message || '');

let invoicesByEmail: any[] = [];
if (user.email) {
  const emailResult = await supabase
    .from('invoices')
    .select('*')
    .eq('customer_email', user.email as string)
    .order('created_at', { ascending: false });
  invoicesByEmail = emailResult.data || [];
}

// También buscar facturas por order_id de los pedidos del usuario
let invoicesByOrder: any[] = [];
if (orderIds.length > 0) {
  const orderResult = await supabase
    .from('invoices')
    .select('*')
    .in('order_id', orderIds)
    .order('created_at', { ascending: false });
  invoicesByOrder = orderResult.data || [];
}

// Combinar y eliminar duplicados (por user_id, email y order_id)
const allInvoicesMap = new Map();
(invoicesByUserId || []).forEach((inv: any) => allInvoicesMap.set(inv.id, inv));
(invoicesByEmail || []).forEach((inv: any) => allInvoicesMap.set(inv.id, inv));
(invoicesByOrder || []).forEach((inv: any) => allInvoicesMap.set(inv.id, inv));
const invoices = Array.from(allInvoicesMap.values()).sort((a: any, b: any) => 
  new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
);

// Obtener notas de crédito (facturas de abono) - por user_id o por order_id
const { data: creditNotesByUser } = await supabase
  .from('credit_notes')
  .select('*')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false });

let creditNotesByOrder: any[] = [];
if (orderIds.length > 0) {
  const cnByOrderResult = await supabase
    .from('credit_notes')
    .select('*')
    .in('order_id', orderIds)
    .order('created_at', { ascending: false });
  creditNotesByOrder = cnByOrderResult.data || [];
}

// Combinar notas de crédito y eliminar duplicados
const creditNotesMap = new Map();
(creditNotesByUser || []).forEach((cn: any) => creditNotesMap.set(cn.id, cn));
(creditNotesByOrder || []).forEach((cn: any) => creditNotesMap.set(cn.id, cn));
const creditNotes = Array.from(creditNotesMap.values()).sort((a: any, b: any) => 
  new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
);

// Combinar ambos tipos para mostrar en un solo listado filtrable
const allDocuments = [
  ...(invoices || []).map((inv: any) => ({ ...inv, docType: 'invoice' })),
  ...(creditNotes || []).map((cn: any) => ({ ...cn, docType: 'credit_note' })),
].sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('es-ES', {
    day: '2-digit',
    month: 'long',
    year: 'numeric'
  });
};

const formatCurrency = (cents: number) => {
  return (Math.abs(cents) / 100).toFixed(2) + '€';
};

const getStatusBadge = (status: string) => {
  switch (status) {
    case 'paid':
      return { text: 'Pagada', class: 'bg-green-100 text-green-800' };
    case 'pending':
      return { text: 'Pendiente', class: 'bg-yellow-100 text-yellow-800' };
    case 'cancelled':
      return { text: 'Cancelada', class: 'bg-red-100 text-red-800' };
    case 'refunded':
      return { text: 'Reembolsada', class: 'bg-purple-100 text-purple-800' };
    default:
      return { text: status, class: 'bg-gray-100 text-gray-800' };
  }
};

const getCreditNoteStatusBadge = (status: string) => {
  switch (status) {
    case 'refunded':
      return { text: 'Abonada', class: 'bg-green-100 text-green-800' };
    case 'pending':
      return { text: 'Pendiente', class: 'bg-yellow-100 text-yellow-800' };
    case 'cancelled':
      return { text: 'Cancelada', class: 'bg-red-100 text-red-800' };
    default:
      return { text: status || 'Procesada', class: 'bg-gray-100 text-gray-800' };
  }
};
---

<BaseLayout title="Mis Facturas | FashionMarket">
  <main class="min-h-screen bg-cream py-8 lg:py-12">
    <div class="container-custom max-w-5xl">
      <!-- Breadcrumb -->
      <nav class="mb-6">
        <ol class="flex items-center gap-2 text-sm text-charcoal-500">
          <li><a href="/" class="hover:text-navy-900 transition-colors">Inicio</a></li>
          <li>/</li>
          <li><a href="/cuenta" class="hover:text-navy-900 transition-colors">Mi Cuenta</a></li>
          <li>/</li>
          <li class="text-navy-900 font-medium">Facturas</li>
        </ol>
      </nav>

      <div class="bg-white rounded-lg shadow-sm">
        <!-- Header -->
        <div class="p-6 border-b border-charcoal-100">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
              <h1 class="text-2xl font-serif text-navy-900">Mis Facturas</h1>
              <p class="text-charcoal-500 mt-1">Descarga tus facturas y notas de crédito</p>
            </div>
            
            <!-- Estadísticas rápidas -->
            <div class="flex gap-4 text-sm">
              <div class="px-4 py-2 bg-navy-900/5 rounded-lg border border-navy-900/10">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-navy-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <span class="text-navy-900 font-medium">{invoices?.length || 0}</span>
                  <span class="text-charcoal-600">facturas</span>
                </span>
              </div>
              {creditNotes && creditNotes.length > 0 && (
                <div class="px-4 py-2 bg-red-50 rounded-lg border border-red-100">
                  <span class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"/>
                    </svg>
                    <span class="text-red-700 font-medium">{creditNotes.length}</span>
                    <span class="text-red-600">notas</span>
                  </span>
                </div>
              )}
            </div>
          </div>
        </div>

        <!-- Barra de filtros -->
        {allDocuments && allDocuments.length > 0 && (
          <div class="p-4 border-b border-charcoal-100 bg-cream/50">
            <div class="flex flex-col md:flex-row gap-4">
              <!-- Filtro por Tipo -->
              <div class="min-w-[180px]">
                <select id="filterType" class="w-full px-4 py-2.5 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-gold-matte/30 focus:border-gold-matte transition-colors appearance-none bg-white cursor-pointer">
                  <option value="all">Todos los documentos</option>
                  <option value="invoice">Solo Facturas</option>
                  <option value="credit_note">Solo Notas de Crédito</option>
                </select>
              </div>

              <!-- Filtro por Fecha -->
              <div class="min-w-[180px]">
                <select id="filterDate" class="w-full px-4 py-2.5 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-gold-matte/30 focus:border-gold-matte transition-colors appearance-none bg-white cursor-pointer">
                  <option value="all">Todas las fechas</option>
                  <option value="last30">Últimos 30 días</option>
                  <option value="last90">Últimos 90 días</option>
                  <option value="thisYear">Este año</option>
                  <option value="lastYear">Año anterior</option>
                </select>
              </div>

              <!-- Rango de fechas personalizado -->
              <div class="flex gap-2 items-center flex-1 justify-end">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-charcoal-500">Desde</span>
                  <input type="date" id="dateFrom" class="px-3 py-2 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-gold-matte/30 focus:border-gold-matte transition-colors text-sm">
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-sm text-charcoal-500">Hasta</span>
                  <input type="date" id="dateTo" class="px-3 py-2 border border-charcoal-200 rounded-lg focus:ring-2 focus:ring-gold-matte/30 focus:border-gold-matte transition-colors text-sm">
                </div>
                <button id="clearFilters" class="px-3 py-2 text-charcoal-500 hover:text-navy-900 text-sm underline underline-offset-2">
                  Limpiar
                </button>
              </div>
            </div>
          </div>
        )}

        <!-- Lista de Documentos -->
        <div id="documentsList" class="divide-y divide-charcoal-100">
              {allDocuments && allDocuments.length > 0 ? (
                <>
                  {allDocuments.map((doc: any) => {
                    const isInvoice = doc.docType === 'invoice';
                    const status = isInvoice ? getStatusBadge(doc.status) : getCreditNoteStatusBadge(doc.status);
                    const items = doc.items as any[] || [];
                    const docNumber = isInvoice ? doc.invoice_number : doc.credit_note_number;
                    const issueDate = doc.issue_date || doc.created_at;
                    
                    return (
                      <div 
                        class={`document-item p-6 transition-colors hover:bg-cream/30 ${!isInvoice ? 'bg-red-50/20' : ''}`}
                        data-type={doc.docType}
                        data-date={issueDate}
                      >
                        {/* Cabecera del documento */}
                        <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-4 mb-4">
                          <div>
                            <div class="flex items-center gap-3 mb-1">
                              <span class={`font-semibold text-lg ${isInvoice ? 'text-navy-900' : 'text-red-600'}`}>
                                {docNumber}
                              </span>
                              <span class={`px-2.5 py-1 text-xs font-medium rounded-full ${isInvoice ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}`}>
                                {isInvoice ? 'Factura' : 'Nota de Crédito'}
                              </span>
                              <span class={`px-2.5 py-1 text-xs font-medium rounded-full border ${status.class}`}>
                                {status.text}
                              </span>
                            </div>
                            <p class="text-sm text-charcoal-500">
                              {formatDate(issueDate)}
                            </p>
                            {!isInvoice && doc.reason && (
                              <p class="text-sm text-charcoal-600 italic mt-1">
                                {doc.reason}
                              </p>
                            )}
                          </div>
                          <div class="text-right">
                            <p class={`text-xl font-bold ${isInvoice ? 'text-navy-900' : 'text-red-600'}`}>
                              {!isInvoice && '-'}{formatCurrency(doc.total)}
                            </p>
                            <p class="text-sm text-charcoal-500">
                              {isInvoice ? (items.length + ' artículo' + (items.length !== 1 ? 's' : '')) : 'Importe abonado'}
                            </p>
                          </div>
                        </div>

                        {/* Items preview para facturas */}
                        {isInvoice && items.length > 0 && (
                          <div class="bg-cream/50 border border-charcoal-100 rounded-lg p-3 mb-4">
                            <div class="flex flex-wrap gap-2">
                              {items.slice(0, 3).map((item: any) => (
                                <span class="text-xs bg-white text-charcoal-700 px-2.5 py-1.5 rounded-md border border-charcoal-100">
                                  {item.name} x{item.quantity}
                                </span>
                              ))}
                              {items.length > 3 && (
                                <span class="text-xs bg-charcoal-100 text-charcoal-600 px-2.5 py-1.5 rounded-md">
                                  +{items.length - 3} más
                                </span>
                              )}
                            </div>
                          </div>
                        )}

                        {/* Acciones */}
                        <div class="flex flex-wrap gap-3">
                          <a
                            href={isInvoice ? `/api/invoices/${doc.id}` : `/api/credit-notes/${doc.id}`}
                            target="_blank"
                            class={`inline-flex items-center gap-2 px-4 py-2 ${isInvoice ? 'bg-navy-900 hover:bg-navy-800' : 'bg-red-600 hover:bg-red-700'} text-white text-sm rounded-lg transition-colors`}
                          >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            Ver
                          </a>
                          <a
                            href={isInvoice ? `/api/invoices/${doc.id}/pdf` : `/api/credit-notes/${doc.id}/pdf`}
                            class="inline-flex items-center gap-2 px-4 py-2 border border-charcoal-200 text-charcoal-700 text-sm rounded-lg hover:bg-charcoal-50 transition-colors"
                            title="Descargar PDF"
                          >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            PDF
                          </a>
                        </div>
                      </div>
                    );
                  })}
                </>
              ) : (
                <div class="p-12 text-center" id="emptyState">
                  <svg class="w-20 h-20 mx-auto text-charcoal-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <h2 class="text-lg font-medium text-navy-900 mb-2">No tienes facturas</h2>
                  <p class="text-charcoal-500 mb-6">Las facturas aparecerán aquí después de completar tu primera compra.</p>
                  <a
                    href="/tienda"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-navy-900 text-white rounded-md hover:bg-navy-800 transition-colors"
                  >
                    Explorar tienda
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                    </svg>
                  </a>
                </div>
              )}
            </div>

            <!-- Mensaje cuando no hay resultados (oculto por defecto) -->
            <div id="noResults" class="p-12 text-center hidden">
              <svg class="w-16 h-16 mx-auto text-amber-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <h3 class="text-lg font-medium text-navy-900 mb-2">No hay resultados</h3>
              <p class="text-charcoal-500 mb-4">No se encontraron documentos con los filtros seleccionados.</p>
              <button id="resetFilters" class="text-gold-matte hover:text-navy-900 font-medium underline underline-offset-2">
                Quitar filtros
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
</BaseLayout>

<script>
  // Filtros de documentos
  document.addEventListener('DOMContentLoaded', () => {
    const filterType = document.getElementById('filterType') as HTMLSelectElement;
    const filterDate = document.getElementById('filterDate') as HTMLSelectElement;
    const dateFrom = document.getElementById('dateFrom') as HTMLInputElement;
    const dateTo = document.getElementById('dateTo') as HTMLInputElement;
    const clearFilters = document.getElementById('clearFilters');
    const resetFilters = document.getElementById('resetFilters');
    const noResults = document.getElementById('noResults');
    const documentItems = document.querySelectorAll('.document-item');

    function applyFilters() {
      const typeValue = filterType?.value || 'all';
      const dateValue = filterDate?.value || 'all';
      const fromDate = dateFrom?.value ? new Date(dateFrom.value) : null;
      const toDate = dateTo?.value ? new Date(dateTo.value + 'T23:59:59') : null;

      let visibleCount = 0;

      documentItems.forEach((item) => {
        const el = item as HTMLElement;
        const docType = el.dataset.type;
        const docDate = new Date(el.dataset.date || '');
        let show = true;

        // Filtro por tipo
        if (typeValue !== 'all' && docType !== typeValue) {
          show = false;
        }

        // Filtro por fecha predefinida
        if (show && dateValue !== 'all') {
          const now = new Date();
          const docDateMs = docDate.getTime();

          switch (dateValue) {
            case 'last30':
              const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
              show = docDateMs >= thirtyDaysAgo.getTime();
              break;
            case 'last90':
              const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
              show = docDateMs >= ninetyDaysAgo.getTime();
              break;
            case 'thisYear':
              show = docDate.getFullYear() === now.getFullYear();
              break;
            case 'lastYear':
              show = docDate.getFullYear() === now.getFullYear() - 1;
              break;
          }
        }

        // Filtro por rango de fechas personalizado
        if (show && fromDate) {
          show = docDate >= fromDate;
        }
        if (show && toDate) {
          show = docDate <= toDate;
        }

        el.style.display = show ? '' : 'none';
        if (show) visibleCount++;
      });

      // Mostrar/ocultar mensaje de no resultados
      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount > 0 || documentItems.length === 0);
      }
    }

    function resetAllFilters() {
      if (filterType) filterType.value = 'all';
      if (filterDate) filterDate.value = 'all';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';
      applyFilters();
    }

    // Event listeners
    filterType?.addEventListener('change', applyFilters);
    filterDate?.addEventListener('change', () => {
      // Limpiar fechas personalizadas al seleccionar predefinida
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';
      applyFilters();
    });
    dateFrom?.addEventListener('change', () => {
      if (filterDate) filterDate.value = 'all'; // Reset predefinido
      applyFilters();
    });
    dateTo?.addEventListener('change', () => {
      if (filterDate) filterDate.value = 'all'; // Reset predefinido
      applyFilters();
    });
    clearFilters?.addEventListener('click', resetAllFilters);
    resetFilters?.addEventListener('click', resetAllFilters);
  });
</script>

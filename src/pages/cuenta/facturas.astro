---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * PÁGINA: Mis Facturas
 * Lista todas las facturas y notas de crédito del usuario con filtros
 * ═══════════════════════════════════════════════════════════════════════════
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabase } from '../../lib/supabase/client';

// Verificar autenticación
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

if (!accessToken || !refreshToken || !supabase) {
  return Astro.redirect('/login?redirect=/cuenta/facturas');
}

const { data: sessionData, error: sessionError } = await supabase.auth.setSession({
  access_token: accessToken,
  refresh_token: refreshToken,
});

if (sessionError || !sessionData.user) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/login?redirect=/cuenta/facturas');
}

const user = sessionData.user;

// Obtener facturas del usuario - buscar por user_id O por email
const { data: invoicesByUserId } = await supabase
  .from('invoices')
  .select('*')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false });

let invoicesByEmail: any[] = [];
if (user.email) {
  const emailResult = await supabase
    .from('invoices')
    .select('*')
    .eq('customer_email', user.email as string)
    .order('created_at', { ascending: false });
  invoicesByEmail = emailResult.data || [];
}

// Combinar y eliminar duplicados
const allInvoicesMap = new Map();
(invoicesByUserId || []).forEach((inv: any) => allInvoicesMap.set(inv.id, inv));
(invoicesByEmail || []).forEach((inv: any) => allInvoicesMap.set(inv.id, inv));
const invoices = Array.from(allInvoicesMap.values()).sort((a: any, b: any) => 
  new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
);

// Obtener notas de crédito (facturas de abono)
const { data: creditNotes, error: creditNotesError } = await supabase
  .from('credit_notes')
  .select('*')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false });

// Combinar ambos tipos para mostrar en un solo listado filtrable
const allDocuments = [
  ...(invoices || []).map((inv: any) => ({ ...inv, docType: 'invoice' })),
  ...(creditNotes || []).map((cn: any) => ({ ...cn, docType: 'credit_note' })),
].sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('es-ES', {
    day: '2-digit',
    month: 'long',
    year: 'numeric'
  });
};

const formatCurrency = (cents: number) => {
  return (Math.abs(cents) / 100).toFixed(2) + '€';
};

const getStatusBadge = (status: string) => {
  switch (status) {
    case 'paid':
      return { text: 'Pagada', class: 'bg-green-100 text-green-800' };
    case 'pending':
      return { text: 'Pendiente', class: 'bg-yellow-100 text-yellow-800' };
    case 'cancelled':
      return { text: 'Cancelada', class: 'bg-red-100 text-red-800' };
    case 'refunded':
      return { text: 'Reembolsada', class: 'bg-purple-100 text-purple-800' };
    default:
      return { text: status, class: 'bg-gray-100 text-gray-800' };
  }
};

const getCreditNoteStatusBadge = (status: string) => {
  switch (status) {
    case 'refunded':
      return { text: 'Abonada', class: 'bg-green-100 text-green-800' };
    case 'pending':
      return { text: 'Pendiente', class: 'bg-yellow-100 text-yellow-800' };
    case 'cancelled':
      return { text: 'Cancelada', class: 'bg-red-100 text-red-800' };
    default:
      return { text: status || 'Procesada', class: 'bg-gray-100 text-gray-800' };
  }
};
---

<BaseLayout title="Mis Facturas | FashionMarket">
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="container mx-auto px-4">
      <!-- Breadcrumb -->
      <nav class="mb-8">
        <ol class="flex items-center space-x-2 text-sm">
          <li><a href="/" class="text-gray-500 hover:text-primary transition">Inicio</a></li>
          <li><span class="text-gray-300">/</span></li>
          <li><a href="/cuenta" class="text-gray-500 hover:text-primary transition">Mi Cuenta</a></li>
          <li><span class="text-gray-300">/</span></li>
          <li><span class="text-primary font-medium">Facturas</span></li>
        </ol>
      </nav>

      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Sidebar -->
        <aside class="lg:w-64 flex-shrink-0">
          <nav class="bg-white rounded-xl shadow-sm p-4 sticky top-24">
            <h3 class="font-semibold text-gray-900 mb-4">Mi Cuenta</h3>
            <ul class="space-y-1">
              <li>
                <a href="/cuenta" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                  </svg>
                  Panel General
                </a>
              </li>
              <li>
                <a href="/cuenta/pedidos" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                  </svg>
                  Mis Pedidos
                </a>
              </li>
              <li>
                <a href="/cuenta/facturas" class="flex items-center gap-3 px-4 py-2.5 rounded-lg bg-primary/10 text-primary font-medium">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  Facturas
                </a>
              </li>
              <li>
                <a href="/cuenta/favoritos" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  Favoritos
                </a>
              </li>
              <li>
                <a href="/cuenta/direcciones" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                  Direcciones
                </a>
              </li>
              <li>
                <a href="/cuenta/perfil" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  Mi Perfil
                </a>
              </li>
            </ul>
          </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1">
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <!-- Header con Filtros -->
            <div class="p-6 border-b border-gray-100">
              <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                <div>
                  <h1 class="text-2xl font-bold text-gray-900">Mis Facturas</h1>
                  <p class="text-gray-500 mt-1">Descarga tus facturas y notas de crédito</p>
                </div>
                <div class="flex items-center gap-4">
                  <div class="flex items-center gap-2 bg-primary/10 text-primary px-4 py-2 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="font-semibold">{invoices?.length || 0}</span>
                    <span>facturas</span>
                  </div>
                  {creditNotes && creditNotes.length > 0 && (
                    <div class="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded-lg">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"/>
                      </svg>
                      <span class="font-semibold">{creditNotes.length}</span>
                      <span>notas</span>
                    </div>
                  )}
                </div>
              </div>

              <!-- Filtros -->
              <div class="flex flex-col sm:flex-row gap-4">
                <!-- Filtro por Tipo -->
                <div class="flex-1 sm:max-w-xs">
                  <label for="filterType" class="block text-sm font-medium text-gray-700 mb-1">Tipo de documento</label>
                  <select id="filterType" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                    <option value="all">Todos los documentos</option>
                    <option value="invoice">Solo Facturas</option>
                    <option value="credit_note">Solo Notas de Crédito</option>
                  </select>
                </div>

                <!-- Filtro por Fecha -->
                <div class="flex-1 sm:max-w-xs">
                  <label for="filterDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                  <select id="filterDate" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                    <option value="all">Todas las fechas</option>
                    <option value="last30">Últimos 30 días</option>
                    <option value="last90">Últimos 90 días</option>
                    <option value="thisYear">Este año</option>
                    <option value="lastYear">Año anterior</option>
                  </select>
                </div>

                <!-- Rango de fechas personalizado -->
                <div class="flex gap-2 items-end">
                  <div>
                    <label for="dateFrom" class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                    <input type="date" id="dateFrom" class="px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition text-sm">
                  </div>
                  <div>
                    <label for="dateTo" class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                    <input type="date" id="dateTo" class="px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition text-sm">
                  </div>
                  <button id="clearFilters" class="px-3 py-2 text-gray-500 hover:text-gray-700 text-sm underline">
                    Limpiar
                  </button>
                </div>
              </div>
            </div>

            <!-- Lista de Documentos -->
            <div id="documentsList">
              {allDocuments && allDocuments.length > 0 ? (
                <div class="divide-y divide-gray-100">
                  {allDocuments.map((doc: any) => {
                    const isInvoice = doc.docType === 'invoice';
                    const status = isInvoice ? getStatusBadge(doc.status) : getCreditNoteStatusBadge(doc.status);
                    const items = doc.items as any[] || [];
                    const docNumber = isInvoice ? doc.invoice_number : doc.credit_note_number;
                    const issueDate = doc.issue_date || doc.created_at;
                    
                    return (
                      <div 
                        class={`document-item p-6 hover:bg-gray-50 transition ${!isInvoice ? 'bg-red-50/30' : ''}`}
                        data-type={doc.docType}
                        data-date={issueDate}
                      >
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                          <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                              {/* Icono según tipo */}
                              {isInvoice ? (
                                <span class="w-8 h-8 bg-primary/10 rounded-lg flex items-center justify-center">
                                  <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                  </svg>
                                </span>
                              ) : (
                                <span class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                  <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"/>
                                  </svg>
                                </span>
                              )}
                              
                              <div>
                                <span class={`font-mono font-semibold ${isInvoice ? 'text-primary' : 'text-red-600'}`}>
                                  {docNumber}
                                </span>
                                <span class={`ml-2 px-2 py-0.5 text-xs font-medium rounded-full ${isInvoice ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}`}>
                                  {isInvoice ? 'Factura' : 'Nota de Crédito'}
                                </span>
                              </div>
                              
                              <span class={`px-2 py-0.5 text-xs font-medium rounded-full ${status.class}`}>
                                {status.text}
                              </span>
                            </div>
                            <p class="text-sm text-gray-500 mb-1">
                              {formatDate(issueDate)}
                            </p>
                            {!isInvoice && doc.reason && (
                              <p class="text-sm text-gray-600 italic">
                                {doc.reason}
                              </p>
                            )}
                            {isInvoice && (
                              <p class="text-sm text-gray-600">
                                {items.length} {items.length === 1 ? 'artículo' : 'artículos'}
                              </p>
                            )}
                          </div>
                          
                          <div class="flex items-center gap-6">
                            <div class="text-right">
                              <p class="text-sm text-gray-500">{isInvoice ? 'Total' : 'Importe Abonado'}</p>
                              <p class={`text-lg font-bold ${isInvoice ? 'text-gray-900' : 'text-red-600'}`}>
                                {!isInvoice && '-'}{formatCurrency(doc.total)}
                              </p>
                            </div>
                            
                            <div class="flex items-center gap-2">
                              <a
                                href={isInvoice ? `/api/invoices/${doc.id}` : `/api/credit-notes/${doc.id}`}
                                target="_blank"
                                class={`inline-flex items-center gap-2 px-4 py-2 ${isInvoice ? 'bg-primary hover:bg-primary-dark' : 'bg-red-600 hover:bg-red-700'} text-white rounded-lg transition font-medium text-sm`}
                              >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                Ver
                              </a>
                              <a
                                href={isInvoice ? `/api/invoices/${doc.id}/pdf` : `/api/credit-notes/${doc.id}/pdf`}
                                class="inline-flex items-center gap-2 px-4 py-2 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium text-sm"
                                title="Descargar PDF"
                              >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                PDF
                              </a>
                            </div>
                          </div>
                        </div>
                        
                        {/* Items preview para facturas */}
                        {isInvoice && items.length > 0 && (
                          <div class="mt-4 pt-4 border-t border-gray-100">
                            <div class="flex flex-wrap gap-2">
                              {items.slice(0, 3).map((item: any) => (
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                  {item.name} x{item.quantity}
                                </span>
                              ))}
                              {items.length > 3 && (
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                  +{items.length - 3} más
                                </span>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              ) : (
                <div class="p-12 text-center" id="emptyState">
                  <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <h3 class="text-lg font-semibold text-gray-900 mb-2">No tienes facturas</h3>
                  <p class="text-gray-500 mb-6">
                    Las facturas aparecerán aquí después de completar tu primera compra.
                  </p>
                  <a
                    href="/tienda"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition font-medium"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                    </svg>
                    Ir a la tienda
                  </a>
                </div>
              )}
            </div>

            <!-- Mensaje cuando no hay resultados (oculto por defecto) -->
            <div id="noResults" class="p-12 text-center hidden">
              <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-gray-900 mb-2">No hay resultados</h3>
              <p class="text-gray-500 mb-6">
                No se encontraron documentos con los filtros seleccionados.
              </p>
              <button id="resetFilters" class="text-primary hover:text-primary-dark font-medium underline">
                Quitar filtros
              </button>
            </div>
          </div>

          <!-- Info Card -->
          <div class="mt-6 bg-blue-50 border border-blue-100 rounded-xl p-6">
            <div class="flex gap-4">
              <div class="flex-shrink-0">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold text-blue-900 mb-1">Información sobre documentos</h4>
                <ul class="text-sm text-blue-700 space-y-1">
                  <li>• Las <strong>facturas</strong> se generan automáticamente después de cada compra completada.</li>
                  <li>• Las <strong>notas de crédito</strong> se crean cuando cancelas un pedido o realizas una devolución.</li>
                  <li>• Puedes descargar cualquier documento en formato PDF haciendo clic en el botón correspondiente.</li>
                  <li>• También recibirás una copia de cada documento por correo electrónico.</li>
                </ul>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // Filtros de documentos
  document.addEventListener('DOMContentLoaded', () => {
    const filterType = document.getElementById('filterType') as HTMLSelectElement;
    const filterDate = document.getElementById('filterDate') as HTMLSelectElement;
    const dateFrom = document.getElementById('dateFrom') as HTMLInputElement;
    const dateTo = document.getElementById('dateTo') as HTMLInputElement;
    const clearFilters = document.getElementById('clearFilters');
    const resetFilters = document.getElementById('resetFilters');
    const noResults = document.getElementById('noResults');
    const documentItems = document.querySelectorAll('.document-item');

    function applyFilters() {
      const typeValue = filterType?.value || 'all';
      const dateValue = filterDate?.value || 'all';
      const fromDate = dateFrom?.value ? new Date(dateFrom.value) : null;
      const toDate = dateTo?.value ? new Date(dateTo.value + 'T23:59:59') : null;

      let visibleCount = 0;

      documentItems.forEach((item) => {
        const el = item as HTMLElement;
        const docType = el.dataset.type;
        const docDate = new Date(el.dataset.date || '');
        let show = true;

        // Filtro por tipo
        if (typeValue !== 'all' && docType !== typeValue) {
          show = false;
        }

        // Filtro por fecha predefinida
        if (show && dateValue !== 'all') {
          const now = new Date();
          const docDateMs = docDate.getTime();

          switch (dateValue) {
            case 'last30':
              const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
              show = docDateMs >= thirtyDaysAgo.getTime();
              break;
            case 'last90':
              const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
              show = docDateMs >= ninetyDaysAgo.getTime();
              break;
            case 'thisYear':
              show = docDate.getFullYear() === now.getFullYear();
              break;
            case 'lastYear':
              show = docDate.getFullYear() === now.getFullYear() - 1;
              break;
          }
        }

        // Filtro por rango de fechas personalizado
        if (show && fromDate) {
          show = docDate >= fromDate;
        }
        if (show && toDate) {
          show = docDate <= toDate;
        }

        el.style.display = show ? '' : 'none';
        if (show) visibleCount++;
      });

      // Mostrar/ocultar mensaje de no resultados
      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount > 0 || documentItems.length === 0);
      }
    }

    function resetAllFilters() {
      if (filterType) filterType.value = 'all';
      if (filterDate) filterDate.value = 'all';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';
      applyFilters();
    }

    // Event listeners
    filterType?.addEventListener('change', applyFilters);
    filterDate?.addEventListener('change', () => {
      // Limpiar fechas personalizadas al seleccionar predefinida
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';
      applyFilters();
    });
    dateFrom?.addEventListener('change', () => {
      if (filterDate) filterDate.value = 'all'; // Reset predefinido
      applyFilters();
    });
    dateTo?.addEventListener('change', () => {
      if (filterDate) filterDate.value = 'all'; // Reset predefinido
      applyFilters();
    });
    clearFilters?.addEventListener('click', resetAllFilters);
    resetFilters?.addEventListener('click', resetAllFilters);
  });
</script>

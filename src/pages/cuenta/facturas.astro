---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * PÁGINA: Mis Facturas
 * Lista todas las facturas del usuario con opción de descarga
 * ═══════════════════════════════════════════════════════════════════════════
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabase } from '../../lib/supabase/client';

// Verificar autenticación
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

if (!accessToken || !refreshToken || !supabase) {
  return Astro.redirect('/login?redirect=/cuenta/facturas');
}

const { data: sessionData, error: sessionError } = await supabase.auth.setSession({
  access_token: accessToken,
  refresh_token: refreshToken,
});

if (sessionError || !sessionData.user) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/login?redirect=/cuenta/facturas');
}

const user = sessionData.user;

// Obtener facturas del usuario
const { data: invoices, error: invoicesError } = await supabase
  .from('invoices')
  .select('*')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false });

// Obtener notas de crédito (facturas de abono)
const { data: creditNotes, error: creditNotesError } = await supabase
  .from('credit_notes')
  .select('*')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false });

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('es-ES', {
    day: '2-digit',
    month: 'long',
    year: 'numeric'
  });
};

const formatCurrency = (cents: number) => {
  return (cents / 100).toFixed(2) + '€';
};

const getStatusBadge = (status: string) => {
  switch (status) {
    case 'paid':
      return { text: 'Pagada', class: 'bg-green-100 text-green-800' };
    case 'pending':
      return { text: 'Pendiente', class: 'bg-yellow-100 text-yellow-800' };
    case 'cancelled':
      return { text: 'Cancelada', class: 'bg-red-100 text-red-800' };
    case 'refunded':
      return { text: 'Reembolsada', class: 'bg-purple-100 text-purple-800' };
    default:
      return { text: status, class: 'bg-gray-100 text-gray-800' };
  }
};

const getCreditNoteStatusBadge = (status: string) => {
  switch (status) {
    case 'refunded':
      return { text: 'Abonada', class: 'bg-green-100 text-green-800' };
    case 'pending':
      return { text: 'Pendiente', class: 'bg-yellow-100 text-yellow-800' };
    case 'cancelled':
      return { text: 'Cancelada', class: 'bg-red-100 text-red-800' };
    default:
      return { text: status, class: 'bg-gray-100 text-gray-800' };
  }
};
---

<BaseLayout title="Mis Facturas | FashionMarket">
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="container mx-auto px-4">
      <!-- Breadcrumb -->
      <nav class="mb-8">
        <ol class="flex items-center space-x-2 text-sm">
          <li><a href="/" class="text-gray-500 hover:text-primary transition">Inicio</a></li>
          <li><span class="text-gray-300">/</span></li>
          <li><a href="/cuenta" class="text-gray-500 hover:text-primary transition">Mi Cuenta</a></li>
          <li><span class="text-gray-300">/</span></li>
          <li><span class="text-primary font-medium">Facturas</span></li>
        </ol>
      </nav>

      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Sidebar -->
        <aside class="lg:w-64 flex-shrink-0">
          <nav class="bg-white rounded-xl shadow-sm p-4 sticky top-24">
            <h3 class="font-semibold text-gray-900 mb-4">Mi Cuenta</h3>
            <ul class="space-y-1">
              <li>
                <a href="/cuenta" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                  </svg>
                  Panel General
                </a>
              </li>
              <li>
                <a href="/cuenta/pedidos" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                  </svg>
                  Mis Pedidos
                </a>
              </li>
              <li>
                <a href="/cuenta/facturas" class="flex items-center gap-3 px-4 py-2.5 rounded-lg bg-primary/10 text-primary font-medium">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  Facturas
                </a>
              </li>
              <li>
                <a href="/cuenta/favoritos" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  Favoritos
                </a>
              </li>
              <li>
                <a href="/cuenta/direcciones" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                  Direcciones
                </a>
              </li>
              <li>
                <a href="/cuenta/perfil" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  Mi Perfil
                </a>
              </li>
            </ul>
          </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1">
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <!-- Header -->
            <div class="p-6 border-b border-gray-100">
              <div class="flex items-center justify-between">
                <div>
                  <h1 class="text-2xl font-bold text-gray-900">Mis Facturas</h1>
                  <p class="text-gray-500 mt-1">Descarga tus facturas de compra</p>
                </div>
                <div class="flex items-center gap-2 bg-primary/10 text-primary px-4 py-2 rounded-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <span class="font-semibold">{invoices?.length || 0}</span>
                  <span>facturas</span>
                </div>
              </div>
            </div>

            <!-- Invoices List -->
            {invoices && invoices.length > 0 ? (
              <div class="divide-y divide-gray-100">
                {invoices.map((invoice: any) => {
                  const status = getStatusBadge(invoice.status);
                  const items = invoice.items as any[];
                  return (
                    <div class="p-6 hover:bg-gray-50 transition">
                      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex-1">
                          <div class="flex items-center gap-3 mb-2">
                            <span class="font-mono font-semibold text-primary">{invoice.invoice_number}</span>
                            <span class={`px-2 py-0.5 text-xs font-medium rounded-full ${status.class}`}>
                              {status.text}
                            </span>
                          </div>
                          <p class="text-sm text-gray-500 mb-2">
                            {formatDate(invoice.issue_date)}
                          </p>
                          <p class="text-sm text-gray-600">
                            {items.length} {items.length === 1 ? 'artículo' : 'artículos'}
                          </p>
                        </div>
                        
                        <div class="flex items-center gap-6">
                          <div class="text-right">
                            <p class="text-sm text-gray-500">Total</p>
                            <p class="text-lg font-bold text-gray-900">{formatCurrency(invoice.total)}</p>
                          </div>
                          
                          <div class="flex items-center gap-2">
                            <a
                              href={`/api/invoices/${invoice.id}`}
                              target="_blank"
                              class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition font-medium text-sm"
                            >
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                              </svg>
                              Ver
                            </a>
                            <button
                              onclick={`window.print(window.open('/api/invoices/${invoice.id}', '_blank'))`}
                              class="inline-flex items-center gap-2 px-4 py-2 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium text-sm"
                              title="Imprimir / Guardar PDF"
                            >
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                              </svg>
                              PDF
                            </button>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Items preview -->
                      <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="flex flex-wrap gap-2">
                          {items.slice(0, 3).map((item: any) => (
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                              {item.name} x{item.quantity}
                            </span>
                          ))}
                          {items.length > 3 && (
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                              +{items.length - 3} más
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div class="p-12 text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No tienes facturas</h3>
                <p class="text-gray-500 mb-6">
                  Las facturas aparecerán aquí después de completar tu primera compra.
                </p>
                <a
                  href="/tienda"
                  class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition font-medium"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                  </svg>
                  Ir a la tienda
                </a>
              </div>
            )}
          </div>

          <!-- Notas de Crédito (Facturas de Abono) -->
          {creditNotes && creditNotes.length > 0 && (
            <div class="bg-white rounded-xl shadow-sm overflow-hidden mt-6">
              <div class="p-6 border-b border-gray-100 bg-red-50">
                <div class="flex items-center justify-between">
                  <div>
                    <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                      <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"/>
                      </svg>
                      Notas de Crédito
                    </h2>
                    <p class="text-gray-600 mt-1 text-sm">Facturas de abono por devoluciones</p>
                  </div>
                  <div class="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"/>
                    </svg>
                    <span class="font-semibold">{creditNotes.length}</span>
                    <span>abono{creditNotes.length !== 1 ? 's' : ''}</span>
                  </div>
                </div>
              </div>
              
              <div class="divide-y divide-gray-100">
                {creditNotes.map((cn: any) => {
                  const status = getCreditNoteStatusBadge(cn.status);
                  const items = cn.items as any[];
                  return (
                    <div class="p-6 hover:bg-red-50/50 transition">
                      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex-1">
                          <div class="flex items-center gap-3 mb-2">
                            <span class="font-mono font-semibold text-red-600">{cn.credit_note_number}</span>
                            <span class={`px-2 py-0.5 text-xs font-medium rounded-full ${status.class}`}>
                              {status.text}
                            </span>
                          </div>
                          <p class="text-sm text-gray-500 mb-2">
                            {formatDate(cn.issue_date)}
                          </p>
                          <p class="text-sm text-gray-600">
                            {cn.reason}
                          </p>
                        </div>
                        
                        <div class="flex items-center gap-6">
                          <div class="text-right">
                            <p class="text-sm text-gray-500">Importe Abonado</p>
                            <p class="text-lg font-bold text-red-600">{formatCurrency(cn.total)}</p>
                          </div>
                          
                          <div class="flex items-center gap-2">
                            <a
                              href={`/api/credit-notes/${cn.id}`}
                              target="_blank"
                              class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium text-sm"
                            >
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                              </svg>
                              Ver
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          <!-- Info Card -->
          <div class="mt-6 bg-blue-50 border border-blue-100 rounded-xl p-6">
            <div class="flex gap-4">
              <div class="flex-shrink-0">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold text-blue-900 mb-1">Información sobre facturas</h4>
                <p class="text-sm text-blue-700">
                  Las facturas se generan automáticamente después de cada compra completada. 
                  También recibirás una copia por correo electrónico. Para descargar una factura en PDF, 
                  haz clic en "Ver" y usa la opción de imprimir (Ctrl+P) seleccionando "Guardar como PDF".
                </p>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</BaseLayout>

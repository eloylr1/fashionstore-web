---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Configuración de Cuenta
 * Preferencias y privacidad
 * ═══════════════════════════════════════════════════════════════════════════
 */

export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabase } from '../../lib/supabase/client';

// Verificar autenticación
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

if (!accessToken || !refreshToken || !supabase) {
  return Astro.redirect('/login?redirect=/cuenta/configuracion');
}

const { data: sessionData, error: sessionError } = await supabase.auth.setSession({
  access_token: accessToken,
  refresh_token: refreshToken,
});

if (sessionError || !sessionData.user) {
  return Astro.redirect('/login?redirect=/cuenta/configuracion');
}

const user = sessionData.user;
---

<BaseLayout title="Configuración | FashionMarket">
  <main class="min-h-screen bg-cream py-8 lg:py-12">
    <div class="container-custom max-w-3xl">
      <!-- Breadcrumb -->
      <nav class="mb-6">
        <ol class="flex items-center gap-2 text-sm text-charcoal-500">
          <li><a href="/" class="hover:text-navy-900 transition-colors">Inicio</a></li>
          <li>/</li>
          <li><a href="/cuenta" class="hover:text-navy-900 transition-colors">Mi Cuenta</a></li>
          <li>/</li>
          <li class="text-navy-900 font-medium">Configuración</li>
        </ol>
      </nav>

      <!-- Mensaje de éxito/error -->
      <div id="config-message" class="hidden p-4 rounded-lg mb-6"></div>

      <!-- Preferencias de comunicación -->
      <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="p-6 border-b border-charcoal-100">
          <h2 class="text-xl font-serif text-navy-900">Preferencias de comunicación</h2>
          <p class="text-charcoal-500 text-sm mt-1">Gestiona cómo nos comunicamos contigo</p>
        </div>
        <div class="p-6 space-y-4">
          <label class="flex items-center justify-between cursor-pointer">
            <div>
              <span class="font-medium text-navy-900">Novedades y ofertas</span>
              <p class="text-sm text-charcoal-500">Recibe información sobre nuevos productos y promociones</p>
            </div>
            <input type="checkbox" checked class="w-5 h-5 rounded border-charcoal-300 text-gold-matte focus:ring-gold-matte" />
          </label>

          <label class="flex items-center justify-between cursor-pointer">
            <div>
              <span class="font-medium text-navy-900">Actualizaciones de pedidos</span>
              <p class="text-sm text-charcoal-500">Notificaciones sobre el estado de tus pedidos</p>
            </div>
            <input type="checkbox" checked disabled class="w-5 h-5 rounded border-charcoal-300 text-gold-matte focus:ring-gold-matte cursor-not-allowed" />
          </label>

          <label class="flex items-center justify-between cursor-pointer">
            <div>
              <span class="font-medium text-navy-900">Recordatorios de carrito</span>
              <p class="text-sm text-charcoal-500">Te avisamos si dejaste productos en tu carrito</p>
            </div>
            <input type="checkbox" class="w-5 h-5 rounded border-charcoal-300 text-gold-matte focus:ring-gold-matte" />
          </label>
        </div>
      </div>

      <!-- Privacidad -->
      <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="p-6 border-b border-charcoal-100">
          <h2 class="text-xl font-serif text-navy-900">Privacidad</h2>
          <p class="text-charcoal-500 text-sm mt-1">Gestiona tus datos y privacidad</p>
        </div>
        <div class="p-6 space-y-4">
          <a 
            href="/privacidad"
            class="flex items-center justify-between p-4 border border-charcoal-200 rounded-lg hover:bg-charcoal-50 transition-colors"
          >
            <div>
              <span class="font-medium text-navy-900">Política de privacidad</span>
              <p class="text-sm text-charcoal-500">Consulta cómo tratamos tus datos</p>
            </div>
            <svg class="w-5 h-5 text-charcoal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </a>
        </div>
      </div>

      <!-- Zona de peligro -->
      <div class="bg-white rounded-lg shadow-sm border border-red-200">
        <div class="p-6 border-b border-red-100">
          <h2 class="text-xl font-serif text-red-700">Zona de peligro</h2>
          <p class="text-red-600 text-sm mt-1">Acciones irreversibles</p>
        </div>
        <div class="p-6">
          <div class="flex items-center justify-between">
            <div>
              <span class="font-medium text-navy-900">Eliminar cuenta</span>
              <p class="text-sm text-charcoal-500">Esta acción eliminará permanentemente tu cuenta y todos tus datos</p>
            </div>
            <button
              type="button"
              id="btn-delete-account"
              class="px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition-colors text-sm font-medium"
            >
              Eliminar cuenta
            </button>
          </div>
        </div>
      </div>

      <!-- Volver -->
      <div class="mt-6">
        <a href="/cuenta" class="text-charcoal-600 hover:text-navy-900 transition-colors">
          ← Volver a Mi Cuenta
        </a>
      </div>
    </div>
  </main>

  <!-- Modal de confirmación de eliminación -->
  <div id="delete-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="delete-modal-backdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative">
        <div class="text-center mb-6">
          <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
          </div>
          <h3 class="text-xl font-serif text-navy-900 mb-2">Eliminar cuenta permanentemente</h3>
          <p class="text-charcoal-500 text-sm">
            Esta acción no se puede deshacer. Se eliminarán todos tus datos personales, direcciones, historial de pedidos y preferencias asociados a tu cuenta.
          </p>
        </div>
        <p class="text-sm text-charcoal-600 mb-4 text-center">
          Escribe <strong class="text-red-600">ELIMINAR</strong> para confirmar:
        </p>
        <input 
          type="text" 
          id="delete-confirm-input"
          class="w-full px-4 py-3 border border-charcoal-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent text-center mb-4"
          placeholder="Escribe ELIMINAR"
          autocomplete="off"
        />
        <div class="flex gap-3">
          <button
            type="button"
            id="btn-cancel-delete"
            class="flex-1 px-4 py-3 border border-charcoal-200 rounded-lg text-charcoal-600 hover:bg-charcoal-50 transition-colors font-medium"
          >
            Cancelar
          </button>
          <button
            type="button"
            id="btn-confirm-delete"
            disabled
            class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Eliminar mi cuenta
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const deleteBtn = document.getElementById('btn-delete-account');
    const deleteModal = document.getElementById('delete-modal');
    const deleteBackdrop = document.getElementById('delete-modal-backdrop');
    const cancelBtn = document.getElementById('btn-cancel-delete');
    const confirmBtn = document.getElementById('btn-confirm-delete') as HTMLButtonElement;
    const confirmInput = document.getElementById('delete-confirm-input') as HTMLInputElement;
    const messageDiv = document.getElementById('config-message');

    function showModal() {
      deleteModal?.classList.remove('hidden');
      confirmInput.value = '';
      confirmBtn.disabled = true;
    }

    function hideModal() {
      deleteModal?.classList.add('hidden');
      confirmInput.value = '';
      confirmBtn.disabled = true;
    }

    deleteBtn?.addEventListener('click', showModal);
    deleteBackdrop?.addEventListener('click', hideModal);
    cancelBtn?.addEventListener('click', hideModal);

    confirmInput?.addEventListener('input', () => {
      confirmBtn.disabled = confirmInput.value !== 'ELIMINAR';
    });

    confirmBtn?.addEventListener('click', async () => {
      if (confirmInput.value !== 'ELIMINAR') return;

      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Eliminando...';

      try {
        const response = await fetch('/api/auth/delete-account', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
        });

        const data = await response.json();

        if (response.ok) {
          hideModal();
          if (messageDiv) {
            messageDiv.className = 'p-4 bg-green-50 border border-green-200 rounded-lg text-green-700 mb-6';
            messageDiv.textContent = 'Tu cuenta ha sido eliminada correctamente. Redirigiendo...';
            messageDiv.classList.remove('hidden');
          }
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
        } else {
          hideModal();
          if (messageDiv) {
            messageDiv.className = 'p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-6';
            messageDiv.textContent = data.error || 'Error al eliminar la cuenta. Inténtalo de nuevo.';
            messageDiv.classList.remove('hidden');
          }
          confirmBtn.textContent = 'Eliminar mi cuenta';
          confirmBtn.disabled = false;
        }
      } catch (err) {
        hideModal();
        if (messageDiv) {
          messageDiv.className = 'p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-6';
          messageDiv.textContent = 'Error de conexión. Inténtalo de nuevo.';
          messageDiv.classList.remove('hidden');
        }
        confirmBtn.textContent = 'Eliminar mi cuenta';
        confirmBtn.disabled = false;
      }
    });
  </script>
</BaseLayout>

---
/**
 * FASHIONMARKET CHATBOT - TEXTO VISIBLE
 */
---

<div id="cb-widget">
  <button id="cb-fab" type="button" aria-label="Abrir chat">
    <svg id="cb-icon-chat" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <svg id="cb-icon-close" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>

  <div id="cb-panel" style="display:none">
    <div id="cb-header">
      <div id="cb-avatar">üõçÔ∏è</div>
      <div id="cb-info">
        <span id="cb-title">Asistente</span>
        <span id="cb-status">‚óè En l√≠nea</span>
      </div>
      <button id="cb-refresh" type="button">‚Üª</button>
      <button id="cb-close" type="button">‚úï</button>
    </div>
    <div id="cb-body"></div>
    <div id="cb-foot">
      <input type="text" id="cb-input" placeholder="Escribe tu mensaje...">
      <button id="cb-send" type="button">‚û§</button>
    </div>
  </div>
</div>

<style>
#cb-widget{position:fixed;bottom:20px;right:20px;z-index:99999;font-family:system-ui,-apple-system,sans-serif}
#cb-fab{width:60px;height:60px;border-radius:50%;background:#c9a227;color:#000;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(201,162,39,0.5)}
#cb-fab:hover{transform:scale(1.1)}
#cb-panel{position:absolute;bottom:75px;right:0;width:380px;height:550px;background:#0d0d1a;border-radius:20px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.6);display:flex;flex-direction:column}
#cb-header{background:#0a0a14;padding:16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #222}
#cb-avatar{width:48px;height:48px;background:#c9a227;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px}
#cb-info{flex:1}
#cb-title{display:block;color:#fff;font-size:18px;font-weight:700}
#cb-status{display:block;color:#22c55e;font-size:13px;font-weight:600}
#cb-refresh,#cb-close{width:36px;height:36px;background:#1a1a2e;border:none;color:#aaa;font-size:18px;cursor:pointer;border-radius:8px}
#cb-refresh:hover,#cb-close:hover{background:#2a2a4a;color:#fff}
#cb-body{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px;background:#0d0d1a}
#cb-body::-webkit-scrollbar{width:5px}
#cb-body::-webkit-scrollbar-thumb{background:#333;border-radius:3px}

.msg{max-width:90%;animation:slide .3s ease}
@keyframes slide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg-u{align-self:flex-end}
.msg-b{align-self:flex-start}
.bbl{padding:14px 18px;border-radius:18px;font-size:16px;line-height:1.6}
.msg-u .bbl{background:#c9a227;color:#000;font-weight:600;border-bottom-right-radius:4px}
.msg-b .bbl{background:#1e1e38;color:#FFFFFF;font-weight:500;border-bottom-left-radius:4px;border:1px solid #333}

.chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
.chip{display:inline-block;background:#252545;color:#FFFFFF;border:2px solid #c9a227;padding:12px 18px;border-radius:25px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s}
.chip:hover{background:#c9a227;color:#000;transform:translateY(-2px)}

.prods{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
.prod{background:#1a1a30;border-radius:14px;overflow:hidden;text-decoration:none;position:relative;border:1px solid #2a2a4a}
.prod:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.4);border-color:#c9a227}
.badge{position:absolute;top:8px;left:8px;background:#c9a227;color:#000;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:800;z-index:2}
.prod-img{width:100%;height:100px;object-fit:cover;background:#0a0a14}
.prod-info{padding:10px}
.prod-name{color:#FFFFFF;font-size:14px;font-weight:700;margin:0 0 4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.prod-price{color:#ffd700;font-size:16px;font-weight:800;margin:0}

.loading{display:flex;gap:6px;padding:10px 0}
.loading span{width:8px;height:8px;background:#c9a227;border-radius:50%;animation:bounce 1.4s infinite ease-in-out both}
.loading span:nth-child(1){animation-delay:-.32s}
.loading span:nth-child(2){animation-delay:-.16s}
@keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

#cb-foot{padding:14px;background:#0a0a14;border-top:1px solid #222;display:flex;gap:10px}
#cb-input{flex:1;background:#1a1a2e;border:2px solid #333;border-radius:25px;padding:14px 18px;color:#FFFFFF;font-size:15px}
#cb-input:focus{outline:none;border-color:#c9a227}
#cb-input::placeholder{color:#888}
#cb-send{width:50px;height:50px;background:#c9a227;color:#000;border:none;border-radius:50%;font-size:20px;cursor:pointer;font-weight:bold}
#cb-send:hover{transform:scale(1.05)}

@media(max-width:480px){#cb-widget{bottom:15px;right:15px}#cb-panel{width:calc(100vw - 30px);height:70vh}#cb-fab{width:55px;height:55px}}
</style>

<script is:inline>
(function(){
var FAQ={
envios:"üì¶ <b>Env√≠os:</b><br>‚Ä¢ Espa√±a peninsular: GRATIS +50‚Ç¨<br>‚Ä¢ Entrega: 2-4 d√≠as laborables<br>‚Ä¢ Baleares/Canarias: Consultar",
devoluciones:"‚Ü©Ô∏è <b>Devoluciones:</b><br>‚Ä¢ 30 d√≠as para devolver<br>‚Ä¢ Producto sin usar<br>‚Ä¢ GRATIS en tienda",
pagos:"üí≥ <b>Pagos:</b><br>‚Ä¢ Tarjeta (Visa, Mastercard)<br>‚Ä¢ PayPal<br>‚Ä¢ Bizum<br>‚Ä¢ Contrareembolso (+3‚Ç¨)",
tallas:"üìè <b>Tallas:</b><br>Consulta la gu√≠a en cada producto. Si dudas, elige la mayor.",
contacto:"üìû <b>Contacto:</b><br>‚Ä¢ info@fashionmarket.es<br>‚Ä¢ WhatsApp: +34 612 345 678<br>‚Ä¢ L-V 9:00-18:00"
};

var fab=document.getElementById("cb-fab");
var panel=document.getElementById("cb-panel");
var iconChat=document.getElementById("cb-icon-chat");
var iconClose=document.getElementById("cb-icon-close");
var body=document.getElementById("cb-body");
var input=document.getElementById("cb-input");
var sendBtn=document.getElementById("cb-send");
var refreshBtn=document.getElementById("cb-refresh");
var closeBtn=document.getElementById("cb-close");
if(!fab||!panel||!body||!input)return;

var isOpen=false;
var chips=[];

function esc(s){if(!s)return"";var d=document.createElement("div");d.textContent=s;return d.innerHTML;}

function toggle(){
isOpen=!isOpen;
panel.style.display=isOpen?"flex":"none";
iconChat.style.display=isOpen?"none":"block";
iconClose.style.display=isOpen?"block":"none";
if(isOpen&&body.children.length===0)welcome();
}

function userMsg(t){
var d=document.createElement("div");
d.className="msg msg-u";
d.innerHTML='<div class="bbl">'+esc(t)+'</div>';
body.appendChild(d);
body.scrollTop=body.scrollHeight;
}

function botMsg(t,ch,pr){
var d=document.createElement("div");
d.className="msg msg-b";
var h='<div class="bbl">'+t+'</div>';

if(ch&&ch.length>0){
chips=ch;
h+='<div class="chips">';
for(var i=0;i<ch.length;i++){
h+='<button type="button" class="chip" data-i="'+i+'">'+esc(ch[i])+'</button>';
}
h+='</div>';
}

if(pr&&pr.length>0){
h+='<div class="prods">';
for(var j=0;j<pr.length;j++){
var p=pr[j];
h+='<a href="'+esc(p.url)+'" class="prod">';
if(p.badge)h+='<span class="badge">'+esc(p.badge)+'</span>';
if(p.img)h+='<img src="'+esc(p.img)+'" alt="'+esc(p.name)+'" class="prod-img" loading="lazy" onerror="this.style.background=\'#1a1a2e\'">';
else h+='<div class="prod-img" style="display:flex;align-items:center;justify-content:center;color:#666">üì∑</div>';
h+='<div class="prod-info"><p class="prod-name">'+esc(p.name)+'</p><p class="prod-price">'+esc(p.price)+' ‚Ç¨</p></div></a>';
}
h+='</div>';
}

d.innerHTML=h;
body.appendChild(d);
body.scrollTop=body.scrollHeight;

var btns=d.querySelectorAll(".chip");
for(var k=0;k<btns.length;k++){
btns[k].addEventListener("click",function(){
var idx=parseInt(this.getAttribute("data-i"));
if(chips[idx])handleChip(chips[idx]);
});
}
}

function loading(){
var d=document.createElement("div");
d.className="msg msg-b";
d.id="ld";
d.innerHTML='<div class="loading"><span></span><span></span><span></span></div>';
body.appendChild(d);
body.scrollTop=body.scrollHeight;
}

function hideLoading(){var l=document.getElementById("ld");if(l)l.remove();}

function fetch_prods(f,cb){
loading();
fetch("/api/chatbot/products?filter="+(f||"popular")+"&limit=4")
.then(function(r){return r.json();})
.then(function(d){hideLoading();cb(d.products||[]);})
.catch(function(){hideLoading();cb([]);});
}

function search_prods(q,cb){
loading();
fetch("/api/chatbot/products?q="+encodeURIComponent(q)+"&limit=4")
.then(function(r){return r.json();})
.then(function(d){hideLoading();cb(d.products||[]);})
.catch(function(){hideLoading();cb([]);});
}

function fetch_cat(c,cb){
loading();
fetch("/api/chatbot/products?category="+encodeURIComponent(c)+"&limit=4")
.then(function(r){return r.json();})
.then(function(d){hideLoading();cb(d.products||[]);})
.catch(function(){hideLoading();cb([]);});
}

function welcome(){
setTimeout(function(){
fetch_prods("popular",function(pr){
botMsg("¬°Hola! üëã Soy tu asistente de FashionMarket.<br>¬øQu√© buscas hoy?",
["üî• Ver m√°s vendidos","‚ú® Novedades","üîç Buscar traje","‚ùì Ayuda"],
pr.length>0?pr:null);
});
},300);
}

function handleChip(c){
userMsg(c);
var l=c.toLowerCase();

if(l.indexOf("vendidos")!==-1||l.indexOf("popular")!==-1){
fetch_prods("popular",function(pr){
if(pr.length>0)botMsg("üî• Nuestros m√°s vendidos:",["‚ú® Novedades","üõí Ver tienda","‚ùì Ayuda"],pr);
else botMsg("No encontr√© productos. <a href='/tienda' style='color:#c9a227'>Ver tienda</a>",["‚ú® Novedades","‚ùì Ayuda"],null);
});
}
else if(l.indexOf("novedades")!==-1||l.indexOf("nuevo")!==-1){
fetch_prods("new",function(pr){
if(pr.length>0)botMsg("‚ú® Las √∫ltimas novedades:",["üî• M√°s vendidos","üõí Ver tienda","‚ùì Ayuda"],pr);
else botMsg("No hay novedades. <a href='/tienda' style='color:#c9a227'>Ver tienda</a>",["üî• M√°s vendidos","‚ùì Ayuda"],null);
});
}
else if(l.indexOf("traje")!==-1||l.indexOf("blazer")!==-1){
fetch_cat("trajes",function(pr){
if(pr.length>0)botMsg("üëî Nuestra selecci√≥n de trajes:",["üî• M√°s vendidos","‚ùì Ayuda"],pr);
else botMsg("No hay trajes disponibles. <a href='/tienda' style='color:#c9a227'>Ver tienda</a>",["üî• M√°s vendidos","‚ùì Ayuda"],null);
});
}
else if(l.indexOf("camisa")!==-1){
fetch_cat("camisas",function(pr){
if(pr.length>0)botMsg("üëï Nuestras camisas:",["üî• M√°s vendidos","‚ùì Ayuda"],pr);
else botMsg("No hay camisas. <a href='/tienda' style='color:#c9a227'>Ver tienda</a>",["üî• M√°s vendidos","‚ùì Ayuda"],null);
});
}
else if(l.indexOf("tienda")!==-1){window.location.href="/tienda";}
else if(l.indexOf("ayuda")!==-1){botMsg("¬øEn qu√© puedo ayudarte?",["üì¶ Env√≠os","‚Ü©Ô∏è Devoluciones","üí≥ Pagos","üìè Tallas","üìû Contacto"],null);}
else if(l.indexOf("env√≠o")!==-1||l.indexOf("envio")!==-1){botMsg(FAQ.envios,["üî• Ver productos","‚ùì M√°s ayuda"],null);}
else if(l.indexOf("devoluc")!==-1){botMsg(FAQ.devoluciones,["üî• Ver productos","‚ùì M√°s ayuda"],null);}
else if(l.indexOf("pago")!==-1){botMsg(FAQ.pagos,["üî• Ver productos","‚ùì M√°s ayuda"],null);}
else if(l.indexOf("talla")!==-1){botMsg(FAQ.tallas,["üî• Ver productos","‚ùì M√°s ayuda"],null);}
else if(l.indexOf("contacto")!==-1){botMsg(FAQ.contacto,["üî• Ver productos","‚ùì M√°s ayuda"],null);}
else{
var q=c.replace(/[üî•‚ú®üîç‚ùìüëîüëïüì¶‚Ü©Ô∏èüí≥üìèüìûüõí]/g,"").trim();
if(q){
search_prods(q,function(pr){
if(pr.length>0)botMsg("Encontr√© esto para ti:",["üî• M√°s vendidos","‚ùì Ayuda"],pr);
else botMsg("No encontr√© productos. ¬øProbamos otra cosa?",["üî• M√°s vendidos","‚ú® Novedades","‚ùì Ayuda"],null);
});
}else{botMsg("¬øEn qu√© puedo ayudarte?",["üî• M√°s vendidos","‚ú® Novedades","‚ùì Ayuda"],null);}
}
}

function handleInput(){
var t=input.value.trim();
if(!t)return;
input.value="";
userMsg(t);
var l=t.toLowerCase();

if(l==="hola"||l==="hey"||l==="buenas"){
fetch_prods("popular",function(pr){
botMsg("¬°Hola! üëã ¬øQu√© buscas hoy?",["üî• M√°s vendidos","‚ú® Novedades","‚ùì Ayuda"],pr.length>0?pr:null);
});
return;
}
if(l.indexOf("env√≠o")!==-1||l.indexOf("envio")!==-1){botMsg(FAQ.envios,["üî• Ver productos","‚ùì M√°s ayuda"],null);return;}
if(l.indexOf("devoluc")!==-1){botMsg(FAQ.devoluciones,["üî• Ver productos","‚ùì M√°s ayuda"],null);return;}
if(l.indexOf("pago")!==-1){botMsg(FAQ.pagos,["üî• Ver productos","‚ùì M√°s ayuda"],null);return;}
if(l.indexOf("talla")!==-1){botMsg(FAQ.tallas,["üî• Ver productos","‚ùì M√°s ayuda"],null);return;}
if(l.indexOf("contacto")!==-1||l.indexOf("telefono")!==-1){botMsg(FAQ.contacto,["üî• Ver productos","‚ùì M√°s ayuda"],null);return;}
if(l.indexOf("ayuda")!==-1){botMsg("¬øEn qu√© puedo ayudarte?",["üì¶ Env√≠os","‚Ü©Ô∏è Devoluciones","üí≥ Pagos","üìè Tallas","üìû Contacto"],null);return;}

search_prods(t,function(pr){
if(pr.length>0)botMsg("Encontr√© esto para \""+esc(t)+"\":",["üî• M√°s vendidos","‚ùì Ayuda"],pr);
else botMsg("No encontr√© productos para \""+esc(t)+"\". ¬øProbamos otra cosa?",["üî• M√°s vendidos","‚ú® Novedades","‚ùì Ayuda"],null);
});
}

function reset(){body.innerHTML="";chips=[];welcome();}

fab.addEventListener("click",toggle);
closeBtn.addEventListener("click",toggle);
refreshBtn.addEventListener("click",reset);
sendBtn.addEventListener("click",handleInput);
input.addEventListener("keypress",function(e){if(e.key==="Enter")handleInput();});
})();
</script>

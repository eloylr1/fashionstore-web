---
/**
 * FASHIONMARKET - Shop Chatbot Widget
 */
---

<!-- Bot√≥n flotante -->
<button 
  id="chatbot-toggle" 
  class="chatbot-toggle"
  aria-label="Abrir chat de ayuda"
>
  <svg class="chatbot-icon-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
  </svg>
  <svg class="chatbot-icon-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M18 6L6 18M6 6l12 12"></path>
  </svg>
  <span class="chatbot-badge"></span>
</button>

<!-- Panel del chat -->
<div id="chatbot-panel" class="chatbot-panel">
  <div class="chatbot-header">
    <div class="chatbot-header-info">
      <div class="chatbot-avatar">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
        </svg>
      </div>
      <div class="chatbot-header-text">
        <span class="chatbot-title">Asistente FashionMarket</span>
        <span class="chatbot-status">
          <span class="chatbot-status-dot"></span>
          Online
        </span>
      </div>
    </div>
    <button id="chatbot-close" class="chatbot-close">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18M6 6l12 12"></path>
      </svg>
    </button>
  </div>
  
  <div id="chatbot-messages" class="chatbot-messages"></div>
  
  <div class="chatbot-input-wrapper">
    <div class="chatbot-input-container">
      <input type="text" id="chatbot-input" class="chatbot-input" placeholder="Escribe tu mensaje..." autocomplete="off" />
      <button id="chatbot-send" class="chatbot-send">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<style>
  :root {
    --chat-primary: #0a1628;
    --chat-accent: #b8a067;
    --chat-bg: #ffffff;
    --chat-text: #1a1a1a;
    --chat-muted: #6b7280;
    --chat-border: #e5e7eb;
  }

  .chatbot-toggle {
    position: fixed;
    bottom: 28px;
    right: 28px;
    z-index: 9998;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--chat-primary);
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 8px 32px rgba(10, 22, 40, 0.4);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chatbot-toggle:hover {
    transform: scale(1.1);
  }

  .chatbot-toggle svg {
    width: 28px;
    height: 28px;
  }

  .chatbot-icon-close { display: none; }
  .chatbot-toggle.active .chatbot-icon-open { display: none; }
  .chatbot-toggle.active .chatbot-icon-close { display: block; }

  .chatbot-badge {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 16px;
    height: 16px;
    background: var(--chat-accent);
    border-radius: 50%;
    border: 2px solid white;
  }

  .chatbot-toggle.active .chatbot-badge { display: none; }

  .chatbot-panel {
    position: fixed;
    bottom: 108px;
    right: 28px;
    z-index: 9999;
    width: 400px;
    max-width: calc(100vw - 56px);
    height: 550px;
    max-height: calc(100vh - 160px);
    background: var(--chat-bg);
    border-radius: 20px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px) scale(0.95);
    transition: all 0.3s ease;
  }

  .chatbot-panel.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }

  @media (max-width: 480px) {
    .chatbot-panel {
      width: calc(100vw - 32px);
      right: 16px;
      bottom: 100px;
      height: calc(100vh - 140px);
    }
    .chatbot-toggle {
      bottom: 20px;
      right: 20px;
      width: 58px;
      height: 58px;
    }
  }

  .chatbot-header {
    background: linear-gradient(135deg, var(--chat-primary) 0%, #1a2d47 100%);
    color: white;
    padding: 18px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .chatbot-header-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .chatbot-avatar {
    width: 44px;
    height: 44px;
    background: rgba(255,255,255,0.15);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chatbot-avatar svg {
    width: 24px;
    height: 24px;
  }

  .chatbot-header-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .chatbot-title {
    font-weight: 600;
    font-size: 15px;
  }

  .chatbot-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    opacity: 0.9;
  }

  .chatbot-status-dot {
    width: 8px;
    height: 8px;
    background: #34d399;
    border-radius: 50%;
  }

  .chatbot-close {
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: background 0.2s;
  }

  .chatbot-close:hover {
    background: rgba(255,255,255,0.2);
  }

  .chatbot-close svg {
    width: 18px;
    height: 18px;
    display: block;
  }

  .chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: #f9fafb;
  }

  .chatbot-message {
    display: flex;
    flex-direction: column;
    max-width: 90%;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chatbot-message-user { align-self: flex-end; }
  .chatbot-message-bot { align-self: flex-start; }

  .chatbot-bubble {
    padding: 14px 18px;
    border-radius: 18px;
    font-size: 14px;
    line-height: 1.6;
  }

  .chatbot-message-user .chatbot-bubble {
    background: var(--chat-primary);
    color: white;
    border-bottom-right-radius: 6px;
  }

  .chatbot-message-bot .chatbot-bubble {
    background: white;
    color: var(--chat-text);
    border-bottom-left-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid var(--chat-border);
  }

  .chatbot-products {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
  }

  .chatbot-product-card {
    background: white;
    border: 1px solid var(--chat-border);
    border-radius: 12px;
    padding: 12px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    transition: all 0.2s;
  }

  .chatbot-product-card:hover {
    border-color: var(--chat-accent);
    box-shadow: 0 4px 12px rgba(184, 160, 103, 0.15);
  }

  .chatbot-product-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
  }

  .chatbot-product-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--chat-text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chatbot-product-price {
    font-size: 14px;
    font-weight: 700;
    color: var(--chat-accent);
  }

  .chatbot-product-btn {
    background: var(--chat-primary);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
  }

  .chatbot-product-btn:hover {
    background: var(--chat-accent);
  }

  /* CHIPS - Importante */
  .chatbot-chips {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
    margin-top: 14px !important;
    padding-top: 12px !important;
    border-top: 1px solid rgba(0,0,0,0.06) !important;
  }

  .chatbot-chip {
    display: inline-block !important;
    background: white !important;
    border: 2px solid var(--chat-border) !important;
    color: var(--chat-text) !important;
    padding: 10px 16px !important;
    border-radius: 24px !important;
    font-size: 13px !important;
    font-weight: 500 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    white-space: nowrap !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04) !important;
  }

  .chatbot-chip:hover {
    background: var(--chat-primary) !important;
    border-color: var(--chat-primary) !important;
    color: white !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(10, 22, 40, 0.2) !important;
  }

  .chatbot-input-wrapper {
    padding: 16px 20px;
    background: white;
    border-top: 1px solid var(--chat-border);
  }

  .chatbot-input-container {
    display: flex;
    gap: 10px;
    align-items: center;
    background: #f3f4f6;
    border: 2px solid var(--chat-border);
    border-radius: 28px;
    padding: 6px 6px 6px 18px;
    transition: all 0.2s;
  }

  .chatbot-input-container:focus-within {
    border-color: var(--chat-primary);
    background: white;
  }

  .chatbot-input {
    flex: 1;
    border: none;
    background: transparent;
    padding: 10px 0;
    font-size: 14px;
    outline: none;
    color: var(--chat-text);
  }

  .chatbot-send {
    width: 42px;
    height: 42px;
    background: var(--chat-primary);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .chatbot-send:hover {
    background: var(--chat-accent);
  }

  .chatbot-send svg {
    width: 18px;
    height: 18px;
  }

  .chatbot-link {
    color: var(--chat-accent);
    text-decoration: underline;
    font-weight: 500;
  }
</style>

<script>
(function() {
  // Datos del cat√°logo
  const CATALOG = [
    { id: "p001", name: "Sudadera Oversize Negra", category: "sudadera", tags: ["oversize", "urbano", "invierno", "casual"], price: 39.99, sizes: ["S", "M", "L", "XL"], colors: ["negro"], inStock: true, popularity: 95, url: "/tienda" },
    { id: "p002", name: "Camiseta B√°sica Blanca", category: "camiseta", tags: ["b√°sico", "casual", "verano"], price: 19.99, sizes: ["XS", "S", "M", "L", "XL"], colors: ["blanco"], inStock: true, popularity: 92, url: "/tienda" },
    { id: "p003", name: "Pantal√≥n Chino Beige", category: "pantalon", tags: ["elegante", "trabajo", "casual"], price: 49.99, sizes: ["38", "40", "42", "44", "46"], colors: ["beige"], inStock: true, popularity: 78, url: "/tienda?categoria=pantalones" },
    { id: "p004", name: "Blazer Slim Fit Azul", category: "blazer", tags: ["elegante", "trabajo", "formal"], price: 89.99, sizes: ["S", "M", "L", "XL"], colors: ["azul marino"], inStock: true, popularity: 85, url: "/tienda?categoria=trajes" },
    { id: "p005", name: "Jogger Deportivo Gris", category: "pantalon", tags: ["deportivo", "gym", "casual"], price: 34.99, sizes: ["S", "M", "L", "XL"], colors: ["gris"], inStock: true, popularity: 88, url: "/tienda?categoria=pantalones" },
    { id: "p006", name: "Camisa Oxford Celeste", category: "camisa", tags: ["elegante", "trabajo", "formal"], price: 44.99, sizes: ["S", "M", "L", "XL", "XXL"], colors: ["celeste"], inStock: true, popularity: 82, url: "/tienda?categoria=camisas" },
    { id: "p007", name: "Abrigo Largo Negro", category: "abrigo", tags: ["elegante", "invierno", "formal"], price: 129.99, sizes: ["S", "M", "L", "XL"], colors: ["negro"], inStock: true, popularity: 76, url: "/tienda" },
    { id: "p008", name: "Polo Cl√°sico Verde", category: "polo", tags: ["casual", "elegante", "verano"], price: 29.99, sizes: ["S", "M", "L", "XL"], colors: ["verde"], inStock: true, popularity: 71, url: "/tienda" },
    { id: "p009", name: "Sudadera Capucha Gris", category: "sudadera", tags: ["urbano", "casual", "invierno"], price: 45.99, sizes: ["S", "M", "L", "XL", "XXL"], colors: ["gris"], inStock: true, popularity: 90, url: "/tienda" },
    { id: "p010", name: "Traje Completo Antracita", category: "traje", tags: ["formal", "elegante", "evento", "boda"], price: 199.99, sizes: ["46", "48", "50", "52", "54"], colors: ["antracita"], inStock: true, popularity: 74, url: "/tienda?categoria=trajes" },
    { id: "p011", name: "Camiseta Estampada Urbana", category: "camiseta", tags: ["urbano", "casual", "streetwear"], price: 24.99, sizes: ["S", "M", "L", "XL"], colors: ["negro", "blanco"], inStock: true, popularity: 86, url: "/tienda" },
    { id: "p012", name: "Chaqueta Bomber Marr√≥n", category: "chaqueta", tags: ["urbano", "casual", "oto√±o"], price: 79.99, sizes: ["S", "M", "L", "XL"], colors: ["marr√≥n"], inStock: false, popularity: 80, url: "/tienda" }
  ];

  // FAQ
  const FAQ = {
    shipping: { keywords: ["env√≠o", "envio", "entrega", "llegar", "tarda", "gastos"], answer: "üì¶ Env√≠os gratis en pedidos +100‚Ç¨. Entrega en 2-4 d√≠as laborables en Espa√±a." },
    returns: { keywords: ["devoluci√≥n", "devolucion", "devolver", "cambio", "cambiar"], answer: "üîÑ 30 d√≠as para devolver. Gratis en tienda, 4,95‚Ç¨ recogida a domicilio." },
    payment: { keywords: ["pago", "pagar", "tarjeta", "paypal", "bizum"], answer: "üí≥ Aceptamos tarjeta, PayPal, Bizum y contrareembolso." },
    sizes: { keywords: ["talla", "tallas", "medidas", "qu√© talla"], answer: "üìè Gu√≠a de tallas: S(96-100cm), M(100-104cm), L(104-108cm), XL(108-112cm)." },
    contact: { keywords: ["contacto", "contactar", "tel√©fono", "email"], answer: "üìû Email: hola@fashionmarket.com | WhatsApp: +34 612 345 678" },
    discount: { keywords: ["descuento", "oferta", "cup√≥n", "c√≥digo", "promoci√≥n"], answer: "üè∑Ô∏è Suscr√≠bete a la newsletter y consigue 10% en tu primera compra." }
  };

  // Estado
  let state = { filters: {}, awaiting: null };

  // Diccionarios
  const CATEGORIES = {
    'camiseta': ['camiseta', 'camisetas', 't-shirt'],
    'sudadera': ['sudadera', 'sudaderas', 'hoodie'],
    'pantalon': ['pantal√≥n', 'pantalon', 'pantalones', 'jogger', 'jeans'],
    'camisa': ['camisa', 'camisas'],
    'blazer': ['blazer', 'americana'],
    'abrigo': ['abrigo', 'abrigos'],
    'chaqueta': ['chaqueta', 'bomber'],
    'polo': ['polo', 'polos'],
    'traje': ['traje', 'trajes']
  };

  const COLORS = {
    'negro': ['negro', 'negra'],
    'blanco': ['blanco', 'blanca'],
    'gris': ['gris'],
    'azul': ['azul', 'marino'],
    'verde': ['verde'],
    'marr√≥n': ['marr√≥n', 'marron'],
    'beige': ['beige', 'crema']
  };

  // DOM
  const toggle = document.getElementById('chatbot-toggle');
  const panel = document.getElementById('chatbot-panel');
  const closeBtn = document.getElementById('chatbot-close');
  const sendBtn = document.getElementById('chatbot-send');
  const input = document.getElementById('chatbot-input');
  const messages = document.getElementById('chatbot-messages');

  let initialized = false;

  // Funciones UI
  function openChat() {
    panel.classList.add('open');
    toggle.classList.add('active');
    input.focus();
    if (!initialized) {
      initialized = true;
      addBotMessage('¬°Hola! üëã Soy tu asistente de FashionMarket. ¬øQu√© buscas hoy?', ['Ver novedades', 'Categor√≠as', 'Ayuda']);
    }
  }

  function closeChat() {
    panel.classList.remove('open');
    toggle.classList.remove('active');
  }

  function addUserMessage(text) {
    const div = document.createElement('div');
    div.className = 'chatbot-message chatbot-message-user';
    div.innerHTML = '<div class="chatbot-bubble">' + escapeHtml(text) + '</div>';
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function addBotMessage(text, chips, products) {
    const div = document.createElement('div');
    div.className = 'chatbot-message chatbot-message-bot';
    
    let html = '<div class="chatbot-bubble">' + text + '</div>';
    
    if (products && products.length > 0) {
      html += '<div class="chatbot-products">';
      products.forEach(function(p) {
        html += '<div class="chatbot-product-card">';
        html += '<div class="chatbot-product-info">';
        html += '<span class="chatbot-product-name">' + escapeHtml(p.name) + '</span>';
        html += '<span class="chatbot-product-price">' + p.price.toFixed(2) + '‚Ç¨</span>';
        html += '</div>';
        html += '<a href="' + p.url + '" class="chatbot-product-btn">Ver ‚Üí</a>';
        html += '</div>';
      });
      html += '</div>';
    }
    
    if (chips && chips.length > 0) {
      html += '<div class="chatbot-chips">';
      chips.forEach(function(chip, index) {
        html += '<button type="button" class="chatbot-chip" data-chip="' + index + '">' + escapeHtml(chip) + '</button>';
      });
      html += '</div>';
    }
    
    div.innerHTML = html;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    
    // Agregar event listeners a los chips
    if (chips && chips.length > 0) {
      const chipBtns = div.querySelectorAll('.chatbot-chip');
      chipBtns.forEach(function(btn, index) {
        btn.addEventListener('click', function() {
          processUserInput(chips[index]);
        });
      });
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Procesar input
  function processUserInput(text) {
    const lower = text.toLowerCase().trim();
    addUserMessage(text);

    // FAQ
    for (const key in FAQ) {
      const faq = FAQ[key];
      if (faq.keywords.some(function(kw) { return lower.includes(kw); })) {
        return addBotMessage(faq.answer, ['Otra pregunta', 'Ver productos']);
      }
    }

    // Saludos
    if (['hola', 'buenas', 'hey', 'buenos d√≠as'].some(function(g) { return lower.includes(g); })) {
      return addBotMessage('¬°Hola! üòä ¬øEn qu√© puedo ayudarte?', ['Ver novedades', 'Camisetas', 'Pantalones', 'Ayuda']);
    }

    // Gracias
    if (['gracias', 'genial', 'perfecto', 'vale', 'ok'].some(function(t) { return lower.includes(t); })) {
      return addBotMessage('¬°De nada! üôå Aqu√≠ estoy si necesitas m√°s ayuda.', ['Seguir comprando']);
    }

    // Ayuda
    if (lower.includes('ayuda')) {
      return addBotMessage('Puedo ayudarte con:<br>üõí Buscar productos<br>üì¶ Informaci√≥n de env√≠os<br>üìè Gu√≠a de tallas', ['Buscar ropa', 'Env√≠os', 'Tallas']);
    }

    // Categor√≠as
    if (lower.includes('categor√≠a') || lower.includes('categoria')) {
      return addBotMessage('¬øQu√© tipo de prenda buscas?', ['Camisetas', 'Sudaderas', 'Pantalones', 'Camisas']);
    }

    // Novedades
    if (lower.includes('novedad') || lower.includes('todo') || lower.includes('cat√°logo')) {
      const popular = getPopular(3);
      return addBotMessage('‚ú® Nuestras novedades m√°s populares:', null, popular);
    }

    // Buscar productos
    const filters = extractFilters(lower);
    if (filters.category || filters.color || Object.keys(filters).length > 0 || 
        lower.includes('busco') || lower.includes('quiero') || lower.includes('necesito')) {
      return searchProducts(filters);
    }

    // No entendido
    const popular = getPopular(2);
    addBotMessage('No estoy seguro de entenderte. ¬øTe interesa algo de esto?', ['Ver categor√≠as', 'Env√≠os', 'Ayuda'], popular);
  }

  function extractFilters(text) {
    const filters = {};
    
    for (const cat in CATEGORIES) {
      if (CATEGORIES[cat].some(function(s) { return text.includes(s); })) {
        filters.category = cat;
        break;
      }
    }
    
    for (const color in COLORS) {
      if (COLORS[color].some(function(c) { return text.includes(c); })) {
        filters.color = color;
        break;
      }
    }
    
    return filters;
  }

  function searchProducts(filters) {
    let results = CATALOG.filter(function(p) { return p.inStock; });
    
    if (filters.category) {
      results = results.filter(function(p) { return p.category === filters.category; });
    }
    
    if (filters.color) {
      results = results.filter(function(p) { 
        return p.colors.some(function(c) { return c.toLowerCase().includes(filters.color); });
      });
    }
    
    results.sort(function(a, b) { return b.popularity - a.popularity; });
    
    if (results.length === 0) {
      const popular = getPopular(3);
      return addBotMessage('No encontr√© coincidencias, pero estos son muy populares:', null, popular);
    }
    
    const top = results.slice(0, 4);
    const msg = top.length === 1 ? 'üéØ ¬°Encontr√© esto!' : 'üîç Encontr√© ' + results.length + ' opciones:';
    addBotMessage(msg, null, top);
  }

  function getPopular(count) {
    return CATALOG.filter(function(p) { return p.inStock; })
      .sort(function(a, b) { return b.popularity - a.popularity; })
      .slice(0, count);
  }

  function sendMessage() {
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    processUserInput(text);
  }

  // Event listeners
  toggle.addEventListener('click', function() {
    if (panel.classList.contains('open')) closeChat();
    else openChat();
  });

  closeBtn.addEventListener('click', closeChat);
  sendBtn.addEventListener('click', sendMessage);
  
  input.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendMessage();
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && panel.classList.contains('open')) closeChat();
  });
})();
</script>

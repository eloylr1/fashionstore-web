---
/**
 * FASHIONMARKET CHATBOT - Todo en uno
 */
---

<div id="cb-widget">
  <button id="cb-fab" type="button" aria-label="Abrir chat" aria-expanded="false">
    <svg id="cb-icon-chat" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <svg id="cb-icon-close" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>

  <div id="cb-panel" style="display:none">
    <div id="cb-header">
      <div id="cb-avatar">üõçÔ∏è</div>
      <div id="cb-header-info">
        <div id="cb-title">Asistente</div>
        <div id="cb-status"><span id="cb-dot"></span> En l√≠nea</div>
      </div>
      <button id="cb-refresh" type="button" title="Reiniciar">‚Üª</button>
      <button id="cb-close-btn" type="button" title="Cerrar">‚úï</button>
    </div>
    
    <div id="cb-messages"></div>
    
    <div id="cb-footer">
      <input type="text" id="cb-input" placeholder="Escribe tu mensaje..." autocomplete="off">
      <button id="cb-send" type="button">‚û§</button>
    </div>
  </div>
</div>

<style>
  #cb-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 99999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  #cb-fab {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #c9a227 0%, #e6c453 100%);
    color: #1a1a2e;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(201, 162, 39, 0.4);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  #cb-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 30px rgba(201, 162, 39, 0.5);
  }

  #cb-panel {
    position: absolute;
    bottom: 75px;
    right: 0;
    width: 380px;
    height: 550px;
    background: #1a1a2e;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
  }

  #cb-header {
    background: #12121f;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid #2d2d4a;
  }

  #cb-avatar {
    width: 45px;
    height: 45px;
    background: #c9a227;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  #cb-header-info {
    flex: 1;
  }

  #cb-title {
    color: #fff;
    font-size: 17px;
    font-weight: 600;
  }

  #cb-status {
    color: #22c55e;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  #cb-dot {
    width: 8px;
    height: 8px;
    background: #22c55e;
    border-radius: 50%;
    display: inline-block;
  }

  #cb-refresh, #cb-close-btn {
    width: 36px;
    height: 36px;
    background: transparent;
    border: none;
    color: #8b8ba3;
    font-size: 18px;
    cursor: pointer;
    border-radius: 8px;
    transition: background 0.2s, color 0.2s;
  }

  #cb-refresh:hover, #cb-close-btn:hover {
    background: #252542;
    color: #fff;
  }

  #cb-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  #cb-messages::-webkit-scrollbar {
    width: 5px;
  }

  #cb-messages::-webkit-scrollbar-thumb {
    background: #2d2d4a;
    border-radius: 3px;
  }

  .cb-msg {
    max-width: 90%;
    animation: cbSlide 0.3s ease;
  }

  @keyframes cbSlide {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .cb-msg-user {
    align-self: flex-end;
  }

  .cb-msg-bot {
    align-self: flex-start;
  }

  .cb-bubble {
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 15px;
    line-height: 1.5;
  }

  .cb-msg-user .cb-bubble {
    background: #c9a227;
    color: #1a1a2e;
    border-bottom-right-radius: 4px;
  }

  .cb-msg-bot .cb-bubble {
    background: #252542;
    color: #fff;
    border-bottom-left-radius: 4px;
  }

  .cb-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
  }

  .cb-chip {
    background: #252542;
    color: #c9a227;
    border: 2px solid #c9a227;
    padding: 10px 16px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
    display: inline-block;
  }

  .cb-chip:hover {
    background: #c9a227;
    color: #1a1a2e;
    transform: translateY(-2px);
  }

  .cb-products {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 12px;
  }

  .cb-product {
    background: #252542;
    border-radius: 14px;
    overflow: hidden;
    text-decoration: none;
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
  }

  .cb-product:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }

  .cb-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: #c9a227;
    color: #1a1a2e;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: 700;
    z-index: 2;
  }

  .cb-product-img {
    width: 100%;
    height: 90px;
    object-fit: cover;
    background: #1a1a2e;
  }

  .cb-product-info {
    padding: 10px;
  }

  .cb-product-name {
    color: #fff;
    font-size: 12px;
    font-weight: 600;
    margin: 0 0 4px 0;
    line-height: 1.3;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .cb-product-price {
    color: #c9a227;
    font-size: 15px;
    font-weight: 700;
    margin: 0;
  }

  #cb-footer {
    padding: 15px;
    background: #12121f;
    border-top: 1px solid #2d2d4a;
    display: flex;
    gap: 10px;
  }

  #cb-input {
    flex: 1;
    background: #252542;
    border: 1px solid #2d2d4a;
    border-radius: 25px;
    padding: 12px 18px;
    color: #fff;
    font-size: 15px;
    font-family: inherit;
  }

  #cb-input:focus {
    outline: none;
    border-color: #c9a227;
  }

  #cb-input::placeholder {
    color: #8b8ba3;
  }

  #cb-send {
    width: 48px;
    height: 48px;
    background: #c9a227;
    color: #1a1a2e;
    border: none;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
  }

  #cb-send:hover {
    background: #e6c453;
    transform: scale(1.05);
  }

  @media (max-width: 480px) {
    #cb-widget { bottom: 15px; right: 15px; }
    #cb-panel { width: calc(100vw - 30px); height: 70vh; }
    #cb-fab { width: 55px; height: 55px; }
  }
</style>

<script is:inline>
(function(){
  // ==================== CAT√ÅLOGO ====================
  var CATALOG = [
    { id: 1, name: "Sudadera Oversize Premium", price: 49.99, badge: "NUEVO", img: "https://images.unsplash.com/photo-1556821840-3a63f95609a7?w=200&h=200&fit=crop", url: "/tienda", category: "sudadera", tags: ["urbano","casual"], colors: ["negro","gris"], popularity: 98 },
    { id: 2, name: "Camiseta B√°sica Algod√≥n", price: 19.99, badge: "TOP", img: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=200&h=200&fit=crop", url: "/tienda", category: "camiseta", tags: ["casual","b√°sico"], colors: ["blanco","negro"], popularity: 95 },
    { id: 3, name: "Blazer Azul Casual", price: 149.99, badge: "NUEVO", img: "https://images.unsplash.com/photo-1507679799987-c73779587ccf?w=200&h=200&fit=crop", url: "/tienda?categoria=trajes", category: "blazer", tags: ["elegante","formal"], colors: ["azul","negro"], popularity: 88 },
    { id: 4, name: "Camisa Oxford Blanca", price: 59.99, badge: "TOP", img: "https://images.unsplash.com/photo-1596755094514-f87e34085b2c?w=200&h=200&fit=crop", url: "/tienda?categoria=camisas", category: "camisa", tags: ["formal","trabajo"], colors: ["blanco"], popularity: 85 },
    { id: 5, name: "Jogger Deportivo Tech", price: 39.99, badge: "TOP", img: "https://images.unsplash.com/photo-1552902865-b72c031ac5ea?w=200&h=200&fit=crop", url: "/tienda?categoria=pantalones", category: "pantalon", tags: ["deportivo","gym"], colors: ["negro","gris"], popularity: 91 },
    { id: 6, name: "Pantal√≥n Chino Slim", price: 54.99, badge: null, img: "https://images.unsplash.com/photo-1473966968600-fa801b869a1a?w=200&h=200&fit=crop", url: "/tienda?categoria=pantalones", category: "pantalon", tags: ["casual","trabajo"], colors: ["beige","azul"], popularity: 82 },
    { id: 7, name: "Abrigo Largo Premium", price: 189.99, badge: "PREMIUM", img: "https://images.unsplash.com/photo-1539533018447-63fcce2678e3?w=200&h=200&fit=crop", url: "/tienda", category: "abrigo", tags: ["elegante","invierno"], colors: ["negro","camel"], popularity: 79 },
    { id: 8, name: "Traje Completo Modern", price: 279.99, badge: "PREMIUM", img: "https://images.unsplash.com/photo-1594938298603-c8148c4dae35?w=200&h=200&fit=crop", url: "/tienda?categoria=trajes", category: "traje", tags: ["formal","evento"], colors: ["negro","azul"], popularity: 74 },
    { id: 9, name: "Polo Piqu√© Classic", price: 34.99, badge: null, img: "https://images.unsplash.com/photo-1586363104862-3a5e2ab60d99?w=200&h=200&fit=crop", url: "/tienda", category: "polo", tags: ["casual","verano"], colors: ["blanco","azul"], popularity: 76 },
    { id: 10, name: "Sudadera Capucha Essential", price: 45.99, badge: "TOP", img: "https://images.unsplash.com/photo-1620799140408-edc6dcb6d633?w=200&h=200&fit=crop", url: "/tienda", category: "sudadera", tags: ["urbano","casual"], colors: ["gris","negro"], popularity: 93 },
    { id: 11, name: "Bomber Jacket Retro", price: 89.99, badge: "TREND", img: "https://images.unsplash.com/photo-1591047139829-d91aecb6caea?w=200&h=200&fit=crop", url: "/tienda", category: "chaqueta", tags: ["urbano","retro"], colors: ["negro","verde"], popularity: 84 },
    { id: 12, name: "Camiseta Graphic Urban", price: 29.99, badge: "NUEVO", img: "https://images.unsplash.com/photo-1503341504253-dff4815485f1?w=200&h=200&fit=crop", url: "/tienda", category: "camiseta", tags: ["urbano","streetwear"], colors: ["negro","blanco"], popularity: 89 }
  ];

  var FAQ = {
    envios: "üì¶ <strong>Env√≠os:</strong> Gratis en pedidos +100‚Ç¨. Entrega 2-4 d√≠as en Espa√±a.",
    devoluciones: "üîÑ <strong>Devoluciones:</strong> 30 d√≠as para devolver. Gratis en tienda.",
    pagos: "üí≥ <strong>Pagos:</strong> Tarjeta, PayPal, Bizum. 100% seguro.",
    tallas: "üìè <strong>Tallas:</strong> S (96-100cm), M (100-104cm), L (104-108cm), XL (108-112cm).",
    contacto: "üìû <strong>Contacto:</strong> hola@fashionmarket.com | WhatsApp: +34 612 345 678"
  };

  // ==================== DOM ====================
  var fab = document.getElementById('cb-fab');
  var panel = document.getElementById('cb-panel');
  var iconChat = document.getElementById('cb-icon-chat');
  var iconClose = document.getElementById('cb-icon-close');
  var refreshBtn = document.getElementById('cb-refresh');
  var closeBtn = document.getElementById('cb-close-btn');
  var input = document.getElementById('cb-input');
  var sendBtn = document.getElementById('cb-send');
  var messages = document.getElementById('cb-messages');

  var isOpen = false;
  var started = false;

  // ==================== FUNCIONES ====================
  function openChat() {
    isOpen = true;
    panel.style.display = 'flex';
    iconChat.style.display = 'none';
    iconClose.style.display = 'block';
    fab.setAttribute('aria-expanded', 'true');
    setTimeout(function(){ input.focus(); }, 100);
    if (!started) {
      started = true;
      showWelcome();
    }
  }

  function closeChat() {
    isOpen = false;
    panel.style.display = 'none';
    iconChat.style.display = 'block';
    iconClose.style.display = 'none';
    fab.setAttribute('aria-expanded', 'false');
  }

  function toggleChat() {
    isOpen ? closeChat() : openChat();
  }

  function resetChat() {
    messages.innerHTML = '';
    started = false;
    showWelcome();
    started = true;
  }

  function escape(t) {
    var d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
  }

  function scrollDown() {
    messages.scrollTop = messages.scrollHeight;
  }

  function addUserMsg(text) {
    var div = document.createElement('div');
    div.className = 'cb-msg cb-msg-user';
    div.innerHTML = '<div class="cb-bubble">' + escape(text) + '</div>';
    messages.appendChild(div);
    scrollDown();
  }

  function addBotMsg(text, chips, products) {
    var div = document.createElement('div');
    div.className = 'cb-msg cb-msg-bot';
    
    var html = '<div class="cb-bubble">' + text + '</div>';
    
    // Productos
    if (products && products.length > 0) {
      html += '<div class="cb-products">';
      for (var i = 0; i < products.length; i++) {
        var p = products[i];
        html += '<a href="' + p.url + '" class="cb-product">';
        if (p.badge) html += '<span class="cb-badge">' + p.badge + '</span>';
        html += '<img class="cb-product-img" src="' + p.img + '" alt="' + escape(p.name) + '" loading="lazy" onerror="this.style.display=\'none\'">';
        html += '<div class="cb-product-info">';
        html += '<p class="cb-product-name">' + escape(p.name) + '</p>';
        html += '<p class="cb-product-price">' + p.price.toFixed(0) + '‚Ç¨</p>';
        html += '</div></a>';
      }
      html += '</div>';
    }
    
    // Chips - CADA UNO ES UN BOT√ìN SEPARADO
    if (chips && chips.length > 0) {
      html += '<div class="cb-chips">';
      for (var j = 0; j < chips.length; j++) {
        html += '<button type="button" class="cb-chip" data-idx="' + j + '">' + escape(chips[j]) + '</button>';
      }
      html += '</div>';
    }
    
    div.innerHTML = html;
    messages.appendChild(div);
    
    // Click en chips
    var btns = div.querySelectorAll('.cb-chip');
    for (var k = 0; k < btns.length; k++) {
      (function(idx){
        btns[idx].onclick = function() {
          processInput(chips[idx]);
        };
      })(k);
    }
    
    scrollDown();
  }

  function showWelcome() {
    addBotMsg(
      "¬°Hola! üëã Soy tu asistente de FashionMarket. ¬øQu√© buscas hoy?",
      ["üî• Ver m√°s vendidos", "‚ú® Novedades", "üé© Buscar traje", "‚ùì Ayuda"],
      null
    );
  }

  function getPopular(n) {
    var sorted = CATALOG.slice().sort(function(a,b){ return b.popularity - a.popularity; });
    return sorted.slice(0, n || 4);
  }

  function getByCategory(cat, n) {
    var res = [];
    for (var i = 0; i < CATALOG.length && res.length < (n||4); i++) {
      if (CATALOG[i].category === cat) res.push(CATALOG[i]);
    }
    return res;
  }

  function getNew(n) {
    var res = [];
    for (var i = 0; i < CATALOG.length && res.length < (n||4); i++) {
      if (CATALOG[i].badge === "NUEVO") res.push(CATALOG[i]);
    }
    return res;
  }

  function processInput(text) {
    if (!text || !text.trim()) return;
    var t = text.trim();
    addUserMsg(t);

    setTimeout(function(){
      var lower = t.toLowerCase();
      
      // M√°s vendidos / populares
      if (lower.indexOf('vendidos') >= 0 || lower.indexOf('populares') >= 0 || lower.indexOf('top') >= 0) {
        addBotMsg("üî• ¬°Estos son nuestros m√°s vendidos!", ["‚ú® Ver novedades", "üîç Buscar por categor√≠a"], getPopular(4));
      }
      // Novedades
      else if (lower.indexOf('novedades') >= 0 || lower.indexOf('nuevo') >= 0) {
        addBotMsg("‚ú® ¬°Estas son las √∫ltimas novedades!", ["üî• Ver m√°s vendidos", "üëî Ver camisas"], getNew(4));
      }
      // Trajes
      else if (lower.indexOf('traje') >= 0 || lower.indexOf('blazer') >= 0 || lower.indexOf('formal') >= 0) {
        var trajes = getByCategory('traje', 2).concat(getByCategory('blazer', 2));
        addBotMsg("üé© Nuestra selecci√≥n de trajes y blazers:", ["üëî Ver camisas", "üî• M√°s vendidos"], trajes);
      }
      // Camisas
      else if (lower.indexOf('camisa') >= 0) {
        addBotMsg("üëî Nuestras mejores camisas:", ["üé© Ver trajes", "üî• M√°s vendidos"], getByCategory('camisa', 4));
      }
      // Pantalones
      else if (lower.indexOf('pantalon') >= 0 || lower.indexOf('pantal√≥n') >= 0 || lower.indexOf('jogger') >= 0) {
        addBotMsg("üëñ Pantalones para ti:", ["üëî Ver camisas", "üî• M√°s vendidos"], getByCategory('pantalon', 4));
      }
      // Sudaderas
      else if (lower.indexOf('sudadera') >= 0 || lower.indexOf('hoodie') >= 0) {
        addBotMsg("üß• Sudaderas c√≥modas:", ["üî• M√°s vendidos", "‚ú® Novedades"], getByCategory('sudadera', 4));
      }
      // Camisetas
      else if (lower.indexOf('camiseta') >= 0 || lower.indexOf('t-shirt') >= 0) {
        addBotMsg("üëï Camisetas para el d√≠a a d√≠a:", ["üî• M√°s vendidos", "‚ú® Novedades"], getByCategory('camiseta', 4));
      }
      // Ayuda
      else if (lower.indexOf('ayuda') >= 0 || lower.indexOf('help') >= 0) {
        addBotMsg("¬øEn qu√© puedo ayudarte? üëá", ["üì¶ Env√≠os", "üîÑ Devoluciones", "üìè Gu√≠a de tallas", "üí≥ Pagos"], null);
      }
      // Env√≠os
      else if (lower.indexOf('env√≠o') >= 0 || lower.indexOf('envio') >= 0 || lower.indexOf('entrega') >= 0) {
        addBotMsg(FAQ.envios, ["üî• Ver productos", "‚ùì M√°s ayuda"], null);
      }
      // Devoluciones
      else if (lower.indexOf('devoluc') >= 0 || lower.indexOf('cambio') >= 0) {
        addBotMsg(FAQ.devoluciones, ["üî• Ver productos", "‚ùì M√°s ayuda"], null);
      }
      // Tallas
      else if (lower.indexOf('talla') >= 0 || lower.indexOf('medida') >= 0) {
        addBotMsg(FAQ.tallas, ["üî• Ver productos", "‚ùì M√°s ayuda"], null);
      }
      // Pagos
      else if (lower.indexOf('pago') >= 0 || lower.indexOf('tarjeta') >= 0 || lower.indexOf('bizum') >= 0) {
        addBotMsg(FAQ.pagos, ["üî• Ver productos", "‚ùì M√°s ayuda"], null);
      }
      // Contacto
      else if (lower.indexOf('contacto') >= 0 || lower.indexOf('email') >= 0 || lower.indexOf('whatsapp') >= 0) {
        addBotMsg(FAQ.contacto, ["üî• Ver productos", "‚ùì M√°s ayuda"], null);
      }
      // Hola
      else if (lower.indexOf('hola') >= 0 || lower.indexOf('buenas') >= 0 || lower.indexOf('hey') >= 0) {
        addBotMsg("¬°Hola! üòä ¬øEn qu√© puedo ayudarte hoy?", ["üî• Ver m√°s vendidos", "‚ú® Novedades", "‚ùì Ayuda"], null);
      }
      // Gracias
      else if (lower.indexOf('gracias') >= 0 || lower.indexOf('genial') >= 0 || lower.indexOf('perfecto') >= 0) {
        addBotMsg("¬°De nada! üòä ¬øHay algo m√°s en lo que pueda ayudarte?", ["üî• Ver m√°s vendidos", "‚ú® Novedades"], null);
      }
      // Categor√≠a / buscar
      else if (lower.indexOf('categor√≠a') >= 0 || lower.indexOf('categoria') >= 0 || lower.indexOf('buscar') >= 0) {
        addBotMsg("¬øQu√© categor√≠a te interesa? üëá", ["üëï Camisetas", "üëî Camisas", "üß• Sudaderas", "üëñ Pantalones", "üé© Trajes"], null);
      }
      // Por defecto
      else {
        addBotMsg("No estoy seguro de entenderte. ¬øTe ayudo con algo de esto?", ["üî• Ver m√°s vendidos", "‚ú® Novedades", "‚ùì Ayuda"], getPopular(2));
      }
    }, 400);
  }

  function handleSend() {
    var t = input.value;
    input.value = '';
    processInput(t);
  }

  // ==================== EVENTS ====================
  fab.onclick = toggleChat;
  closeBtn.onclick = closeChat;
  refreshBtn.onclick = resetChat;
  sendBtn.onclick = handleSend;
  
  input.onkeydown = function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleSend();
    }
  };

  document.onkeydown = function(e) {
    if (e.key === 'Escape' && isOpen) closeChat();
  };
})();
</script>

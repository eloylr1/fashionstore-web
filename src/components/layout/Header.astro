---
/**
 * ═══════════════════════════════════════════════════════════════════════════
 * FASHIONMARKET - Header Component
 * Navegación principal de la tienda - Diseño Premium
 * ═══════════════════════════════════════════════════════════════════════════
 */

// CRITICAL: Force server-side rendering on every request
export const prerender = false;

import CartButton from '../cart/CartButton';
import LiveSearch from '../search/LiveSearch';
import { createClient } from '@supabase/supabase-js';

const navLinks = [
  { href: '/tienda', label: 'Tienda' },
  { href: '/categoria/camisas', label: 'Camisas' },
  { href: '/categoria/pantalones', label: 'Pantalones' },
  { href: '/categoria/trajes', label: 'Trajes' },
];

// Check if we're on the homepage to apply transparent header
const isHomepage = Astro.url.pathname === '/';

// Check if user is logged in (server-side) - VALIDACIÓN REAL con Supabase
const accessToken = Astro.cookies.get('sb-access-token');
let isLoggedIn = false;
let isAdmin = false;
let userName = 'Usuario';
let userInitial = 'U';

// Solo verificar si hay token
if (accessToken?.value) {
  try {
    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );
    
    // VALIDAR el token con Supabase - esto es la clave
    const { data: { user }, error } = await supabase.auth.getUser(accessToken.value);
    
    if (error || !user) {
      // Token inválido o expirado - LIMPIAR COOKIES
      console.log('Token inválido, limpiando cookies...');
      Astro.cookies.delete('sb-access-token', { path: '/' });
      Astro.cookies.delete('sb-refresh-token', { path: '/' });
      Astro.cookies.delete('user-role', { path: '/' });
      isLoggedIn = false;
    } else {
      // Token válido - usuario autenticado
      isLoggedIn = true;
      
      // Check if user is admin
      const userRole = Astro.cookies.get('user-role')?.value;
      isAdmin = userRole === 'admin';
      
      // Get user profile from database
      const { data: profile } = await supabase
        .from('profiles')
        .select('full_name')
        .eq('id', user.id)
        .single();
      
      if (profile && profile.full_name) {
        userName = profile.full_name;
        userInitial = profile.full_name.charAt(0).toUpperCase();
      } else if (user.email) {
        // Fallback to email if no name
        userName = user.email.split('@')[0];
        userInitial = userName.charAt(0).toUpperCase();
      }
    }
  } catch (error) {
    // Error de conexión - limpiar cookies por seguridad
    console.error('Error validando sesión:', error);
    Astro.cookies.delete('sb-access-token', { path: '/' });
    Astro.cookies.delete('sb-refresh-token', { path: '/' });
    Astro.cookies.delete('user-role', { path: '/' });
    isLoggedIn = false;
  }
}
---

<header 
  id="main-header"
  class:list={[
    "fixed top-0 left-0 right-0 z-50 transition-all duration-300",
    isHomepage ? "bg-transparent" : "bg-white/95 backdrop-blur-md border-b border-charcoal-100"
  ]}
  data-is-homepage={isHomepage}
>
  <!-- Top Bar -->
  <div class="hidden lg:block bg-navy-900 text-white py-2">
    <div class="container-custom flex items-center justify-between text-xs">
      <div class="flex items-center gap-6">
        <span class="flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
          </svg>
          Envío gratis en pedidos +100€
        </span>
        <span class="flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Devoluciones gratis 30 días
        </span>
      </div>
      <div class="flex items-center gap-4">
        <a href="/login" class="hover:text-gold-matte transition-colors">Mi cuenta</a>
        <span class="text-white/30">|</span>
        <a href="#" class="hover:text-gold-matte transition-colors">Ayuda</a>
      </div>
    </div>
  </div>
  
  <!-- Main Header -->
  <div class="container-custom">
    <div class="flex items-center justify-between h-16 lg:h-20">
      <!-- Logo -->
      <a href="/" class="flex items-center space-x-2 group">
        <span id="logo-text" class:list={[
          "font-serif text-xl lg:text-2xl font-semibold tracking-tight transition-colors",
          isHomepage ? "text-white" : "text-navy-900"
        ]}>
          Fashion<span class="text-gold-matte">Market</span>
        </span>
      </a>
      
      <!-- Desktop Navigation -->
      <nav class="hidden lg:flex items-center space-x-10">
        {navLinks.map((link) => (
          <a 
            href={link.href}
            class:list={[
              "nav-link text-sm font-medium tracking-wide transition-all duration-300 relative group",
              isHomepage ? "text-white/90 hover:text-white" : "text-charcoal-600 hover:text-navy-900"
            ]}
          >
            {link.label}
            <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gold-matte transition-all duration-300 group-hover:w-full"></span>
          </a>
        ))}
      </nav>
      
      <!-- Actions -->
      <div class="flex items-center space-x-3">
        <!-- Live Search (Desktop) -->
        <div class="hidden lg:block w-64">
          <LiveSearch client:load isHomepage={isHomepage} />
        </div>

        <!-- Search Button (Mobile) - Toggle search overlay -->
        <button 
          type="button"
          class:list={[
            "lg:hidden p-2.5 transition-all duration-300 hover:scale-110",
            isHomepage ? "text-white/90 hover:text-white" : "text-charcoal-600 hover:text-navy-900"
          ]}
          id="search-icon"
          aria-label="Buscar"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>
        
        <!-- User Account with Dropdown -->
        <div class="hidden lg:block relative" id="user-menu-container">
          <button 
            type="button"
            class:list={[
              "p-2.5 transition-all duration-300 hover:scale-110",
              isHomepage ? "text-white/90 hover:text-white" : "text-charcoal-600 hover:text-navy-900"
            ]}
            id="user-icon"
            aria-label="Mi cuenta"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </button>
          
          <!-- Dropdown Menu -->
          <div id="user-dropdown" class="hidden absolute right-0 top-full mt-3 w-72 bg-white rounded-xl shadow-2xl border border-charcoal-100 overflow-hidden z-50 transform transition-all duration-200">
            {!isLoggedIn ? (
              <!-- Usuario NO logueado -->
              <div id="guest-menu">
              <!-- Header con icono -->
              <div class="bg-gradient-to-br from-navy-900 to-navy-800 px-5 py-6 text-center">
                <div class="w-16 h-16 mx-auto mb-3 bg-white/10 rounded-full flex items-center justify-center">
                  <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                </div>
                <h3 class="text-white font-semibold text-lg drop-shadow-sm">¡Hola!</h3>
                <p class="text-white/90 text-sm mt-1 drop-shadow-sm">Accede a tu cuenta para ver tus pedidos y más</p>
              </div>
              <!-- Botones -->
              <div class="p-5 space-y-3">
                <button 
                  type="button"
                  id="btn-go-login"
                  class="flex items-center justify-center gap-2 w-full py-3 px-4 bg-navy-900 text-white text-center rounded-lg hover:bg-navy-800 transition-all duration-200 text-sm font-semibold shadow-sm hover:shadow-md cursor-pointer"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                  </svg>
                  Iniciar sesión
                </button>
                <button
                  type="button"
                  id="btn-go-registro"
                  class="flex items-center justify-center gap-2 w-full py-3 px-4 border-2 border-navy-900 text-navy-900 text-center rounded-lg hover:bg-navy-50 transition-all duration-200 text-sm font-semibold cursor-pointer"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                  </svg>
                  Crear cuenta
                </button>
              </div>
              <!-- Beneficios -->
              <div class="bg-cream/50 px-5 py-4 border-t border-charcoal-100">
                <p class="text-xs font-medium text-charcoal-500 uppercase tracking-wide mb-3">Ventajas de registrarte</p>
                <ul class="space-y-2">
                  <li class="flex items-center gap-2 text-sm text-charcoal-600">
                    <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    Seguimiento de pedidos en tiempo real
                  </li>
                  <li class="flex items-center gap-2 text-sm text-charcoal-600">
                    <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    Guarda tus direcciones favoritas
                  </li>
                  <li class="flex items-center gap-2 text-sm text-charcoal-600">
                    <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    Lista de deseos personalizada
                  </li>
                </ul>
              </div>
            </div>
            ) : isAdmin ? (
            <!-- Usuario Admin -->
            <div id="admin-menu">
              <!-- Header con avatar de Admin -->
              <div class="bg-gradient-to-br from-gold-matte to-gold-dark px-5 py-5">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-navy-900 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 text-gold-matte" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                  </div>
                  <div class="min-w-0">
                    <p class="text-navy-900/70 text-xs font-medium">Administrador</p>
                    <p class="font-bold text-navy-900 truncate">{userName}</p>
                  </div>
                </div>
              </div>
              <nav class="py-2">
                <a href="/admin" class="flex items-center gap-3 px-5 py-2.5 text-sm text-charcoal-700 hover:bg-gold-matte/20 hover:text-navy-900 transition-colors">
                  <div class="w-8 h-8 bg-gold-matte/30 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-navy-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                    </svg>
                  </div>
                  <span class="font-semibold">Panel de Admin</span>
                </a>
                <a href="/admin/productos" class="flex items-center gap-3 px-5 py-2.5 text-sm text-charcoal-700 hover:bg-gold-matte/20 hover:text-navy-900 transition-colors">
                  <div class="w-8 h-8 bg-charcoal-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                  </div>
                  <span class="font-medium">Gestión de Productos</span>
                </a>
              </nav>
              <div class="border-t border-charcoal-100 p-3 mx-2">
                <form action="/api/auth/logout" method="POST" id="logout-form">
                  <button type="submit" class="flex items-center justify-center gap-2 w-full px-4 py-2.5 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Cerrar sesión Admin
                  </button>
                </form>
              </div>
            </div>
            ) : (
            <!-- Usuario logueado -->
            <div id="user-menu">
              <!-- Header con avatar -->
              <div class="bg-gradient-to-br from-navy-900 to-navy-800 px-5 py-5">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-gold-matte rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-navy-900 font-bold text-lg">{userInitial}</span>
                  </div>
                  <div class="min-w-0">
                    <p class="text-white/70 text-xs">Bienvenido/a</p>
                    <p class="font-semibold text-white truncate">{userName}</p>
                  </div>
                </div>
              </div>
              <nav class="py-2">
                <a href="/cuenta" class="flex items-center gap-3 px-5 py-2.5 text-sm text-charcoal-700 hover:bg-cream hover:text-navy-900 transition-colors">
                  <div class="w-8 h-8 bg-charcoal-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                  </div>
                  <span class="font-medium">Panel de cuenta</span>
                </a>
                <a href="/cuenta/pedidos" class="flex items-center gap-3 px-5 py-2.5 text-sm text-charcoal-700 hover:bg-cream hover:text-navy-900 transition-colors">
                  <div class="w-8 h-8 bg-charcoal-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                  </div>
                  <span class="font-medium">Mis pedidos</span>
                </a>
                <a href="/cuenta/favoritos" class="flex items-center gap-3 px-5 py-2.5 text-sm text-charcoal-700 hover:bg-cream hover:text-navy-900 transition-colors">
                  <div class="w-8 h-8 bg-charcoal-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                  </div>
                  <span class="font-medium">Lista de deseos</span>
                </a>
                <a href="/cuenta/direcciones" class="flex items-center gap-3 px-5 py-2.5 text-sm text-charcoal-700 hover:bg-cream hover:text-navy-900 transition-colors">
                  <div class="w-8 h-8 bg-charcoal-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </div>
                  <span class="font-medium">Direcciones</span>
                </a>
                <a href="/cuenta/configuracion" class="flex items-center gap-3 px-5 py-2.5 text-sm text-charcoal-700 hover:bg-cream hover:text-navy-900 transition-colors">
                  <div class="w-8 h-8 bg-charcoal-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </div>
                  <span class="font-medium">Configuración</span>
                </a>
              </nav>
              <div class="border-t border-charcoal-100 p-3 mx-2">
                <form action="/api/auth/logout" method="POST" id="logout-form">
                  <button type="submit" class="flex items-center justify-center gap-2 w-full px-4 py-2.5 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Cerrar sesión
                  </button>
                </form>
              </div>
            </div>
            )}
          </div>
        </div>
        
        <!-- Cart Button (React Island) -->
        <div id="cart-wrapper" class={isHomepage ? "text-white" : "text-charcoal-600"}>
          <CartButton client:load />
        </div>
        
        <!-- Mobile Menu Button -->
        <button 
          type="button"
          class:list={[
            "lg:hidden p-2.5 transition-all duration-300",
            isHomepage ? "text-white/90 hover:text-white" : "text-charcoal-600 hover:text-navy-900"
          ]}
          aria-label="Menú"
          id="mobile-menu-button"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Mobile Navigation -->
  <div id="mobile-menu" class="hidden lg:hidden bg-white border-t border-charcoal-100">
    <nav class="container-custom py-6 space-y-1">
      <!-- Mobile Search -->
      <div class="pb-4 mb-4 border-b border-charcoal-100">
        <LiveSearch client:load isHomepage={false} />
      </div>
      
      {navLinks.map((link) => (
        <a 
          href={link.href}
          class="block py-3 text-base font-medium text-charcoal-700 hover:text-navy-900 hover:bg-cream px-4 -mx-4 transition-colors"
        >
          {link.label}
        </a>
      ))}
      <div class="pt-4 mt-4 border-t border-charcoal-100">
        <a 
          href="/login"
          class="block py-3 text-base font-medium text-charcoal-700 hover:text-navy-900 hover:bg-cream px-4 -mx-4 transition-colors"
        >
          Mi cuenta
        </a>
      </div>
    </nav>
  </div>
</header>

<!-- Spacer for fixed header -->
<div class={isHomepage ? "" : "h-16 lg:h-[calc(2rem+5rem)]"}></div>

<script>
  const initHeader = () => {
    const header = document.getElementById('main-header');
    const menuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const isHomepage = header?.dataset.isHomepage === 'true';
    
    // Mobile menu toggle
    menuButton?.addEventListener('click', () => {
      mobileMenu?.classList.toggle('hidden');
    });

    const userIcon = document.getElementById('user-icon');
    const userDropdown = document.getElementById('user-dropdown');

    // Toggle dropdown
    userIcon?.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();
      
      const cookies = document.cookie.split(';').reduce((acc, cookie) => {
        const [key, value] = cookie.trim().split('=');
        if (key) acc[key] = value;
        return acc;
      }, {} as Record<string, string>);
      
      const hasSession = cookies['sb-access-token'] && cookies['sb-access-token'] !== '';
      
      if (hasSession) {
        window.location.href = '/cuenta';
      } else {
        userDropdown?.classList.toggle('hidden');
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const container = document.getElementById('user-menu-container');
      const target = e.target as HTMLElement;
      
      if (container && !container.contains(target)) {
        userDropdown?.classList.add('hidden');
      }
    });

    // Close dropdown on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        userDropdown?.classList.add('hidden');
      }
    });

    // FORZAR navegación en los botones del dropdown
    const btnLogin = document.getElementById('btn-go-login');
    const btnRegistro = document.getElementById('btn-go-registro');
    
    if (btnLogin) {
      btnLogin.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        setTimeout(() => { window.location.assign('/login'); }, 0);
      }, true);
    }
    
    if (btnRegistro) {
      btnRegistro.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        setTimeout(() => { window.location.assign('/registro'); }, 0);
      }, true);
    }

    // Handle logout - clear localStorage
    const logoutForm = document.getElementById('logout-form');
    logoutForm?.addEventListener('submit', () => {
      localStorage.removeItem('user-name');
    });
    
    // Scroll behavior for homepage
    if (isHomepage && header) {
      const logoText = document.getElementById('logo-text');
      const navLinks = document.querySelectorAll('.nav-link');
      const searchIcon = document.getElementById('search-icon');
      const cartWrapper = document.getElementById('cart-wrapper');
      
      window.addEventListener('scroll', () => {
        const scrolled = window.scrollY > 100;
        
        if (scrolled) {
          header.classList.remove('bg-transparent');
          header.classList.add('bg-white/95', 'backdrop-blur-md', 'border-b', 'border-charcoal-100');
          logoText?.classList.remove('text-white');
          logoText?.classList.add('text-navy-900');
          navLinks.forEach(link => {
            link.classList.remove('text-white/90', 'hover:text-white');
            link.classList.add('text-charcoal-600', 'hover:text-navy-900');
          });
          searchIcon?.classList.remove('text-white/90', 'hover:text-white');
          searchIcon?.classList.add('text-charcoal-600', 'hover:text-navy-900');
          userIcon?.classList.remove('text-white/90', 'hover:text-white');
          userIcon?.classList.add('text-charcoal-600', 'hover:text-navy-900');
          cartWrapper?.classList.remove('text-white');
          cartWrapper?.classList.add('text-charcoal-600');
        } else {
          header.classList.add('bg-transparent');
          header.classList.remove('bg-white/95', 'backdrop-blur-md', 'border-b', 'border-charcoal-100');
          logoText?.classList.add('text-white');
          logoText?.classList.remove('text-navy-900');
          navLinks.forEach(link => {
            link.classList.add('text-white/90', 'hover:text-white');
            link.classList.remove('text-charcoal-600', 'hover:text-navy-900');
          });
          searchIcon?.classList.add('text-white/90', 'hover:text-white');
          searchIcon?.classList.remove('text-charcoal-600', 'hover:text-navy-900');
          userIcon?.classList.add('text-white/90', 'hover:text-white');
          userIcon?.classList.remove('text-charcoal-600', 'hover:text-navy-900');
          cartWrapper?.classList.add('text-white');
          cartWrapper?.classList.remove('text-charcoal-600');
        }
      });
    }
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeader);
  } else {
    initHeader();
  }
</script>
